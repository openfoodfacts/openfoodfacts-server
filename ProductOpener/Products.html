<html><head><title>ProductOpener::Products</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.35,
  using Pod::Simple::PullParser v3.35,
  under Perl v5.030000 at Wed Oct  6 21:28:32 2021 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Revisions'>Revisions</a>
    <li class='indexItem indexItem2'><a href='#Completeness%2C_data_quality_and_edit_history'>Completeness, data quality and edit history</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)'>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a>
    <li class='indexItem indexItem2'><a href='#assign_new_code_(_)'>assign_new_code ( )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <li class='indexItem indexItem3'><a href='#Caveats'>Caveats</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Invalid_codes'>Invalid codes</a>
        <li class='indexItem indexItem4'><a href='#Code_conflicts'>Code conflicts</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_id_for_owner_(_OWNER_ID%2C_CODE_)'>product_id_for_owner ( OWNER_ID, CODE )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Owner_id'>Owner id</a>
        <li class='indexItem indexItem4'><a href='#Code'>Code</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#server_for_product_id_(_%24product_id_)'>server_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#data_root_for_product_id_(_%24product_id_)'>data_root_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#www_root_for_product_id_(_%24product_id_)'>www_root_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_path_from_id_(_%24product_id_)'>product_path_from_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_path_(_%24product_ref_)'>product_path ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#init_product_(_%24userid%2C_%24orgid%2C_%24code%2C_%24countryid_)'>init_product ( $userid, $orgid, $code, $countryid )</a>
    <li class='indexItem indexItem2'><a href='#compute_sort_keys_(_%24product_ref_)'>compute_sort_keys ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#last_modified_t_-_date_of_last_modification_of_the_product_page'>last_modified_t - date of last modification of the product page</a>
      <li class='indexItem indexItem3'><a href='#popularity_key_-_Popular_and_recent_products'>popularity_key - Popular and recent products</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#replace_user_id_in_product_(_%24product_id%2C_%24user_id%2C_%24new_user_id_)'>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_id'>Product id</a>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#find_and_replace_user_id_in_products_(_%24user_id%2C_%24new_user_id_)'>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_user_teams_(_%24product_ref_)'>add_user_teams ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#product_data_is_protected_(_%24product_ref_)'>product_data_is_protected ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Products - create and save products</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Products</code> is used to create products and save them in Product Opener&#39;s database and file system.</p>

<pre>    use ProductOpener::Products qw/:all/;

        my $product_ref = init_product($User_id, $Org_id, $code, $countryid);

        $product_ref-&#62;{product_name_en} = &#34;Chocolate cookies&#34;;

        store_product(&#34;my-user&#34;, $product_ref, &#39;helpful comment&#39;);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Revisions"
>Revisions</a></h2>

<p>When a product is saved, a new revision of the product is created. All revisions are saved in the file system:</p>

<p>products/[barcode path]/1.sto - first revision products/[barcode path]/2.sto - 2nd revision ... products/[barcode path]/product.sto - link to latest revision</p>

<p>The latest revision is stored in the products collection of the MongoDB database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Completeness,_data_quality_and_edit_history"
>Completeness, data quality and edit history</a></h2>

<p>Before a product is saved, this module compute the completeness and quality of the data, and the edit history.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)"
>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a></h2>

<p><code>make_sure_numbers_are_stored_as_numbers()</code> forces numbers contained in the product data to be stored as numbers (and not strings) in MongoDB.</p>

<p>Perl scalars are not typed, the internal type depends on the last operator used on the variable... e.g. if it is printed with a string concatenation, then it&#39;s converted to a string.</p>

<p>See https://metacpan.org/pod/JSON%3a%3aXS#PERL---JSON</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_new_code_(_)"
>assign_new_code ( )</a></h2>

<p><code>assign_new_code()</code> assigns a new unused code to store a new product that does not have a barcode.</p>

<pre>        my ($code, $product_id) = assign_new_code();</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>A list with the new code and the corresponding product_id.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Caveats"
>Caveats</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Invalid_codes"
>Invalid codes</a></h4>

<p>This function currently assign new codes in sequence starting from 2000000000001. We increment the number by 1 for each product (which means codes are not valid as the last digit is supposed to be the check digit), and check if there is already a product for that number.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code_conflicts"
>Code conflicts</a></h4>

<p>Codes starting with 2 are reserved for internal uses, there may be conflicts as other companies can use the same codes.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_id_for_owner_(_OWNER_ID,_CODE_)"
>product_id_for_owner ( OWNER_ID, CODE )</a></h2>

<p><code>product_id_for_owner()</code> returns the product id associated with a product barcode.</p>

<p>If the products on the server are public, the product id is equal to the product code.</p>

<p>If the products on the server are private (e.g. on the platform for producers), the product_id is of the form user-[user id]/[code] or org-[organization id]/code.</p>

<p>The product id can be prefixed by a server id to indicate that is is on another server (e.g. Open Food Facts, Open Beauty Facts, Open Products Facts or Open Pet Food Facts) e.g. off:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Owner_id"
>Owner id</a></h4>

<p>In most cases, pass $Owner_id which is initialized by ProductOpener::Users::init_user()</p>

<pre>  undef for public products
  user-[user id] or org-[organization id] for private products</pre>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code"
>Code</a></h4>

<p>Product barcode.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The product id.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="server_for_product_id_(_$product_id_)"
>server_for_product_id ( $product_id )</a></h2>

<p>Returns the server for the product, if it is not on the current server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code] or [server-id]:[owner-id]/[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>undef is the product is on the current server, or server id of the server of the product otherwise.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="data_root_for_product_id_(_$product_id_)"
>data_root_for_product_id ( $product_id )</a></h2>

<p>Returns the data root for the product, possibly on another server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The data root for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="www_root_for_product_id_(_$product_id_)"
>www_root_for_product_id ( $product_id )</a></h2>

<p>Returns the www root for the product, possibly on another server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The www root for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_from_id_(_$product_id_)"
>product_path_from_id ( $product_id )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_(_$product_ref_)"
>product_path ( $product_ref )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Product object reference.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_product_(_$userid,_$orgid,_$code,_$countryid_)"
>init_product ( $userid, $orgid, $code, $countryid )</a></h2>

<p>Initialize and return a $product_ref structure for a new product.</p>

<p>If $countryid is defined and is not &#34;en:world&#34;, then assign this country for the countries field. Otherwise, use the country associated with the ip address of the user.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_sort_keys_(_$product_ref_)"
>compute_sort_keys ( $product_ref )</a></h2>

<p>Compute sort keys that are stored in the MongoDB database and used to order results of queries.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="last_modified_t_-_date_of_last_modification_of_the_product_page"
>last_modified_t - date of last modification of the product page</a></h3>

<p>Used on the web site for facets pages, except the index page.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="popularity_key_-_Popular_and_recent_products"
>popularity_key - Popular and recent products</a></h3>

<p>Used for the Personal Search project to provide generic search results that apps can personnalize later.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="replace_user_id_in_product_(_$product_id,_$user_id,_$new_user_id_)"
>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a></h2>

<p>For a specific product, replace a specific user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_id"
>Product id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_and_replace_user_id_in_products_(_$user_id,_$new_user_id_)"
>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a></h2>

<p>Find all products changed by a specific user_id, and replace the user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_user_teams_(_$product_ref_)"
>add_user_teams ( $product_ref )</a></h2>

<p>If the user who add or edits the product belongs to one or more teams, add them to the teams_tags array.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_data_is_protected_(_$product_ref_)"
>product_data_is_protected ( $product_ref )</a></h2>

<p>Checks if the product data should be protected from edits. e.g. official producer data that should not be changed by anonymous users through the API</p>

<p>Product data is protected if it has an owner and if the corresponding organization has the &#34;protect data&#34; checkbox checked.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- 1 if the data is protected - 0 if the data is not protected</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
