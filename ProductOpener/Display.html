<html><head><title>ProductOpener::Display</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.35,
  using Pod::Simple::PullParser v3.35,
  under Perl v5.030000 at Wed Sep 22 10:56:56 2021 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#VARIABLES'>VARIABLES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#%25file_timestamps'>%file_timestamps</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Synopsys'>Synopsys</a>
      <li class='indexItem indexItem3'><a href='#Configuration'>Configuration</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#url_for_text_(_%24textid_)'>url_for_text ( $textid )</a>
    <li class='indexItem indexItem2'><a href='#process_template_(_%24template_filename_%2C_%24template_data_ref_%2C_%24result_content_ref_)'>process_template ( $template_filename , $template_data_ref , $result_content_ref )</a>
    <li class='indexItem indexItem2'><a href='#init_()'>init ()</a>
    <li class='indexItem indexItem2'><a href='#display_tag_(_%24request_ref_)'>display_tag ( $request_ref )</a>
    <li class='indexItem indexItem2'><a href='#display_search_results_(_%24request_ref_)'>display_search_results ( $request_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_params_to_query_(_%24request_ref%2C_%24query_ref_)'>add_params_to_query ( $request_ref, $query_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(output)'>$request_ref (output)</a>
        <li class='indexItem indexItem4'><a href='#%24query_ref_(output)'>$query_ref (output)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#customize_response_for_product_(_%24request_ref%2C_%24product_ref_)'>customize_response_for_product ( $request_ref, $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref_(input)'>$product_ref (input)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_possible_improvement_description(_PRODUCT_REF%2C_TAGID_)'>display_possible_improvement_description( PRODUCT_REF, TAGID )</a>
    <li class='indexItem indexItem2'><a href='#display_nutriscore_calculation_details(_%24nutriscore_data_ref_)'>display_nutriscore_calculation_details( $nutriscore_data_ref )</a>
    <li class='indexItem indexItem2'><a href='#display_preferences_api_(_%24target_lc_)'>display_preferences_api ( $target_lc )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#request_object_reference_%24request_ref'>request object reference $request_ref</a>
        <li class='indexItem indexItem4'><a href='#language_code_%24target_lc'>language code $target_lc</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_attribute_groups_api_(_%24target_lc_)'>display_attribute_groups_api ( $target_lc )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#request_object_reference_%24request_ref'>request object reference $request_ref</a>
        <li class='indexItem indexItem4'><a href='#language_code_%24target_lc'>language code $target_lc</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_ingredient_analysis_(_%24ingredients_ref%2C_%24ingredients_text_ref%2C_%24ingredients_list_ref_)'>display_ingredient_analysis ( $ingredients_ref, $ingredients_text_ref, $ingredients_list_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ingredients_ref_(input)'>$ingredients_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24ingredients_text_ref_(output)'>$ingredients_text_ref (output)</a>
        <li class='indexItem indexItem4'><a href='#%24ingredients_list_ref_(output)'>$ingredients_list_ref (output)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_ingredients_analysis_details_(_%24product_ref_)'>display_ingredients_analysis_details ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#display_ingredients_analysis_(_%24product_ref_)'>display_ingredients_analysis ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#display_ecoscore_calculation_details(_%24cc%2C_%24ecoscore_data_ref_)'>display_ecoscore_calculation_details( $cc, $ecoscore_data_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#country_code_%24cc'>country code $cc</a>
        <li class='indexItem indexItem4'><a href='#ecoscore_data_%24ecoscore_data_ref'>ecoscore data $ecoscore_data_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_ecoscore_calculation_details_simple_html(_%24ecoscore_cc%2C_%24ecoscore_data_ref_)'>display_ecoscore_calculation_details_simple_html( $ecoscore_cc, $ecoscore_data_ref )</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Display - create and save products</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Display</code> generates the HTML code for the web site and the JSON responses for the API.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="VARIABLES"
>VARIABLES</a></h1>

<p>Exported variables that are available for other modules.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="%file_timestamps"
>%file_timestamps</a></h2>

<p>When the module is loaded (at the start of Apache with mod_perl),
we record the modification date of static files like CSS styles an JS code so that we can add a version parameter to the request in order to make sure the browser will not serve an old cached version.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Synopsys"
>Synopsys</a></h3>

<pre>    $scripts .= &#60;&#60;HTML
        &#60;script type=&#34;text/javascript&#34; src=&#34;/js/dist/product-multilingual.js?v=$file_timestamps{&#34;js/dist/product-multilingual.js&#34;}&#34;&#62;&#60;/script&#62;
    HTML
    ;</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Configuration"
>Configuration</a></h3>

<p>The files that need to be checked need to be specified in the code of Display.pm.</p>

<pre>        e.g.

    %file_timestamps = (
        &#34;css/dist/app.css&#34; =&#62; &#34;CSS file generated by the &#39;npm run build&#39; command&#34;,
        &#34;css/dist/product-multilingual.css&#34; =&#62; &#34;CSS file generated by the &#39;npm run build&#39; command&#34;,
        &#34;js/dist/product-multilingual.js&#34; =&#62; &#34;JS file generated by the &#39;npm run build&#39; command&#34;,
    );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="url_for_text_(_$textid_)"
>url_for_text ( $textid )</a></h2>

<p>Return the localized URL for a text. (e.g. &#34;data&#34; points to /data in English and /donnees in French)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_template_(_$template_filename_,_$template_data_ref_,_$result_content_ref_)"
>process_template ( $template_filename , $template_data_ref , $result_content_ref )</a></h2>

<p>Add some functions and variables needed by many templates and process the template with template toolkit.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_()"
>init ()</a></h2>

<p><code>init()</code> is called at the start of each new request (web page or API). It initializes a number of variables, in particular:</p>

<p>$cc : country code $lc : language code</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_tag_(_$request_ref_)"
>display_tag ( $request_ref )</a></h2>

<p>This function is called to display either:</p>

<p>1. Products that have a specific tag: /category/cakes or that don&#39;t have a specific tag /category/-cakes or that have 2 specific tags /category/cake/brand/oreo 2. List of tags of a given type: /labels possibly for products that have a specific tag: /category/cakes/labels or 2 specific tags: /category/cakes/label/organic/additives</p>

<p>When displaying products for a tag, the function generates tag type specific HTML that is displayed at the top of the page: - tag parents and children - maps for tag types that have a location (e.g. packaging codes) - special properties for some tag types (e.g. additives)</p>

<p>The function then calls search_and_display_products() to display the paginated list of products.</p>

<p>When displaying a list of tags, the function calls display_list_of_tags().</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_search_results_(_$request_ref_)"
>display_search_results ( $request_ref )</a></h2>

<p>This function builds the HTML returned by the /search endpoint.</p>

<p>The results can be displayed in different ways:</p>

<p>1. a paginated list of products (default) The function calls search_and_display_products() to display the paginated list of products.</p>

<p>2. results filtered and ranked on the client-side 2.1. according to user preferences that are locally saved on the client: &#38;user_preferences=1 2.2. according to preferences passed in the url: &#38;preferences=..</p>

<p>3. on a graph (histogram or scatter plot): &#38;graph=1 -- TODO: not supported yet</p>

<p>4. on a map &#38;map=1 -- TODO: not supported yet</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_params_to_query_(_$request_ref,_$query_ref_)"
>add_params_to_query ( $request_ref, $query_ref )</a></h2>

<p>This function is used to parse search query parameters that are passed to the API (/api/v?/search endpoint) or to the web site search (/search endpoint) either as query string parameters (e.g. ?labels_tags=en:organic) or POST parameters.</p>

<p>The function adds the corresponding query filters in the MongoDB query.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(output)"
>$request_ref (output)</a></h4>

<p>Reference to the internal request object.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$query_ref_(output)"
>$query_ref (output)</a></h4>

<p>Reference to the MongoDB query object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="customize_response_for_product_(_$request_ref,_$product_ref_)"
>customize_response_for_product ( $request_ref, $product_ref )</a></h2>

<p>Using the fields parameter, API product or search queries can request a specific set of fields to be returned.</p>

<p>This function filters the field to return only the requested fields, and computes requested fields that are not stored in the database but created on demand.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_(input)"
>$product_ref (input)</a></h4>

<p>Reference to the product object (retrieved from disk or from a MongoDB query)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Reference to the customized product object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_possible_improvement_description(_PRODUCT_REF,_TAGID_)"
>display_possible_improvement_description( PRODUCT_REF, TAGID )</a></h2>

<p>Display an explanation of the possible improvement, using the improvement data stored in $product_ref-&#62;{improvements_data}</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_nutriscore_calculation_details(_$nutriscore_data_ref_)"
>display_nutriscore_calculation_details( $nutriscore_data_ref )</a></h2>

<p>Generates HTML code with information on how the Nutri-Score was computed for a particular product.</p>

<p>For each component of the Nutri-Score (energy, sugars etc.) it shows the input value, the rounded value according to the Nutri-Score rules, and the corresponding points.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_preferences_api_(_$target_lc_)"
>display_preferences_api ( $target_lc )</a></h2>

<p>Return a JSON structure with all available preference values for attributes.</p>

<p>This is used by clients that ask for user preferences to personalize filtering and ranking based on product attributes.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="request_object_reference_$request_ref"
>request object reference $request_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="language_code_$target_lc"
>language code $target_lc</a></h4>

<p>Sets the desired language for the user facing strings.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_attribute_groups_api_(_$target_lc_)"
>display_attribute_groups_api ( $target_lc )</a></h2>

<p>Return a JSON structure with all available attribute groups and attributes, with strings (names, descriptions etc.) in a specific language, and return them in an array of attribute groups.</p>

<p>This is used in particular for clients of the API to know which preferences they can ask users for, and then use for personalized filtering and ranking.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="request_object_reference_$request_ref"
>request object reference $request_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="language_code_$target_lc"
>language code $target_lc</a></h4>

<p>Returned attributes contain both data and strings intended to be displayed to users. This parameter sets the desired language for the user facing strings.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_ingredient_analysis_(_$ingredients_ref,_$ingredients_text_ref,_$ingredients_list_ref_)"
>display_ingredient_analysis ( $ingredients_ref, $ingredients_text_ref, $ingredients_list_ref )</a></h2>

<p>Recursive function to display how the ingredients were analyzed. This function calls itself to display sub-ingredients of ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_ref_(input)"
>$ingredients_ref (input)</a></h4>

<p>Reference to the product&#39;s ingredients array or the ingredients array of an ingredient.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_text_ref_(output)"
>$ingredients_text_ref (output)</a></h4>

<p>Reference to a list of ingredients in text format that we will reconstruct from the ingredients array.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_list_ref_(output)"
>$ingredients_list_ref (output)</a></h4>

<p>Reference to a list of ingredients in ordered nested list format that corresponds to the ingredients array.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_ingredients_analysis_details_(_$product_ref_)"
>display_ingredients_analysis_details ( $product_ref )</a></h2>

<p>Generates HTML code with information on how the ingredient list was parsed and mapped to the ingredients taxonomy.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_ingredients_analysis_(_$product_ref_)"
>display_ingredients_analysis ( $product_ref )</a></h2>

<p>Generates HTML code with icons that show if the product is vegetarian, vegan and without palm oil.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_ecoscore_calculation_details(_$cc,_$ecoscore_data_ref_)"
>display_ecoscore_calculation_details( $cc, $ecoscore_data_ref )</a></h2>

<p>Generates HTML code with information on how the Eco-score was computed for a particular product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="country_code_$cc"
>country code $cc</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ecoscore_data_$ecoscore_data_ref"
>ecoscore data $ecoscore_data_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_ecoscore_calculation_details_simple_html(_$ecoscore_cc,_$ecoscore_data_ref_)"
>display_ecoscore_calculation_details_simple_html( $ecoscore_cc, $ecoscore_data_ref )</a></h2>

<p>Generates simple HTML code (to display in a mobile app) with information on how the Eco-score was computed for a particular product.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
