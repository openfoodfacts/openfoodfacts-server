name: üåê Update PO files from POT

on:
  pull_request:
    paths:
      - 'po/**/*.pot'
      - '.github/workflows/update-po-files.yml'

# Cancel in-progress runs for the same workflow on the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-po-files:
    name: Update .po files from .pot files
    runs-on: ubuntu-latest
    
    # Only run on PRs (not on push to main)
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install gettext tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext
      
      - name: Update .po files from .pot files
        run: |
          chmod +x scripts/update_po_files.sh
          ./scripts/update_po_files.sh
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet po/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in .po files"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in .po files"
            git diff --stat po/
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add po/**/*.po
          git commit -m "chore: update .po files from .pot files" -m "This commit was automatically generated by the update-po-files workflow." -m "The .po files have been updated to reflect changes in the .pot template files."
          git push
      
      - name: Add comment to PR
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üåê **Translation files updated**\n\nThe `.po` files have been automatically updated from the `.pot` template files. Please review the changes before merging.'
            })
      
      - name: Summary
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "‚úÖ No updates needed - .po files are already in sync with .pot files"
