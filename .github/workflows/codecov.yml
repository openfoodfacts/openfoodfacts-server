name: Unit Test Coverage

on: [push]
jobs:
  build_backend:
    name: Build backend dev image for tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: build
      run: make build_backend
    - name: push backend image as artifact
      uses: ishworkh/docker-image-artifact-upload@v1
      with:
        image: "openfoodfacts-server/backend:dev"
        
  coverage:
    name: unit test coverage
    needs: build_backend
    runs-on: ubuntu-latest
    steps:
       - uses: actions/checkout@master
       - name: rebuild taxonomies
         run:  |
          git ls-files taxonomies/ | xargs -I{} git log -1 --date=format:%Y%m%d%H%M.%S --format='touch -t %ad "{}"' "{}" | bash
          make build_taxonomies
       - uses: actions/checkout@master
       - name: generate coverage results
         run: make cover
       - name: generate text file with results
         if: always()
         run: make coverage_txt
       - name: use codecov
         if: always()
         run: make codecov
       - uses: codecov/codecov-action@v3
         if: always()
         with:
           files: cover_db/codecov.json