name: Pull Requests

on:
  pull_request:
    branches: [ main ]

jobs:

  # those are just until we de-activate their mandatory
  gulp:
    name: Gulp
    runs-on: ubuntu-latest
    steps:
    - name: just finish
      run: exit 0
  dev:
    name: Dev
    runs-on: ubuntu-latest
    steps:
    - name: just finish
      run: exit 0

  lint:
    name: NPM lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 1
    - uses: actions/setup-node@v3
      with:
        node-version: '12.x'
    - name: gulp build
      run: make front_build
    - name: lint
      run: make front_lint

  # this will build the docker image and upload as an artifact for following jobs
  build_backend:
    name: Build backend dev image for tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: build
      run: make build_backend
    - name: push backend image as artifact
      uses: ishworkh/docker-image-artifact-upload@v1
      with:
        image: "openfoodfacts-server/backend:dev"

  check_perl_formatting:
    name: Check perl formatting
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: install cpanminus to install perltidy
      run: sudo apt-get install -y cpanminus
    - name: install perltidy
      run: sudo cpanm Perl::Tidy
    - name: temp list of perl files
      run: |
        cat << EOF > /tmp/perlfiles
        #./cgi/auth.pl
        #./cgi/change_password.pl
        #./cgi/css.pl
        #./cgi/export_products.pl
        #./cgi/generate_sample_import_file.pl
        #./cgi/i18n/countries.pl
        #./cgi/import_file_job_status.pl
        #./cgi/import_file_process.pl
        #./cgi/import_file_select_format.pl
        #./cgi/import_file_upload.pl
        #./cgi/import_photos_upload.pl
        #./cgi/import_products_categories_from_public_database.pl
        #./cgi/ingredients.pl
        #./cgi/login.pl
        #./cgi/manifest.pl
        #./cgi/minion_job_status.pl
        #./cgi/nutrients.pl
        #./cgi/nutrition.pl
        #./cgi/opensearch.pl
        #./cgi/org.pl
        #./cgi/packaging.pl
        #./cgi/product_image.pl
        #./cgi/product_image_crop.pl
        #./cgi/product_image_move.pl
        #./cgi/product_image_rotate.pl
        #./cgi/product_image_unselect.pl
        #./cgi/product_image_upload.pl
        #./cgi/product_jqm_multilingual.pl
        #./cgi/recent_changes.pl
        #./cgi/remove_products.pl
        #./cgi/reset_password.pl
        #./cgi/reset_password_for_user.pl
        #./cgi/session.pl
        #./cgi/spellcheck_test.pl
        #./cgi/sso.pl
        #./cgi/sto2json.pl
        #./cgi/sucres_check.pl
        #./cgi/sucres_random.pl
        #./cgi/sugar_check.pl
        #./cgi/sugar_random.pl
        #./cgi/test_ingredients_analysis.pl
        #./cgi/top_translators.pl
        #./cgi/translate_taxonomy.pl
        #./cgi/user.pl
        #./cgi/version.pl
        #./cgi/display.pl
        #./cgi/suggest.pl
        #./cgi/product_multilingual.pl
        ./cgi/search.pl
        #./lib/ProductOpener/Cache.pm
        #./lib/ProductOpener/Config2_docker.pm
        #./lib/ProductOpener/Config2_sample.pm
        #./lib/ProductOpener/Config_obf.pm
        #./lib/ProductOpener/Config_opf.pm
        #./lib/ProductOpener/Config_opff.pm
        #./lib/ProductOpener/DataQuality.pm
        #./lib/ProductOpener/DataQualityCommon.pm
        #./lib/ProductOpener/DataQualityFood.pm
        #./lib/ProductOpener/Ecoscore.pm
        #./lib/ProductOpener/Export.pm
        #./lib/ProductOpener/FoodGroups.pm
        #./lib/ProductOpener/ForestFootprint.pm
        #./lib/ProductOpener/GS1.pm
        #./lib/ProductOpener/GeoIP.pm
        #./lib/ProductOpener/I18N.pm
        #./lib/ProductOpener/Import.pm
        #./lib/ProductOpener/ImportConvertCarrefourFrance.pm
        #./lib/ProductOpener/Mail.pm
        #./lib/ProductOpener/MainCountries.pm
        #./lib/ProductOpener/Missions.pm
        #./lib/ProductOpener/MissionsConfig.pm
        #./lib/ProductOpener/Numbers.pm
        #./lib/ProductOpener/Nutriscore.pm
        #./lib/ProductOpener/PackagerCodes.pm
        #./lib/ProductOpener/Packaging.pm
        #./lib/ProductOpener/Producers.pm
        #./lib/ProductOpener/ProducersFood.pm
        #./lib/ProductOpener/Recipes.pm
        #./lib/ProductOpener/Store.pm
        #./lib/ProductOpener/TagsEntries.pm
        #./lib/ProductOpener/Test.pm
        #./lib/ProductOpener/URL.pm
        #./lib/ProductOpener/Version.pm
        #./lib/ProductOpener/Data.pm
        #./lib/ProductOpener/Attributes.pm
        #./lib/ProductOpener/Web.pm
        #./lib/ProductOpener/ImportConvert.pm
        #./lib/ProductOpener/KnowledgePanels.pm
        #./lib/ProductOpener/Products.pm
        #./lib/ProductOpener/Display.pm
        #./lib/ProductOpener/Config_off.pm
        #./lib/ProductOpener/Food.pm
        #./lib/ProductOpener/Images.pm
        #./lib/ProductOpener/Index.pm
        #./lib/ProductOpener/Ingredients.pm
        #./lib/ProductOpener/Lang.pm
        #./lib/ProductOpener/Orgs.pm
        #./lib/ProductOpener/Tags.pm
        #./lib/ProductOpener/Users.pm
        #./lib/ProductOpener/Text.pm
        #./lib/startup_apache2.pl
        #./scripts/add_agribalyse_food_codes_to_taxonomy.pl
        #./scripts/add_descriptions_to_taxonomy_from_eu_translations.pl
        #./scripts/add_efsa_evaluations_to_additives_taxonomy.pl
        #./scripts/add_nutriscore_to_scanbot_csv.pl
        #./scripts/add_users_translations_to_taxonomy.pl
        #./scripts/aggregate_ingredients.pl
        #./scripts/api_stats.pl
        #./scripts/authorized_additives.pl
        #./scripts/build_countries_taxonomy_from_wikidata.pl
        #./scripts/build_lang.pl
        #./scripts/build_languages_taxonomy_from_wikidata.pl
        #./scripts/build_tags_taxonomy.pl
        #./scripts/check_additives_taxonomy.pl
        #./scripts/check_lang_pm.pl
        #./scripts/check_photos.pl
        #./scripts/check_po_file.pl
        #./scripts/checkbot.pl
        #./scripts/checkmongodb.pl
        #./scripts/codeonline-import/split_gs1_codeonline_json.pl
        #./scripts/codeonline-import/stats_gs1_codeonline_json.pl
        #./scripts/compute_missions.pl
        #./scripts/compute_missions_for_user.pl
        #./scripts/convert_carrefour_data.pl
        #./scripts/convert_csv_file.pl
        #./scripts/convert_gs1_json_to_off_csv.pl
        #./scripts/convert_gs1_xml_to_json_in_dir.pl
        #./scripts/convert_nestle_nutrition_data.pl
        #./scripts/copy_text_files.pl
        #./scripts/create_small_categories_nutriments_per_country_for_testing.pl
        #./scripts/create_wikipedia_properties_for_taxonomy.pl
        #./scripts/delete_old_cropped_images.pl
        #./scripts/delete_products_from_user.pl
        #./scripts/delete_spam_users.pl
        #./scripts/export_and_import_to_public_database.pl
        #./scripts/export_battle_food.pl
        #./scripts/export_csv_file.pl
        #./scripts/export_data.pl
        #./scripts/export_database.pl
        #./scripts/export_products_data_and_images.pl
        #./scripts/export_tags_hierarchies.pl
        #./scripts/extract_additives.pl
        #./scripts/extract_images.pl
        #./scripts/extract_individual_ingredients.pl
        #./scripts/extract_ingredients_test_set.pl
        #./scripts/extract_nutrition_images_and_crop_data.pl
        #./scripts/extract_nutrition_test_set.pl
        #./scripts/find_and_replace_user_id_in_products.pl
        #./scripts/gen_obf_inci_functions_taxonomy_from_cosing.pl
        #./scripts/gen_obf_ingredients_taxonomy_from_cosing.pl
        #./scripts/gen_opff_leaderboard.pl
        #./scripts/gen_pro_users_emails_list.pl
        #./scripts/gen_sucres.pl
        #./scripts/gen_sugar.pl
        #./scripts/gen_top_tags_per_country.pl
        #./scripts/gen_users_emails.pl
        #./scripts/gen_users_emails_list.pl
        #./scripts/gen_users_lists.pl
        #./scripts/gen_users_names.pl
        #./scripts/generate_madenearme_page.pl
        #./scripts/generate_pao_taxonomy.pl
        #./scripts/generate_perl_html_doc_from_pod.pl
        #./scripts/generate_polyquaternium.pl
        #./scripts/get_blog_updates.pl
        #./scripts/import_csv_file.pl
        #./scripts/import_fleurymichon.pl
        #./scripts/import_systemeu.pl
        #./scripts/list_ingredients.pl
        #./scripts/list_subdomains.pl
        #./scripts/list_taxonomy_entries.pl
        #./scripts/merge_additives_lists.pl
        #./scripts/minion.pl
        #./scripts/minion_export_test.pl
        #./scripts/minion_import.pl
        #./scripts/minion_import_test.pl
        #./scripts/minion_producers.pl
        #./scripts/minion_producers_test.pl
        #./scripts/obsolete/convert_auchan_data.pl
        #./scripts/obsolete/convert_barilla_data.pl
        #./scripts/obsolete/convert_casino_data.pl
        #./scripts/obsolete/convert_ferrero_data.pl
        #./scripts/obsolete/convert_foodrepo_data.pl
        #./scripts/obsolete/convert_iglo_data.pl
        #./scripts/obsolete/convert_intermarche_data.pl
        #./scripts/obsolete/convert_ldc_data.pl
        #./scripts/obsolete/convert_saintelucie_data.pl
        #./scripts/obsolete/convert_scamark_data.pl
        #./scripts/obsolete/convert_yuka_fr_data.pl
        #./scripts/obsolete/credit_product_to_creator.pl
        #./scripts/obsolete/fix_code_stored_as_number.pl
        #./scripts/obsolete/fix_countries_removed_by_yuka.pl
        #./scripts/obsolete/fix_deleted_products.pl
        #./scripts/obsolete/fix_leading_zeros.pl
        #./scripts/obsolete/fix_product.pl
        #./scripts/obsolete/fix_product2.pl
        #./scripts/obsolete/franprix.pl
        #./scripts/obsolete/import_openfood_ch.pl
        #./scripts/obsolete/import_openfood_ch_name_translations.pl
        #./scripts/obsolete/import_sodebo.pl
        #./scripts/obsolete/infobot_dk_irma.pl
        #./scripts/obsolete/moodstock_delete_all.pl
        #./scripts/obsolete/moodstock_delete_ketchup.pl
        #./scripts/obsolete/moodstock_ketchup.pl
        #./scripts/obsolete/moodstock_upload.pl
        #./scripts/obsolete/nutrinet_libelles.pl
        #./scripts/obsolete/nutrinet_libelles2.pl
        #./scripts/obsolete/po2jqueryi18n.pl
        #./scripts/obsolete/remove_deleted_products_from_db.pl
        #./scripts/obsolete/test_additifs.pl
        #./scripts/obsolete/update_all_products_all_fields.pl
        #./scripts/obsolete/update_all_products_bot.pl
        #./scripts/obsolete/update_all_products_categories.pl
        #./scripts/obsolete/update_all_products_codes.pl
        #./scripts/obsolete/update_all_products_countries.pl
        #./scripts/obsolete/update_all_products_countries_add.pl
        #./scripts/obsolete/update_all_products_countries_fix.pl
        #./scripts/obsolete/update_all_products_creator.pl
        #./scripts/obsolete/update_all_products_emb_codes.pl
        #./scripts/obsolete/update_all_products_energy.pl
        #./scripts/obsolete/update_all_products_from_dir_in_mongodb.pl
        #./scripts/obsolete/update_all_products_from_dir_remove_dotted_fields.pl
        #./scripts/obsolete/update_all_products_history.pl
        #./scripts/obsolete/update_all_products_history_from_dir.pl
        #./scripts/obsolete/update_all_products_history_fromdir.pl
        #./scripts/obsolete/update_all_products_in_mongodb.pl
        #./scripts/obsolete/update_all_products_ingredients.pl
        #./scripts/obsolete/update_all_products_ingredients_classes.pl
        #./scripts/obsolete/update_all_products_labels.pl
        #./scripts/obsolete/update_all_products_lang_lc.pl
        #./scripts/obsolete/update_all_products_language_fields.pl
        #./scripts/obsolete/update_all_products_languages.pl
        #./scripts/obsolete/update_all_products_nutriments_fields.pl
        #./scripts/obsolete/update_all_products_nutriments_typo.pl
        #./scripts/obsolete/update_all_products_nutrition_score.pl
        #./scripts/obsolete/update_all_products_packager_codes.pl
        #./scripts/obsolete/update_all_products_periods_from_expiration_date.pl
        #./scripts/obsolete/update_all_products_sortkey.pl
        #./scripts/obsolete/update_all_products_unknown_nutriments.pl
        #./scripts/obsolete/update_all_products_upc_to_ean.pl
        #./scripts/obsolete/update_all_products_zero_scans.pl
        #./scripts/obsolete/update_users.pl
        #./scripts/obsolete/upload_photos.pl
        #./scripts/obsolete/upload_photos_2016_franprix.pl
        #./scripts/obsolete/upload_photos_2018_liege.pl
        #./scripts/obsolete/import_us_ndb.pl
        #./scripts/packager-codes/de-packagers-refresh.pl
        #./scripts/packager-codes/ee-packagers-xml2tsv.pl
        #./scripts/packager-codes/es-packagers-html2csv.pl
        #./scripts/packager-codes/fi-packagers-xls2csv.pl
        #./scripts/packager-codes/fr-packagers-refresh.pl
        #./scripts/packager-codes/se-packagers-html2tsv.pl
        #./scripts/popular_products_images.pl
        #./scripts/print_all_translations.pl
        #./scripts/remove_all_private_products_for_owner.pl
        #./scripts/remove_empty_products.pl
        #./scripts/remove_products_without_code.pl
        #./scripts/run_cloud_vision_ocr.pl
        #./scripts/scanbot.pl
        #./scripts/sort_languages_in_taxonomy.pl
        #./scripts/sto_to_json.pl
        #./scripts/sto_to_xml.pl
        #./scripts/tag_stores_magasins_u.pl
        #./scripts/test_extract_ingredients_from_text.pl
        #./scripts/test_geoip.pl
        #./scripts/test_ingredient_parser.pl
        #./scripts/test_normalize_packaging_codes.pl
        #./scripts/test_spellchecker.pl
        #./scripts/test_taxonomies.pl
        #./scripts/test_text_fuzzy.pl
        #./scripts/translate_taxonomy_with_eu_translations.pl
        #./scripts/update_all_products.pl
        #./scripts/update_all_products_from_dir_in_mongodb.pl
        #./scripts/update_all_products_revisions_from_dir_in_mongodb.pl
        #./scripts/update_emb_codes_in_mongodb.pl
        #./scripts/update_packager_codes.pl
        #./scripts/update_packager_codes_fsa_ratings.pl
        #./scripts/update_recent_changes.pl
        #./scripts/update_top_translators.pl
        #./t/additives.t
        #./t/additives_tags.t
        #./t/allergens.t
        #./t/allergens_tags.t
        #./t/attributes.t
        #./t/dataquality.t
        #./t/dataqualityfood.t
        #./t/export.t
        #./t/food_groups.t
        #./t/forest_footprint.t
        #./t/i18n.t
        #./t/images.t
        #./t/import.t
        #./t/import_convert_carrefour_france.t
        #./t/import_csv_file.t
        #./t/import_gs1.t
        #./t/ingredients_clean.t
        #./t/ingredients_nesting.t
        #./t/ingredients_nutriscore.t
        #./t/ingredients_parsing.t
        #./t/ingredients_parsing_todo.t
        #./t/ingredients_percent.t
        #./t/ingredients_processing.t
        #./t/ingredients_tags.t
        #./t/lang.t
        #./t/load_csv_or_excel_file.t
        #./t/nova.t
        #./t/numbers.t
        #./t/packager_codes.t
        #./t/packaging.t
        #./t/producers.t
        #./t/recipes.t
        #./t/store.t
        #./t/templates.t
        #./t/text.t
        #./t/vitamins.t
        #./t/ecoscore.t
        #./t/nutriscore.t
        #./t/products.t
        #./t/ingredients.t
        #./t/food.t
        #./t/food_normalize_serving_size.t
        #./t/ingredients_analysis.t
        #./t/tags.t
        #./t/display.t
        EOF
    - name: test perl formatting # replace with below when all uncommented
      run: |
        for i in $(grep -v '^#' /tmp/perlfiles)
        do
          perltidy ${i} 
          git diff --no-index ${i} ${i}.tdy
        done
#    - name: reformat all perl files
#      run: find . -type f \( -name "*.t" -o -name "*.pl" -o -name "*.pm" \) -exec perltidy -pro=.perltidyrc {} \;
#    - name: test perl formatting
#      run: |
#        for i in $(find . -type f \( -name "*.t" -o -name "*.pl" -o -name "*.pm" \))
#        do
#          git diff --no-index ${i} ${i}.tdy
#        done

  check_perl:
    name: Check perl
    needs: build_backend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: Download backend image from artifacts
      uses: ishworkh/docker-image-artifact-download@v1
      with:
        image: "openfoodfacts-server/backend:dev"
    - name: check perl
      run: make check_perl

  tests:
    name: Perl unit tests
    needs: build_backend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: Download backend image from artifacts
      uses: ishworkh/docker-image-artifact-download@v1
      with:
        image: "openfoodfacts-server/backend:dev"
    - name: rebuild taxonomies
      # here we first restore dates from git for taxonomies to avoid build them all
      # see https://stackoverflow.com/a/60984318/2886726
      run: |
        git ls-files taxonomies/ | xargs -I{} git log -1 --date=format:%Y%m%d%H%M.%S --format='touch -t %ad "{}"' "{}" | bash
        make build_taxonomies
    - name: test
      run: make tests

  tests_dev:
    name: Test make dev
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 50
    - name: Test make dev
      run: |
        make dev
        make status
    - name: test all is runing
      run: make livecheck
    - name: test clean
      run: make hdown
