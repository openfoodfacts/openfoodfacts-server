<html><head><title>ProductOpener::API</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Sep 22 07:42:53 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#read_request_body_(%24request_ref)'>read_request_body ($request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#decode_json_request_body_(%24request_ref)'>decode_json_request_body ($request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#determine_request_result_(%24response_ref)'>determine_request_result ($response_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24response_ref_(input)'>$response_ref (input)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_localized_messages_to_api_response_(%24target_lc%2C_%24response_ref)'>add_localized_messages_to_api_response ($target_lc, $response_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24target_lc'>$target_lc</a>
        <li class='indexItem indexItem4'><a href='#%24response_ref_(input_and_output)'>$response_ref (input and output)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#send_api_response_(%24request_ref)'>send_api_response ($request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_api_request_(%24request_ref)'>process_api_request ($request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_requested_code(%24requested_code%2C_%24response_ref)'>normalize_requested_code($requested_code, $response_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_code_(input)'>$request_code (input)</a>
        <li class='indexItem indexItem4'><a href='#%24response_ref_(output)'>$response_ref (output)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_images_to_update(%24product_ref%2C_%24target_lc)'>get_images_to_update($product_ref, $target_lc)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref_(input)'>$product_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24target_lc_(input)'>$target_lc (input)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#customize_packagings_(%24request_ref%2C_%24product_ref)'>customize_packagings ($request_ref, $product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref_(input)'>$product_ref (input)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#customize_response_for_product_(_%24request_ref%2C_%24product_ref%2C_%24fields_)'>customize_response_for_product ( $request_ref, $product_ref, $fields )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref_(input)'>$request_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref_(input)'>$product_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24fields_(input)'>$fields (input)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::API - implementation of READ and WRITE APIs</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module contains functions that are common to multiple types of API requests.</p>

<p>Specialized functions to process each type of API request is in separate modules like:</p>

<p>APIProductRead.pm : product READ APIProductWrite.pm : product WRITE</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="read_request_body_($request_ref)"
>read_request_body ($request_ref)</a></h2>

<p>API V3 POST / PUT / PATCH requests do not use CGI Multipart Form data,
and instead pass a JSON structure in the body.
This function reads the request body and saves it in $request_ref-&#62;{body}</p>

<p>It must be called before any call to CGI.pm param() which will read the body.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="decode_json_request_body_($request_ref)"
>decode_json_request_body ($request_ref)</a></h2>

<p>Decodes the JSON body of a request and store it in $request_ref-&#62;{request_body_json}</p>

<p>Errors are returned in $request_ref-&#62;{api_response}</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="determine_request_result_($response_ref)"
>determine_request_result ($response_ref)</a></h2>

<p>Based on the response&#39;s errors and warnings,
determine the overall status of the request.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$response_ref_(input)"
>$response_ref (input)</a></h4>

<p>Reference to the response object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_localized_messages_to_api_response_($target_lc,_$response_ref)"
>add_localized_messages_to_api_response ($target_lc,
$response_ref)</a></h2>

<p>Functions that process API calls may add message ids in $request_ref-&#62;{api_response} to indicate the result and warnings and errors.</p>

<p>This functions adds English and/or localized messages for those messages.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$target_lc"
>$target_lc</a></h4>

<p>API messages (result,
warning and errors messages and impacts) are generated: - in English in the &#34;name&#34; field: those messages are intended for use by developers,
monitoring systems etc.
- in the language of the user in the &#34;lc_name&#34; field: those messages may be displayed directly to users (e.g.
to explain that some field values are incorrect and were ignored)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$response_ref_(input_and_output)"
>$response_ref (input and output)</a></h4>

<p>Reference to the response object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="send_api_response_($request_ref)"
>send_api_response ($request_ref)</a></h2>

<p>Send the API response with the right headers and status code.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Reference to the customized product object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_api_request_($request_ref)"
>process_api_request ($request_ref)</a></h2>

<p>Process API v3 requests.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_requested_code($requested_code,_$response_ref)"
>normalize_requested_code($requested_code,
$response_ref)</a></h2>

<p>Normalize the product barcode requested by a READ or WRITE API request.
Return a warning if the normalized code is different from the requested code.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_code_(input)"
>$request_code (input)</a></h4>

<p>Reference to the request object.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$response_ref_(output)"
>$response_ref (output)</a></h4>

<p>Reference to the response object.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Normalized code and,
if available,
GS1 AI data string.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_images_to_update($product_ref,_$target_lc)"
>get_images_to_update($product_ref,
$target_lc)</a></h2>

<p>Return a list of images that are too old,
or that are missing.
This is used to ask users to update images.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_(input)"
>$product_ref (input)</a></h4>

<p>Reference to the product object</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$target_lc_(input)"
>$target_lc (input)</a></h4>

<p>Target language code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Reference to a hash of images that need to be updated.
The keys are the image ids (e.g.
front_fr),
and the value is the age in seconds of the image (or 0 if we don&#39;t have an image yet)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="customize_packagings_($request_ref,_$product_ref)"
>customize_packagings ($request_ref,
$product_ref)</a></h2>

<p>Packaging components are stored in a compact form: only taxonomy ids for shape,
material and recycling.</p>

<p>This function returns a richer structure with local names for the taxonomy entries.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_(input)"
>$product_ref (input)</a></h4>

<p>Reference to the product object (retrieved from disk or from a MongoDB query)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Reference to the customized product object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="customize_response_for_product_(_$request_ref,_$product_ref,_$fields_)"
>customize_response_for_product ( $request_ref,
$product_ref,
$fields )</a></h2>

<p>Using the fields parameter,
API product or search queries can request a specific set of fields to be returned.</p>

<p>This function filters the field to return only the requested fields,
and computes requested fields that are not stored in the database but created on demand.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref_(input)"
>$request_ref (input)</a></h4>

<p>Reference to the request object.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_(input)"
>$product_ref (input)</a></h4>

<p>Reference to the product object (retrieved from disk or from a MongoDB query)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$fields_(input)"
>$fields (input)</a></h4>

<p>Comma separated list of fields,
default to none.</p>

<p>Special values: - none: no fields are returned - all: all fields are returned,
and special fields (e.g.
attributes,
knowledge panels) are not computed - updated: fields that were updated by a WRITE request</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Reference to the customized product object.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
