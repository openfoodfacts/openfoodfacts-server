<html><head><title>ProductOpener::Export</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Fri Aug 22 14:10:34 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#export_csv(_FILEHANDLE%2C_QUERY%5B%2C_OPTIONS_%5D_)'>export_csv( FILEHANDLE, QUERY[, OPTIONS ] )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#filehandle_-_required_-_File_handle_where_the_CSV_data_will_be_output'>filehandle - required - File handle where the CSV data will be output</a>
        <li class='indexItem indexItem4'><a href='#query_-_optional_-_MongoDB_Query'>query - optional - MongoDB Query</a>
        <li class='indexItem indexItem4'><a href='#extra_fields_-_optional_-_Extra_fields_to_export'>extra_fields - optional - Extra fields to export</a>
        <li class='indexItem indexItem4'><a href='#fields_-_optional_-_Restrict_the_fields_to_export'>fields - optional - Restrict the fields to export</a>
        <li class='indexItem indexItem4'><a href='#include_images_paths_-_optional_-_Export_local_file_paths_to_images'>include_images_paths - optional - Export local file paths to images</a>
        <li class='indexItem indexItem4'><a href='#include_obsolete_products_-_optional_-_Also_export_obsolete_products'>include_obsolete_products - optional - Also export obsolete products</a>
        <li class='indexItem indexItem4'><a href='#mongo_timeout_ms_-_optional_-_specific_mongoDB_timeout'>mongo_timeout_ms - optional - specific mongoDB timeout</a>
        <li class='indexItem indexItem4'><a href='#Return_value'>Return value</a>
      </ul>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Export - export products data in CSV format</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Export</code> is used to export the data of all populated fields of products matching a given MongoDB search query in Open Food Facts CSV format (UTF-8 encoding,
tab separated).</p>

<pre>    use ProductOpener::Export qw/:all/;
        export_csv( { filehandle=&#62;*STDOUT,
                query=&#62;{ countries_tags=&#62;&#34;en:france&#34;, labels_tags=&#62;&#34;en:organic&#34; } });</pre>

<p>Only columns that are not completely empty will be included in the resulting CSV file. This is to avoid generating CSV files with thousands of empty columns (e.g. all possible nutrients and all the language specific fields like ingredients_text_[language code] for all the hundreds of possible languages.</p>

<p>Fields that are computed from other fields are not directly provided by users or producers are not exported by default. They can be exported by passing a list of extra fields:</p>

<pre>        export_csv( { filehandle=&#62;$fh,
                extra_fields=&#62;[qw(nova_group nutrition_grade_fr)] });</pre>

<p>It is also possible to restrict the set of fields to be exported:</p>

<pre>        export_csv( { filehandle=&#62;$fh,
                fields=&#62;[qw(code ingredients_text_en additives_tags)] });</pre>

<p>This module is used in particular to export product data provided by manufacturers on the producers platform so that it can then be imported in the public database.</p>

<p>In the producers platform, the <code>export_csv</code> function is executed through a Minion worker.</p>

<p>It is also used in the <code>scripts/export_csv_file.pl</code> script.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Use the list of fields from <code>Product::Opener::Config::options{import_export_fields_groups}</code> and the list of nutrients from <code>Product::Opener::Food::nutriments_tables</code> to list fields that need to be exported.</p>

<p>The results of the query are scanned a first time to compute the list of non-empty columns.</p>

<p>The results of the query are scanned a second time to output the CSV file.</p>

<p>This 2 phases approach is done to avoid having to store all the products data in memory.</p>

<p>If the fields to exports are specified with the <code>fields</code> parameter, the first phase is skipped.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="export_csv(_FILEHANDLE,_QUERY[,_OPTIONS_]_)"
>export_csv( FILEHANDLE, QUERY[, OPTIONS ] )</a></h2>

<p><code>export_csv()</code> outputs data in CSV format for products matching a query.</p>

<p>Only non empty columns are included. By default, fields that are computed from other fields are not included, but extra fields can be exported using the third OPTIONS argument.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Arguments are passed through a single hash reference with the following keys:</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="filehandle_-_required_-_File_handle_where_the_CSV_data_will_be_output"
>filehandle - required - File handle where the CSV data will be output</a></h4>

<p>The file handle can be to a file on disk, to STDOUT etc.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="query_-_optional_-_MongoDB_Query"
>query - optional - MongoDB Query</a></h4>

<p>Hash ref that specifies the query that will be passed to MongoDB. Each key value pair will be used to filter products with matching field values.</p>

<pre>   export_csv( { filehandle=&#62;$fh,
        query =&#62; { categories_tags =&#62; &#34;en:beers&#34;, ingredients_tags =&#62; &#34;en:wheat&#34; }});</pre>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="extra_fields_-_optional_-_Extra_fields_to_export"
>extra_fields - optional - Extra fields to export</a></h4>

<p>Array ref that specifies a list of additional fields to export, including fields that are computed from other fields such as the NOVA group or the Nutri-Score nutritional grade.</p>

<p>Columns for the extra fields will be added after the columns for the populated fields from user and producers.</p>

<pre>        export_csv({ filehandle=&#62;$fh,
                extra_fields =&#62; [qw(nova_group nutrition_grade_fr)] });</pre>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="fields_-_optional_-_Restrict_the_fields_to_export"
>fields - optional - Restrict the fields to export</a></h4>

<p>Array ref that specifies the exact list of fields to export. Only the specified fields will be exported.</p>

<pre>        export_csv({ filehandle=&#62;$fh,
                fields =&#62; [qw(code ingredients_text_en additives_tags)] });</pre>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="include_images_paths_-_optional_-_Export_local_file_paths_to_images"
>include_images_paths - optional - Export local file paths to images</a></h4>

<p>If defined and not null, specifies to export local file paths for selected images for front, ingredients and nutrition in all languages.</p>

<p>This option is used in particular for exporting from the producers platform and importing to the public database.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="include_obsolete_products_-_optional_-_Also_export_obsolete_products"
>include_obsolete_products - optional - Also export obsolete products</a></h4>

<p>Obsolete products are in the products_obsolete collection.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="mongo_timeout_ms_-_optional_-_specific_mongoDB_timeout"
>mongo_timeout_ms - optional - specific mongoDB timeout</a></h4>

<p>Use it if you need to export big collections. This should only be used from scripts (not for the web, as it would monopolize Apache workers and make server unresponsive)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h4>

<p>Count of the exported documents.</p>

<p>Note: if the max_count parameter is passed</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
