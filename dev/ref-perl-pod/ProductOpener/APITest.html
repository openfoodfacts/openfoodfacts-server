<html><head><title>ProductOpener::APITest</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Nov 10 13:56:28 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#wait_dynamic_front()'>wait_dynamic_front()</a>
    <li class='indexItem indexItem2'><a href='#wait_server()'>wait_server()</a>
    <li class='indexItem indexItem2'><a href='#wait_application_ready()'>wait_application_ready()</a>
    <li class='indexItem indexItem2'><a href='#new_client()'>new_client()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#return_value'>return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#create_user(%24ua%2C_%24args_ref)'>create_user($ua, $args_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ua_-_user_agent'>$ua - user agent</a>
        <li class='indexItem indexItem4'><a href='#%24args_ref_-_fields'>$args_ref - fields</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#edit_user(%24ua%2C_%24args_ref)'>edit_user($ua, $args_ref)</a>
    <li class='indexItem indexItem2'><a href='#login(%24ua%2C_%24user_id%2C_%24password)'>login($ua, $user_id, $password)</a>
    <li class='indexItem indexItem2'><a href='#get_page_(%24ua%2C_%24url)'>get_page ($ua, $url)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ua_-_user_agent'>$ua - user agent</a>
        <li class='indexItem indexItem4'><a href='#%24url_-_absolute_url'>$url - absolute url</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#post_form_(%24ua%2C_%24url%2C_%24fields_ref)'>post_form ($ua, $url, $fields_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ua_-_user_agent'>$ua - user agent</a>
        <li class='indexItem indexItem4'><a href='#%24url_-_absolute_url'>$url - absolute url</a>
        <li class='indexItem indexItem4'><a href='#%24fields_ref'>$fields_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#edit_product(%24ua%2C_%24product_fields_ref)'>edit_product($ua, $product_fields_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ua_-_user_agent'>$ua - user agent</a>
        <li class='indexItem indexItem4'><a href='#%24product_fields_ref'>$product_fields_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#html_displays_error(%24page)'>html_displays_error($page)</a>
    <li class='indexItem indexItem2'><a href='#construct_test_url()'>construct_test_url()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Value'>Return Value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#origin_from_url(%24url)'>origin_from_url($url)</a>
    <li class='indexItem indexItem2'><a href='#execute_api_tests(%24file%2C_%24tests_ref%2C_%24ua%3Dundef)'>execute_api_tests($file, $tests_ref, $ua=undef)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24file_test_file_name'>$file test file name</a>
        <li class='indexItem indexItem4'><a href='#%24tests_ref_reference_to_list_of_tests'>$tests_ref reference to list of tests</a>
        <li class='indexItem indexItem4'><a href='#%24ua_a_web_client_(LWP%3A%3AUserAgent)_to_use'>$ua a web client (LWP::UserAgent) to use</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#tail_log_start(%24log_path)'>tail_log_start($log_path)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#String_%24log_path'>String $log_path</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#tail_log_read(%24tail)'>tail_log_read($tail)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24tail'>$tail</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#mails_from_log(%24text)_Retrieve_mails_in_a_log_extract'>mails_from_log($text) Retrieve mails in a log extract</a>
    <li class='indexItem indexItem2'><a href='#mail_to_text(%24text)_Make_mail_more_easy_to_search_by_removing_some_specific_formatting'>mail_to_text($text) Make mail more easy to search by removing some specific formatting</a>
    <ul   class='indexList indexList3'>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24mail_text_of_mail'>$mail text of mail</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns_Reformatted_text'>Returns Reformatted text</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_mail_for_comparison(%24mail)'>normalize_mail_for_comparison($mail)</a>
    <ul   class='indexList indexList3'>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24mail_text_of_mail'>$mail text of mail</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns_ref_to_an_array_of_lines_of_the_email'>Returns ref to an array of lines of the email</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#fake_http_server(%24port%2C_%24dump_path%2C_%24responses_ref)_%7B'>fake_http_server($port, $dump_path, $responses_ref) {</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#parameters'>parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24dump_path_-_path'>$dump_path - path</a>
        <li class='indexItem indexItem4'><a href='#%24responses_ref_-_ref_to_a_list'>$responses_ref - ref to a list</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#returns_ref_to_fake_server'>returns ref to fake server</a>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24task_name_The_name_of_the_task'>$task_name The name of the task</a>
        <li class='indexItem indexItem4'><a href='#%24created_after_ts_The_timestamp_of_the_creation_of_the_task'>$created_after_ts The timestamp of the creation of the task</a>
        <li class='indexItem indexItem4'><a href='#%24max_waiting_time_The_max_waiting_time_for_this_given_task'>$max_waiting_time The max waiting time for this given task</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns_Returns_a_list_of_jobs_information_associated_with_the_task_name'>Returns Returns a list of jobs information associated with the task_name</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::APITest - utility functions to interact with API</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="wait_dynamic_front()"
>wait_dynamic_front()</a></h2>

<p>Wait for dynamic_front to be ready.
It&#39;s important because the application might fail because of that</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="wait_server()"
>wait_server()</a></h2>

<p>Wait for server to be ready.
It&#39;s important because the application might fail because of that</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="wait_application_ready()"
>wait_application_ready()</a></h2>

<p>Wait for server and dynamic front to be ready.
Run this at the beginning of every integration test</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new_client()"
>new_client()</a></h2>

<p>Reset user agent</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="return_value"
>return value</a></h3>

<p>Return a user agent</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_user($ua,_$args_ref)"
>create_user($ua,
$args_ref)</a></h2>

<p>Call API to create a user</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ua_-_user_agent"
>$ua - user agent</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$args_ref_-_fields"
>$args_ref - fields</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="edit_user($ua,_$args_ref)"
>edit_user($ua,
$args_ref)</a></h2>

<p>Call API to edit a user,
see create_user</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="login($ua,_$user_id,_$password)"
>login($ua,
$user_id,
$password)</a></h2>

<p>Login as a user</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_page_($ua,_$url)"
>get_page ($ua,
$url)</a></h2>

<p>Get a page of the app</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ua_-_user_agent"
>$ua - user agent</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$url_-_absolute_url"
>$url - absolute url</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="post_form_($ua,_$url,_$fields_ref)"
>post_form ($ua,
$url,
$fields_ref)</a></h2>

<p>Post a form</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ua_-_user_agent"
>$ua - user agent</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$url_-_absolute_url"
>$url - absolute url</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$fields_ref"
>$fields_ref</a></h4>

<p>Reference of a hash of fields to pass as the form result</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="edit_product($ua,_$product_fields_ref)"
>edit_product($ua,
$product_fields_ref)</a></h2>

<p>Call the API to edit a product.
If the product does not exist,
it will be created.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ua_-_user_agent"
>$ua - user agent</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_fields_ref"
>$product_fields_ref</a></h4>

<p>Reference of a hash of product fields to pass to the API</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="html_displays_error($page)"
>html_displays_error($page)</a></h2>

<p>Return if a form displays errors</p>

<p>Most forms will return a 200 while displaying an error message.
This function assumes error_list.tt.html was used.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="construct_test_url()"
>construct_test_url()</a></h2>

<p>Constructs the URL to send the HTTP request to for the API.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Takes in two string arguments,
One being the the target and other a prefix.
The prefix could be simply the country code (eg: US for America or &#34;World&#34;) OR something like ( {country-code}-{language-code} )</p>

<p>An example below $target = &#34;/product/35242200055&#34; $prefix= &#34;world-fr&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Value"
>Return Value</a></h3>

<p>Returns the constructed URL for the query</p>

<p>For the example cited above this returns: &#34;http://world-fr.openfoodfacts.localhost/product/35242200055&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="origin_from_url($url)"
>origin_from_url($url)</a></h2>

<p>Compute &#34;Origin&#34; header for $url</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="execute_api_tests($file,_$tests_ref,_$ua=undef)"
>execute_api_tests($file,
$tests_ref,
$ua=undef)</a></h2>

<p>Initialize tests and execute them.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$file_test_file_name"
>$file test file name</a></h4>

<p>The *.t test files call execute_api_tests() with _FILE_ as the first parameter,
and the directories for the tests are derived from it.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$tests_ref_reference_to_list_of_tests"
>$tests_ref reference to list of tests</a></h4>

<p>The tests are in a structure like this:</p>

<p>my $tests_ref = ( [ { # request description test_case =&#62; &#39;no-body&#39;,
# a description of the test,
should be unique to easily retrieve which test failed method =&#62; &#39;POST&#39;,
# defaults to GET subdomain =&#62; &#39;world&#39;,
# defaults to &#34;world&#34; path =&#62; &#39;/api/v3/product/12345678&#39;,
query_string =&#62; &#39;?some_param=some_value&#38;some_other_param=some_other_value&#39; # optional form =&#62; { field_name =&#62; field_value,
..
},
# optional,
will not be sent if there is a body headers_in =&#62; {header1 =&#62; value1},
# optional,
headers to add to request body =&#62; &#39;{&#34;some_json_field&#34;: &#34;some_value&#34;}&#39;,
# optional,
will be fetched in file in needed ua =&#62; a LWP::UserAgent object,
if a specific user is needed (e.g.
with moderator status)</p>

<pre>                        # expected return
                        headers =&#62; {header1 =&#62; value1, }  # optional. You may add an undef value to test for the inexistance of a header
                        response_content_must_match =&#62; &#34;regexp&#34; # optional. You may add a case insensitive regexp (e.g. &#34;Product saved&#34;) that must be matched
                        response_content_must_not_match =&#62; &#34;regexp&#34;     # optional. You may add a case insensitive regexp (e.g. &#34;error&#34;) that must not be matched
                }
    ],
);</pre>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ua_a_web_client_(LWP::UserAgent)_to_use"
>$ua a web client (LWP::UserAgent) to use</a></h4>

<p>If undef we open a new client.</p>

<p>You might need this to test with an authenticated user.</p>

<p>Note: this setting can be overriden for each test case by specifying a &#34;ua&#34; field.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="tail_log_start($log_path)"
>tail_log_start($log_path)</a></h2>

<p>Start monitoring a log file</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="String_$log_path"
>String $log_path</a></h4>

<p>Defaults to /var/log/apache2/log4perl.log</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>An object to pass to tail_log_read to read</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="tail_log_read($tail)"
>tail_log_read($tail)</a></h2>

<p>Return all content written to a log file since last check</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$tail"
>$tail</a></h4>

<p>Object returned by tail_log_start</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>Content as a string</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="mails_from_log($text)_Retrieve_mails_in_a_log_extract"
>mails_from_log($text) Retrieve mails in a log extract</a></h2>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="mail_to_text($text)_Make_mail_more_easy_to_search_by_removing_some_specific_formatting"
>mail_to_text($text) Make mail more easy to search by removing some specific formatting</a></h2>

<p>Especially we replace &#34;3D=&#34; for &#34;=&#34; and join line and their continuation =head3 Arguments</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$mail_text_of_mail"
>$mail text of mail</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns_Reformatted_text"
>Returns Reformatted text</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_mail_for_comparison($mail)"
>normalize_mail_for_comparison($mail)</a></h2>

<p>Replace parts of mail that varies from tests to tests, and also in a format that&#39;s nice in json. =head3 Arguments</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$mail_text_of_mail"
>$mail text of mail</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns_ref_to_an_array_of_lines_of_the_email"
>Returns ref to an array of lines of the email</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="fake_http_server($port,_$dump_path,_$responses_ref)_{"
>fake_http_server($port, $dump_path, $responses_ref) {</a></h2>

<p>Launch a fake HTTP server.</p>

<p>We use that to simulate Robotoff or any HTTP API in integration tests. As it will be launched on the local backend container, we have to pretend those service URL is on <code>backend:$port</code>.</p>

<p>You can provide a list of responses to simulate real service responses, while requests sent are store for later checks by the tests.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="parameters"
>parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$dump_path_-_path"
>$dump_path - path</a></h4>

<p>A temporary directory to dump requests</p>

<p>You can retrieve requests, in this directory as <code>req-n.sto</code></p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$responses_ref_-_ref_to_a_list"
>$responses_ref - ref to a list</a></h4>

<p>List of responses to send, in right order, for each received request.</p>

<p>If the number of request exceed this list, we will send simple 200 HTTP responses with a json payload.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="returns_ref_to_fake_server"
>returns ref to fake server</a></h3>

<p>Hold the reference until you don&#39;t need the server</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>get_minion_jobs($task_name, $created_after_ts, $max_waiting_time) Subprogram which wait till the minion finished its job or if it takes too much time</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$task_name_The_name_of_the_task"
>$task_name The name of the task</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$created_after_ts_The_timestamp_of_the_creation_of_the_task"
>$created_after_ts The timestamp of the creation of the task</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$max_waiting_time_The_max_waiting_time_for_this_given_task"
>$max_waiting_time The max waiting time for this given task</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns_Returns_a_list_of_jobs_information_associated_with_the_task_name"
>Returns Returns a list of jobs information associated with the task_name</a></h3>

<p>Note: for each job we return the job information (as returned by the jobs() iterator), not the Minion job object.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
