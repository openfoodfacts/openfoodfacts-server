<html><head><title>ProductOpener::Ingredients</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Tue Oct 21 12:49:43 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#init_allergens_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing'>init_allergens_regexps () - initialize regular expressions needed for ingredients parsing</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#init_percent_or_quantity_regexps(%24ingredients_lc)_-_initialize_regular_expressions_needed_for_ingredients_parsing'>init_percent_or_quantity_regexps($ingredients_lc) - initialize regular expressions needed for ingredients parsing</a>
    <li class='indexItem indexItem2'><a href='#init_labels_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing'>init_labels_regexps () - initialize regular expressions needed for ingredients parsing</a>
    <li class='indexItem indexItem2'><a href='#has_specific_ingredient_property_(_product_ref%2C_searched_ingredient_id%2C_property_)'>has_specific_ingredient_property ( product_ref, searched_ingredient_id, property )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#searched_ingredient_id'>searched_ingredient_id</a>
        <li class='indexItem indexItem4'><a href='#property'>property</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#value'>value</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_properties_from_specific_ingredients_(_product_ref_)'>add_properties_from_specific_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_percent_max_for_ingredients_from_nutrition_facts_(_%24product_ref_)'>add_percent_max_for_ingredients_from_nutrition_facts ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_specific_ingredients_from_labels_(_product_ref_)'>add_specific_ingredients_from_labels ( product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_specific_ingredients_from_text_(_product_ref%2C_%24text%2C_%24percent_or_quantity_regexp%2C_%24per_100g_regexp_)'>parse_specific_ingredients_from_text ( product_ref, $text, $percent_or_quantity_regexp, $per_100g_regexp )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#text_%24text'>text $text</a>
        <li class='indexItem indexItem4'><a href='#percent_regular_expression_%24percent_or_quantity_regexp'>percent regular expression $percent_or_quantity_regexp</a>
        <li class='indexItem indexItem4'><a href='#per_100g_regular_expression_%24per_100g_regexp'>per_100g regular expression $per_100g_regexp</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_processing_from_ingredient_(_%24ingredients_lc%2C_%24ingredient_)'>parse_processing_from_ingredient ( $ingredients_lc, $ingredient )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#ingredients_lc'>ingredients_lc</a>
        <li class='indexItem indexItem4'><a href='#ingredient'>ingredient</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#processings_ref'>processings_ref</a>
        <li class='indexItem indexItem4'><a href='#ingredient'>ingredient</a>
        <li class='indexItem indexItem4'><a href='#ingredient_id'>ingredient_id</a>
        <li class='indexItem indexItem4'><a href='#ingredient_recognized'>ingredient_recognized</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_origins_from_text_(_product_ref%2C_%24text%2C_%24ingredients_lc)'>parse_origins_from_text ( product_ref, $text, $ingredients_lc)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_ref'>product_ref</a>
        <li class='indexItem indexItem4'><a href='#text_%24text'>text $text</a>
        <li class='indexItem indexItem4'><a href='#%24ingredients_lc_%3A_language_for_the_origins_text'>$ingredients_lc : language for the origins text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#specific_ingredients_structure'>specific_ingredients structure</a>
        <li class='indexItem indexItem4'><a href='#_'></a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#select_ingredients_lc_(%24product_ref)'>select_ingredients_lc ($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#ingredients_lc'>ingredients_lc</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_or_select_ingredients_lc_(%24product_ref)'>get_or_select_ingredients_lc ($product_ref)</a>
    <li class='indexItem indexItem2'><a href='#get_percent_or_quantity_and_normalized_quantity(%24percent_or_quantity_value%2C_%24percent_or_quantity_unit)'>get_percent_or_quantity_and_normalized_quantity($percent_or_quantity_value, $percent_or_quantity_unit)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#percent_or_quantity_value'>percent_or_quantity_value</a>
        <li class='indexItem indexItem4'><a href='#percent_or_quantity_unit'>percent_or_quantity_unit</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#percent'>percent</a>
        <li class='indexItem indexItem4'><a href='#quantity'>quantity</a>
        <li class='indexItem indexItem4'><a href='#quantity_g'>quantity_g</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Example'>Example</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#parse_ingredients_text_service_(_%24product_ref%2C_%24updated_product_fields_ref%2C_%24errors_ref_)'>parse_ingredients_text_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24updated_product_fields_ref'>$updated_product_fields_ref</a>
        <li class='indexItem indexItem4'><a href='#%24errors_ref'>$errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#analyze_ingredient_function(%24analyze_ingredients_self%2C_%24ingredients_ref%2C_%24parent_ref%2C_%24level%2C_%24s)'>analyze_ingredient_function($analyze_ingredients_self, $ingredients_ref, $parent_ref, $level, $s)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24analyze_ingredients_self'>$analyze_ingredients_self</a>
        <li class='indexItem indexItem4'><a href='#%24ingredients_ref'>$ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#%24parent_ref'>$parent_ref</a>
        <li class='indexItem indexItem4'><a href='#%24level'>$level</a>
        <li class='indexItem indexItem4'><a href='#%24s'>$s</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#extend_ingredients_service_(_%24product_ref%2C_%24updated_product_fields_ref%2C_%24errors_ref_)'>extend_ingredients_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24updated_product_fields_ref'>$updated_product_fields_ref</a>
        <li class='indexItem indexItem4'><a href='#%24errors_ref'>$errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#flatten_sub_ingredients_(_product_ref_)'>flatten_sub_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_tags_(_product_ref_)'>compute_ingredients_tags ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#extract_ingredients_from_text_(_product_ref_)'>extract_ingredients_from_text ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#get_missing_ciqual_codes_(%24ingredients_ref)'>get_missing_ciqual_codes ($ingredients_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ingredients_ref'>$ingredients_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%40ingredients_without_ciqual_codes'>@ingredients_without_ciqual_codes</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_missing_ecobalyse_ids_(%24ingredients_ref)'>get_missing_ecobalyse_ids ($ingredients_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ingredients_ref'>$ingredients_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%40ingredients_without_ecobalyse_ids'>@ingredients_without_ecobalyse_ids</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_geographical_area_(%24originid)'>get_geographical_area ($originid)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24originid'>$originid</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ecobalyse_area'>$ecobalyse_area</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#estimate_ingredients_percent_service_(_%24product_ref%2C_%24updated_product_fields_ref%2C_%24errors_ref_)'>estimate_ingredients_percent_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24updated_product_fields_ref'>$updated_product_fields_ref</a>
        <li class='indexItem indexItem4'><a href='#%24errors_ref'>$errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#count_ingredients_with_specified_percent(%24product_ref)'>count_ingredients_with_specified_percent($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ingredients_n'>$ingredients_n</a>
        <li class='indexItem indexItem4'><a href='#%24ingredients_with_specified_percent_n'>$ingredients_with_specified_percent_n</a>
        <li class='indexItem indexItem4'><a href='#%24total_specified_percent'>$total_specified_percent</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#delete_ingredients_percent_values_(_ingredients_ref_)'>delete_ingredients_percent_values ( ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_percent_min_max_values_(_total_min%2C_total_max%2C_ingredients_ref_)'>compute_ingredients_percent_min_max_values ( total_min, total_max, ingredients_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#total_min_-_the_minimum_percent_value_of_the_total_of_all_the_ingredients_in_ingredients_ref'>total_min - the minimum percent value of the total of all the ingredients in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#total_max_-_the_maximum_percent_value_of_all_ingredients_passed_in_ingredients_ref'>total_max - the maximum percent value of all ingredients passed in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#ingredient_ref_%3A_nested_array_of_ingredients_and_sub-ingredients'>ingredient_ref : nested array of ingredients and sub-ingredients</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Negative_value_-_analysis_error'>Negative value - analysis error</a>
        <li class='indexItem indexItem4'><a href='#0_or_positive_value_-_analysis_ok'>0 or positive value - analysis ok</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#init_percent_values(%24total_min%2C_%24total_max%2C_%24ingredients_ref)'>init_percent_values($total_min, $total_max, $ingredients_ref)</a>
    <li class='indexItem indexItem2'><a href='#set_percent_max_from_taxonomy_(_ingredients_ref_)'>set_percent_max_from_taxonomy ( ingredients_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_ingredients_percent_estimates_(_total%2C_ingredients_ref_)'>compute_ingredients_percent_estimates ( total, ingredients_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#total_-_the_total_of_all_the_ingredients_in_ingredients_ref'>total - the total of all the ingredients in ingredients_ref</a>
        <li class='indexItem indexItem4'><a href='#ingredient_ref_%3A_nested_array_of_ingredients_and_sub-ingredients'>ingredient_ref : nested array of ingredients and sub-ingredients</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#analyze_ingredients_service_(_%24product_ref%2C_%24updated_product_fields_ref%2C_%24errors_ref_)'>analyze_ingredients_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24updated_product_fields_ref'>$updated_product_fields_ref</a>
        <li class='indexItem indexItem4'><a href='#%24errors_ref'>$errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_a_of_b_(_%24lc%2C_%24a%2C_%24b%2C_%24of_bool%2C_%24alternate_names_ref_%3D_undef_)'>normalize_a_of_b ( $lc, $a, $b, $of_bool, $alternate_names_ref = undef )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#lc'>lc</a>
        <li class='indexItem indexItem4'><a href='#%24a'>$a</a>
        <li class='indexItem indexItem4'><a href='#%24b'>$b</a>
        <li class='indexItem indexItem4'><a href='#%24of_bool_-_indicate_if_we_want_to_construct_entries_like_%22%3Ccategory%3E_of_%3Ctype%3E%22'>$of_bool - indicate if we want to construct entries like &#34;&#60;category&#62; of &#60;type&#62;&#34;</a>
        <li class='indexItem indexItem4'><a href='#%24alternate_names_ref'>$alternate_names_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#combined_%24a_and_%24b_(or_%24b_and_%24a%2C_depending_of_the_language)%2C_that_is_expected_to_be_an_ingredient'>combined $a and $b (or $b and $a, depending of the language), that is expected to be an ingredient</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#lc'>lc</a>
        <li class='indexItem indexItem4'><a href='#category'>category</a>
        <li class='indexItem indexItem4'><a href='#types'>types</a>
        <li class='indexItem indexItem4'><a href='#%24of_bool_-_indicate_if_we_want_to_construct_entries_like_%22%3Ccategory%3E_of_%3Ctype%3E%22'>$of_bool - indicate if we want to construct entries like &#34;&#60;category&#62; of &#60;type&#62;&#34;</a>
        <li class='indexItem indexItem4'><a href='#%24alternate_names_ref'>$alternate_names_ref</a>
        <li class='indexItem indexItem4'><a href='#%24do_not_output_parent_-_indicate_if_we_want_to_output_the_parent_ingredient'>$do_not_output_parent - indicate if we want to output the parent ingredient</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Transformed_ingredients_list_text'>Transformed ingredients list text</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#split_generic_name_from_ingredients_(_product_ref_language_code_)'>split_generic_name_from_ingredients ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#clean_ingredients_text_for_lang_(_product_ref_language_code_)'>clean_ingredients_text_for_lang ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#cut_ingredients_text_for_lang_(_product_ref_language_code_)'>cut_ingredients_text_for_lang ( product_ref language_code )</a>
    <li class='indexItem indexItem2'><a href='#replace_additive_(%24number%2C_%24letter%2C_%24variant)_-_normalize_the_additive'>replace_additive ($number, $letter, $variant) - normalize the additive</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Synopsis'>Synopsis</a>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Language'>Language</a>
        <li class='indexItem indexItem4'><a href='#Ingredients_list_text'>Ingredients list text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Transformed_ingredients_list_text'>Transformed ingredients list text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#%25ingredients_categories_and_types'>%ingredients_categories_and_types</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#preparse_ingredients_text_(%24ingredients_lc%2C_%24text)_-_normalize_the_ingredient_list_to_make_parsing_easier'>preparse_ingredients_text ($ingredients_lc, $text) - normalize the ingredient list to make parsing easier</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Language'>Language</a>
        <li class='indexItem indexItem4'><a href='#Ingredients_list_text'>Ingredients list text</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Transformed_ingredients_list_text'>Transformed ingredients list text</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#extract_additives_from_text_(%24product_ref)_-_extract_additives_from_the_ingredients_text'>extract_additives_from_text ($product_ref) - extract additives from the ingredients text</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference'>Product reference</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#count_sweeteners_and_non_nutritive_sweeteners'>count_sweeteners_and_non_nutritive_sweeteners</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#ingredients_sweeteners_n'>ingredients_sweeteners_n</a>
        <li class='indexItem indexItem4'><a href='#ingredients_non_nutritive_sweeteners_n'>ingredients_non_nutritive_sweeteners_n</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#detect_allergens_from_ingredients_(_%24product_ref_)'>detect_allergens_from_ingredients ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#get_allergens_taxonomyid_(_%24ingredients_lc%2C_%24ingredient_or_allergen_)'>get_allergens_taxonomyid ( $ingredients_lc, $ingredient_or_allergen )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ingredients_lc'>$ingredients_lc</a>
        <li class='indexItem indexItem4'><a href='#%24ingredient_or_allergen'>$ingredient_or_allergen</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#detect_allergens_from_text_(_%24product_ref_)'>detect_allergens_from_text ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#add_ingredients_matching_function_(_%24ingredients_ref%2C_%24match_function_ref_)'>add_ingredients_matching_function ( $ingredients_ref, $match_function_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24percent'>$percent</a>
        <li class='indexItem indexItem4'><a href='#%24water_percent'>$water_percent</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#estimate_ingredients_matching_function_(_%24product_ref%2C_%24match_function_ref%2C_%24nutrient_id_%3D_undef_)'>estimate_ingredients_matching_function ( $product_ref, $match_function_ref, $nutrient_id = undef )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24match_function_ref'>$match_function_ref</a>
        <li class='indexItem indexItem4'><a href='#%24nutrient_id_(optional)'>$nutrient_id (optional)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#is_fruits_vegetables_nuts_olive_walnut_rapeseed_oils_(_%24ingredient_id%2C_%24processing_%3D_undef_)'>is_fruits_vegetables_nuts_olive_walnut_rapeseed_oils ( $ingredient_id, $processing = undef )</a>
    <li class='indexItem indexItem2'><a href='#estimate_nutriscore_2021_fruits_vegetables_nuts_percent_from_ingredients_(_product_ref_)'>estimate_nutriscore_2021_fruits_vegetables_nuts_percent_from_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#is_fruits_vegetables_legumes_(_%24ingredient_id%2C_%24processing_%3D_undef)'>is_fruits_vegetables_legumes ( $ingredient_id, $processing = undef)</a>
    <li class='indexItem indexItem2'><a href='#estimate_nutriscore_2023_fruits_vegetables_legumes_percent_from_ingredients_(_product_ref_)'>estimate_nutriscore_2023_fruits_vegetables_legumes_percent_from_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#is_milk_(_%24ingredient_id%2C_%24processing_%3D_undef_)'>is_milk ( $ingredient_id, $processing = undef )</a>
    <li class='indexItem indexItem2'><a href='#estimate_nutriscore_2021_milk_percent_from_ingredients_(_product_ref_)'>estimate_nutriscore_2021_milk_percent_from_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#is_red_meat_(_%24ingredient_id_)'>is_red_meat ( $ingredient_id )</a>
    <li class='indexItem indexItem2'><a href='#estimate_nutriscore_2023_red_meat_percent_from_ingredients_(_product_ref_)'>estimate_nutriscore_2023_red_meat_percent_from_ingredients ( product_ref )</a>
    <li class='indexItem indexItem2'><a href='#sub_get_ingredients_with_property_value_(%24ingredients_ref%2C_%24property%2C_%24value)'>sub get_ingredients_with_property_value ($ingredients_ref, $property, $value)</a>
    <li class='indexItem indexItem2'><a href='#estimate_added_sugars_percent_from_ingredients_(%24product_ref)'>estimate_added_sugars_percent_from_ingredients ($product_ref)</a>
    <li class='indexItem indexItem2'><a href='#sub_get_ingredients_with_parent_(%24ingredients_ref%2C_%24property%2C_%24value)'>sub get_ingredients_with_parent ($ingredients_ref, $property, $value)</a>
    <li class='indexItem indexItem2'><a href='#detect_rare_crops_(_%24product_ref_)'>detect_rare_crops ( $product_ref )</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Ingredients - process and analyze ingredients lists</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Ingredients</code> processes,
normalize,
parses and analyze ingredients lists to extract and recognize individual ingredients,
additives and allergens,
and to compute product properties related to ingredients (is the product vegetarian,
vegan,
does it contain palm oil etc.)</p>

<pre>    use ProductOpener::Ingredients qw/:all/;

        [..]

        clean_ingredients_text($product_ref);

        extract_ingredients_from_text($product_ref);

        extract_additives_from_text($product_ref);

        detect_allergens_from_text($product_ref);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>[..]</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_allergens_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing"
>init_allergens_regexps () - initialize regular expressions needed for ingredients parsing</a></h2>

<p>This function initializes regular expressions needed to parse traces and allergens in ingredients lists.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_percent_or_quantity_regexps($ingredients_lc)_-_initialize_regular_expressions_needed_for_ingredients_parsing"
>init_percent_or_quantity_regexps($ingredients_lc) - initialize regular expressions needed for ingredients parsing</a></h2>

<p>This function creates regular expressions that match quantities or percent of an ingredient, including localized strings like &#34;minimum&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_labels_regexps_()_-_initialize_regular_expressions_needed_for_ingredients_parsing"
>init_labels_regexps () - initialize regular expressions needed for ingredients parsing</a></h2>

<p>This function creates regular expressions that match all variations of labels that we want to recognize in ingredients lists, such as organic and fair trade.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="has_specific_ingredient_property_(_product_ref,_searched_ingredient_id,_property_)"
>has_specific_ingredient_property ( product_ref, searched_ingredient_id, property )</a></h2>

<p>Check if the specific ingredients structure (extracted from the end of the ingredients list and product labels) contains a property for an ingredient. (e.g. do we have an origin specified for a specific ingredient)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="searched_ingredient_id"
>searched_ingredient_id</a></h4>

<p>If the ingredient_id parameter is undef, then we return the value for any specific ingredient. (useful for products for which we do not have ingredients, but for which we have a label like &#34;French eggs&#34;: we can still derive the origin of the ingredients, e.g. for the Environmental-Score)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="property"
>property</a></h4>

<p>e.g. &#34;origins&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="value"
>value</a></h4>

<p>- undef if we don&#39;t have a specific ingredient with the requested property matching the requested ingredient - otherwise the value for the matching specific ingredient</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_properties_from_specific_ingredients_(_product_ref_)"
>add_properties_from_specific_ingredients ( product_ref )</a></h2>

<p>Go through the ingredients structure, and add properties to ingredients that match specific ingredients for which we have extra information (e.g. origins from a label).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_percent_max_for_ingredients_from_nutrition_facts_(_$product_ref_)"
>add_percent_max_for_ingredients_from_nutrition_facts ( $product_ref )</a></h2>

<p>Add a percent_max value for salt and sugar ingredients, based on the nutrition facts.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_specific_ingredients_from_labels_(_product_ref_)"
>add_specific_ingredients_from_labels ( product_ref )</a></h2>

<p>Check if the product has labels that indicate properties (e.g. origins) for specific ingredients.</p>

<p>e.g.</p>

<p>en:French pork fr:Viande Porcine Fran&#231;aise, VPF, viande de porc fran&#231;aise, Le Porc Fran&#231;ais, Porc Origine France, porc fran&#231;ais, porc 100% France origins:en: en:france ingredients:en: en:pork</p>

<p>This function extracts those mentions and adds them to the specific_ingredients structure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_specific_ingredients_from_text_(_product_ref,_$text,_$percent_or_quantity_regexp,_$per_100g_regexp_)"
>parse_specific_ingredients_from_text ( product_ref, $text, $percent_or_quantity_regexp, $per_100g_regexp )</a></h2>

<p>Lists of ingredients sometime include extra mentions for specific ingredients at the end of the ingredients list. e.g. &#34;Prepared with 50g of fruits for 100g of finished product&#34;.</p>

<p>This function extracts those mentions and adds them to the specific_ingredients structure.</p>

<p>This function is also used to parse the origins of ingredients field.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="text_$text"
>text $text</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="percent_regular_expression_$percent_or_quantity_regexp"
>percent regular expression $percent_or_quantity_regexp</a></h4>

<p>Used to find % values, language specific.</p>

<p>Pass undef in order to skip % recognition. This is useful if we know the text is only for the origins of ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="per_100g_regular_expression_$per_100g_regexp"
>per_100g regular expression $per_100g_regexp</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_processing_from_ingredient_(_$ingredients_lc,_$ingredient_)"
>parse_processing_from_ingredient ( $ingredients_lc, $ingredient )</a></h2>

<p>This function extract processing method from one ingredient. If processing methods are found and remaining ingredient text exists without the processing method, then, it returns: - $processing (concatenate if more than one), - $ingredient (without processing) and - $ingredient_id (without processing) If it does not result in known ingredient, then it returns the same but unchanged.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredients_lc"
>ingredients_lc</a></h4>

<p>language abbreviation (en for English, for example)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient"
>ingredient</a></h4>

<p>string (&#34;pear&#34;, for example)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="processings_ref"
>processings_ref</a></h4>

<p>reference to an array of processings</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient"
>ingredient</a></h4>

<p>updated ingredient without processing methods</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_id"
>ingredient_id</a></h4>

<p>English first element for that ingredient (en:pear, for example)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_recognized"
>ingredient_recognized</a></h4>

<p>0 or 1</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_origins_from_text_(_product_ref,_$text,_$ingredients_lc)"
>parse_origins_from_text ( product_ref, $text, $ingredients_lc)</a></h2>

<p>This function parses the origins of ingredients field to extract the origins of specific ingredients. The origins are stored in the specific_ingredients structure of the product.</p>

<p>Note: this function is similar to parse_specific_ingredients_from_text() that operates on ingredients lists. The difference is that parse_specific_ingredients_from_text() only extracts and recognizes text that is an extra mention at the end of an ingredient list (e.g. &#34;Origin of strawberries: Spain&#34;), while parse_origins_from_text() will also recognize text like &#34;Strawberries: Spain&#34;.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_ref"
>product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="text_$text"
>text $text</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_lc_:_language_for_the_origins_text"
>$ingredients_lc : language for the origins text</a></h4>

<p>In most cases it is the same as $product_ref-&#62;{ingredients_lc}, except if there are no ingredients listed, in which case we can have origins listed in the main language of the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="specific_ingredients_structure"
>specific_ingredients structure</a></h4>

<p>Array of specific ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="_"
></a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="select_ingredients_lc_($product_ref)"
>select_ingredients_lc ($product_ref)</a></h2>

<p>Select, set and return the `ingredients_lc` field in $product_ref.</p>

<p>This is the language that will be used to parse ingredients. We first check that ingredients_text_{lang} exists and is non-empty for the product main language (`lc`), and return it if it does. Otherwise we look at all languages defined in `languages_codes` for a non-empty `ingredients_text_lang`.</p>

<p>If we find a language with non empty ingredients in ingredients_text_{lang}: - we copy the value to the `ingredients_text` field in the product - we set the `ingredients_lc` field in the product and return it, otherwise we unset it.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredients_lc"
>ingredients_lc</a></h4>

<p>Language code for ingredients parsing.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_or_select_ingredients_lc_($product_ref)"
>get_or_select_ingredients_lc ($product_ref)</a></h2>

<p>Return the ingredients_lc field if already set, otherwise call select_ingredients_lc() to select it.</p>

<p>This function is used in ingredients related services, to ensure that the ingredients_lc field is set.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_percent_or_quantity_and_normalized_quantity($percent_or_quantity_value,_$percent_or_quantity_unit)"
>get_percent_or_quantity_and_normalized_quantity($percent_or_quantity_value, $percent_or_quantity_unit)</a></h2>

<p>Used to assign percent or quantity for strings parsed with $percent_or_quantity_regexp.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="percent_or_quantity_value"
>percent_or_quantity_value</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="percent_or_quantity_unit"
>percent_or_quantity_unit</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>If the percent_or_quantity_unit is %, we return a defined value for percent, otherwise we return quantity and quantity_g</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="percent"
>percent</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="quantity"
>quantity</a></h4>

<p>If the unit is not %, quantity is a concatenation of the quantity value and unit</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="quantity_g"
>quantity_g</a></h4>

<p>Normalized quantity in grams.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Example"
>Example</a></h3>

<p>$ingredient = &#34;100% cocoa&#34;; # or &#34;milk 10cl&#34;</p>

<p>if ($ingredient =~ /\s$percent_or_quantity_regexp$/i) { $percent_or_quantity_value = $1; $percent_or_quantity_unit = $2;</p>

<pre>        my ($percent, $quantity, $quantity_g)
                = get_percent_or_quantity_and_normalized_quantity($percent_or_quantity_value, $percent_or_quantity_unit);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_ingredients_text_service_(_$product_ref,_$updated_product_fields_ref,_$errors_ref_)"
>parse_ingredients_text_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a></h2>

<p>Parse the ingredients_text field to extract individual ingredients.</p>

<p>This function is a product service that can be run through ProductOpener::ApiProductServices</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>product object reference</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$updated_product_fields_ref"
>$updated_product_fields_ref</a></h4>

<p>reference to a hash of product fields that have been created or updated</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$errors_ref"
>$errors_ref</a></h4>

<p>reference to an array of error messages</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="analyze_ingredient_function($analyze_ingredients_self,_$ingredients_ref,_$parent_ref,_$level,_$s)"
>analyze_ingredient_function($analyze_ingredients_self, $ingredients_ref, $parent_ref, $level, $s)</a></h2>

<p>This function is used to analyze the ingredients text and extract individual ingredients. It identifies one ingredient at a time, and calls itself recursively to identify other ingredients and sub ingredients</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$analyze_ingredients_self"
>$analyze_ingredients_self</a></h4>

<p>Reference to itself in order to call itself recursively</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_ref"
>$ingredients_ref</a></h4>

<p>Reference to an array of ingredients that will be filled with the extracted ingredients</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$parent_ref"
>$parent_ref</a></h4>

<p>Reference to the parent ingredient (if any)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$level"
>$level</a></h4>

<p>Level of depth of sub ingredients</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$s"
>$s</a></h4>

<p>Text to analyze</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extend_ingredients_service_(_$product_ref,_$updated_product_fields_ref,_$errors_ref_)"
>extend_ingredients_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a></h2>

<p>After the nested ingredients structure has been built with the parse_ingredients_text_service, this service adds some properties to the ingredients:</p>

<p>- Origins, labels etc. that have been extracted from other fields - Ciqual and Ecobalyse codes</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>product object reference</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$updated_product_fields_ref"
>$updated_product_fields_ref</a></h4>

<p>reference to a hash of product fields that have been created or updated</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$errors_ref"
>$errors_ref</a></h4>

<p>reference to an array of error messages</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="flatten_sub_ingredients_(_product_ref_)"
>flatten_sub_ingredients ( product_ref )</a></h2>

<p>Flatten the nested list of ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_tags_(_product_ref_)"
>compute_ingredients_tags ( product_ref )</a></h2>

<p>Go through the nested ingredients and:</p>

<p>Compute ingredients_original_tags and ingredients_tags.</p>

<p>Compute the total % of &#34;leaf&#34; ingredients (without sub-ingredients) with a specified %, and unspecified %.</p>

<p>- ingredients_with_specified_percent_n : number of &#34;leaf&#34; ingredients with a specified % - ingredients_with_specified_percent_sum : % sum of &#34;leaf&#34; ingredients with a specified % - ingredients_with_unspecified_percent_n - ingredients_with_unspecified_percent_sum</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extract_ingredients_from_text_(_product_ref_)"
>extract_ingredients_from_text ( product_ref )</a></h2>

<p>This function calls:</p>

<p>- parse_ingredients_text_service() to parse the ingredients text in the main language of the product to extract individual ingredients and sub-ingredients</p>

<p>- compute_ingredients_percent_min_max_values() to create the ingredients array with nested sub-ingredients arrays</p>

<p>- compute_ingredients_tags() to create a flat array ingredients_original_tags and ingredients_tags (with parents)</p>

<p>- analyze_ingredients_service() to analyze ingredients to see the ones that are vegan, vegetarian, from palm oil etc. and to compute the resulting value for the complete product</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_missing_ciqual_codes_($ingredients_ref)"
>get_missing_ciqual_codes ($ingredients_ref)</a></h2>

<p>Assign a ciqual_food_code or a ciqual_proxy_food_code to ingredients and sub ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_ref"
>$ingredients_ref</a></h4>

<p>reference to an array of ingredients</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="@ingredients_without_ciqual_codes"
>@ingredients_without_ciqual_codes</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_missing_ecobalyse_ids_($ingredients_ref)"
>get_missing_ecobalyse_ids ($ingredients_ref)</a></h2>

<p>Assign a ecobalyse_code or a ecobalyse_proxy_code to ingredients and sub ingredients. (NOTE : this is a first version that&#39;ll soon be improved)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_ref"
>$ingredients_ref</a></h4>

<p>reference to an array of ingredients</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="@ingredients_without_ecobalyse_ids"
>@ingredients_without_ecobalyse_ids</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_geographical_area_($originid)"
>get_geographical_area ($originid)</a></h2>

<p>Retrieve the geographical area for ecobalyse. (NOTE : this is a first version that&#39;ll soon be improved)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$originid"
>$originid</a></h4>

<p>reference to the name of the country</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ecobalyse_area"
>$ecobalyse_area</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_ingredients_percent_service_(_$product_ref,_$updated_product_fields_ref,_$errors_ref_)"
>estimate_ingredients_percent_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a></h2>

<p>Compute minimum and maximum percent ranges and percent estimates for each ingredient and sub ingredient.</p>

<p>This function is a product service that can be run through ProductOpener::ApiProductServices</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>product object reference</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$updated_product_fields_ref"
>$updated_product_fields_ref</a></h4>

<p>reference to a hash of product fields that have been created or updated</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$errors_ref"
>$errors_ref</a></h4>

<p>reference to an array of error messages</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="count_ingredients_with_specified_percent($product_ref)"
>count_ingredients_with_specified_percent($product_ref)</a></h2>

<p>Count ingredients with specified percent, including sub-ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_n"
>$ingredients_n</a></h4>

<p>Number of ingredients.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_with_specified_percent_n"
>$ingredients_with_specified_percent_n</a></h4>

<p>Number of ingredients with a specified percent value.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$total_specified_percent"
>$total_specified_percent</a></h4>

<p>Sum of the specified percent values.</p>

<p>Note: this can be greater than 100 if percent values are specified for ingredients and their sub ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_ingredients_percent_values_(_ingredients_ref_)"
>delete_ingredients_percent_values ( ingredients_ref )</a></h2>

<p>This function deletes the percent_min and percent_max values of all ingredients.</p>

<p>It is called if the compute_ingredients_percent_min_max_values() encountered impossible values (e.g. &#34;Water, Sugar 80%&#34; -&#62; Water % should be greater than 80%, but the total would be more than 100%)</p>

<p>The function is recursive to also delete values for sub-ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_percent_min_max_values_(_total_min,_total_max,_ingredients_ref_)"
>compute_ingredients_percent_min_max_values ( total_min, total_max, ingredients_ref )</a></h2>

<p>This function computes the possible minimum and maximum ranges for the percent values of each ingredient and sub-ingredients.</p>

<p>Ingredients lists sometimes specify the percent value for some ingredients, but usually not all. This functions computes minimum and maximum percent values for all other ingredients.</p>

<p>Ingredients list are ordered by descending order of quantity.</p>

<p>This function is recursive and it calls itself for each ingredients with sub-ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_min_-_the_minimum_percent_value_of_the_total_of_all_the_ingredients_in_ingredients_ref"
>total_min - the minimum percent value of the total of all the ingredients in ingredients_ref</a></h4>

<p>0 when the function is called on all ingredients of a product, but can be different than 0 if called on sub-ingredients of an ingredient that has a minimum value set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_max_-_the_maximum_percent_value_of_all_ingredients_passed_in_ingredients_ref"
>total_max - the maximum percent value of all ingredients passed in ingredients_ref</a></h4>

<p>100 when the function is called on all ingredients of a product, but can be different than 0 if called on sub-ingredients of an ingredient that has a maximum value set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_ref_:_nested_array_of_ingredients_and_sub-ingredients"
>ingredient_ref : nested array of ingredients and sub-ingredients</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Negative_value_-_analysis_error"
>Negative value - analysis error</a></h4>

<p>The analysis encountered an impossible value. e.g. &#34;Flour, Sugar 80%&#34;: The % of Flour must be greated to the % of Sugar, but the sum would then be above 100%.</p>

<p>Or there were too many loops to analyze the values.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="0_or_positive_value_-_analysis_ok"
>0 or positive value - analysis ok</a></h4>

<p>The return value is the number of times we adjusted min and max values for ingredients and sub ingredients.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_percent_values($total_min,_$total_max,_$ingredients_ref)"
>init_percent_values($total_min, $total_max, $ingredients_ref)</a></h2>

<p>Initialize the percent, percent_min and percent_max value for each ingredient in list.</p>

<p>$ingredients_ref is the list of ingredients (as hash), where parsed percent are already set.</p>

<p>$total_min and $total_max might be set if we have a parent ingredient and are parsing a sub list.</p>

<p>When a percent is specifically set, use this value for percent_min and percent_max.</p>

<p>Warning: percent listed for sub-ingredients can be absolute (e.g. &#34;Sugar, fruits 40% (pear 30%, apple 10%)&#34;) or they can be relative to the parent ingredient (e.g. &#34;Sugar, fruits 40% (pear 75%, apple 25%)&#34;. We try to detect those cases and rescale the percent accordingly.</p>

<p>Otherwise use 0 for percent_min and total_max for percent_max.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_percent_max_from_taxonomy_(_ingredients_ref_)"
>set_percent_max_from_taxonomy ( ingredients_ref )</a></h2>

<p>Set the percentage maximum for ingredients like flavouring where this is defined on the Ingredients taxonomy. The percent_max will not be applied in the following cases:</p>

<pre> - if applying the percent_max would mean that it is not possible for the ingredient
   total to add up to 100%
 - If a later ingredient has a higher percentage than the percent_max of the restricted ingredient</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_ingredients_percent_estimates_(_total,_ingredients_ref_)"
>compute_ingredients_percent_estimates ( total, ingredients_ref )</a></h2>

<p>This function computes a possible estimate for the percent values of each ingredient and sub-ingredients.</p>

<p>The sum of all estimates must be 100%, and the estimates try to match the min and max constraints computed previously with the compute_ingredients_percent_min_max_values() function.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="total_-_the_total_of_all_the_ingredients_in_ingredients_ref"
>total - the total of all the ingredients in ingredients_ref</a></h4>

<p>100 when the function is called on all ingredients of a product, but can be different than 100 if called on sub-ingredients of an ingredient.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredient_ref_:_nested_array_of_ingredients_and_sub-ingredients"
>ingredient_ref : nested array of ingredients and sub-ingredients</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="analyze_ingredients_service_(_$product_ref,_$updated_product_fields_ref,_$errors_ref_)"
>analyze_ingredients_service ( $product_ref, $updated_product_fields_ref, $errors_ref )</a></h2>

<p>Analyzes ingredients to see the ones that are vegan, vegetarian, from palm oil etc. and computes the resulting value for the complete product.</p>

<p>The results are overridden by labels like &#34;Vegan&#34;, &#34;Vegetarian&#34; or &#34;Palm oil free&#34;</p>

<p>Results are stored in the ingredients_analysis_tags array.</p>

<p>This function is a product service that can be run through ProductOpener::ApiProductServices</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>product object reference</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$updated_product_fields_ref"
>$updated_product_fields_ref</a></h4>

<p>reference to a hash of product fields that have been created or updated</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$errors_ref"
>$errors_ref</a></h4>

<p>reference to an array of error messages</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_a_of_b_(_$lc,_$a,_$b,_$of_bool,_$alternate_names_ref_=_undef_)"
>normalize_a_of_b ( $lc, $a, $b, $of_bool, $alternate_names_ref = undef )</a></h2>

<p>This function is called by normalize_enumeration()</p>

<p>Given a category ($a) and a type ($b), it will return the ingredient that result from the combination of these two.</p>

<p>English: oil, olive -&#62; olive oil Croatian: je&#269;meni, slad -&#62; je&#269;meni slad French: huile, olive -&#62; huile d&#39;olive Russian: &#1084;&#1072;&#1089;&#1083;&#1086; &#1088;&#1072;&#1089;&#1090;&#1080;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077;, &#1087;&#1072;&#1083;&#1100;&#1084;&#1086;&#1074;&#1086;&#1077; -&#62; &#1084;&#1072;&#1089;&#1083;&#1086; &#1088;&#1072;&#1089;&#1090;&#1080;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1086;&#1083;&#1080;&#1074;&#1082;&#1086;&#1074;&#1086;&#1077;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="lc"
>lc</a></h4>

<p>language abbreviation (en for English, for example)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$a"
>$a</a></h4>

<p>string, category as defined in %ingredients_categories_and_types, example: &#39;oil&#39; for &#39;oil (sunflower, olive and palm)&#39;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$b"
>$b</a></h4>

<p>string, type as defined in %ingredients_categories_and_types, example: &#39;sunflower&#39; or &#39;olive&#39; or &#39;palm&#39; for &#39;oil (sunflower, olive and palm)&#39;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$of_bool_-_indicate_if_we_want_to_construct_entries_like_&#34;&#60;category&#62;_of_&#60;type&#62;&#34;"
>$of_bool - indicate if we want to construct entries like &#34;&#60;category&#62; of &#60;type&#62;&#34;</a></h4>

<p>e.g. in French we combine &#34;huile&#34; and &#34;olive&#34; to &#34;huile d&#39;olive&#34; but we combine &#34;poivron&#34; and &#34;rouge&#34; to &#34;poivron rouge&#34;.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$alternate_names_ref"
>$alternate_names_ref</a></h4>

<p>Reference to an array of alternate names for the category</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="combined_$a_and_$b_(or_$b_and_$a,_depending_of_the_language),_that_is_expected_to_be_an_ingredient"
>combined $a and $b (or $b and $a, depending of the language), that is expected to be an ingredient</a></h4>

<p>string, comma-joined category and type, example: &#39;palm vegetal oil&#39; or &#39;sunflower vegetal oil&#39; or &#39;olive vegetal oil&#39;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>normalize_enumeration ($ingredients_lc, $category, $types, $of_bool, $alternate_names_ref = undef, $do_not_output_parent = undef)</a></h2>

<p>This function is called by develop_ingredients_categories_and_types()</p>

<p>Some ingredients are specified by an ingredient &#34;category&#34; (e.g. &#34;oil&#34;) and a &#34;types&#34; string (e.g. &#34;sunflower, palm&#34;).</p>

<p>This function combines the category to all elements of the types string $category = &#34;Vegetal oil&#34; and $types = &#34;palm, sunflower and olive&#34; will return &#34;vegetal oil (palm vegetal oil, sunflower vegetal oil, olive vegetal oil)&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="lc"
>lc</a></h4>

<p>language abbreviation (en for English, for example)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="category"
>category</a></h4>

<p>string, as matched from definition in %ingredients_categories_and_types, example: &#39;Vegetal oil&#39; for &#39;Vegetal oil (sunflower, olive and palm)&#39;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="types"
>types</a></h4>

<p>string, as matched from definition in %ingredients_categories_and_types, example: &#39;sunflower, olive and palm&#39; for &#39;Vegetal oil (sunflower, olive and palm)&#39;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$of_bool_-_indicate_if_we_want_to_construct_entries_like_&#34;&#60;category&#62;_of_&#60;type&#62;&#34;"
>$of_bool - indicate if we want to construct entries like &#34;&#60;category&#62; of &#60;type&#62;&#34;</a></h4>

<p>e.g. in French we combine &#34;huile&#34; and &#34;olive&#34; to &#34;huile d&#39;olive&#34; but we combine &#34;poivron&#34; and &#34;rouge&#34; to &#34;poivron rouge&#34;.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$alternate_names_ref"
>$alternate_names_ref</a></h4>

<p>Reference to an array of alternate names for the category</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$do_not_output_parent_-_indicate_if_we_want_to_output_the_parent_ingredient"
>$do_not_output_parent - indicate if we want to output the parent ingredient</a></h4>

<p>e.g. for &#34;carbonates d&#39;ammonium et de sodium&#34;, we want only &#34;carbonates d&#39;ammonium, carbonates de sodium&#34; and not &#34;carbonates (carbonates d&#39;ammonium, carbonates de sodium)&#34; as &#34;carbonates&#34; is another additive</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Transformed_ingredients_list_text"
>Transformed ingredients list text</a></h4>

<p>string, with the type + a list of comma-joined category with all elements of the types example: &#39;vegetal oils (sunflower vegetal oil, olive vegetal oil, palm vegetal oil)&#39;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="split_generic_name_from_ingredients_(_product_ref_language_code_)"
>split_generic_name_from_ingredients ( product_ref language_code )</a></h2>

<p>Some producers send us an ingredients list that starts with the generic name followed by the actual ingredients list.</p>

<p>e.g. &#34;P&#226;tes de fruits aromatis&#233;es &#224; la fraise et &#224; la canneberge, contenant de la maltodextrine et de l&#39;ac&#233;rola. Source de vitamines B1, B6, B12 et C. Ingr&#233;dients : Pulpe de fruits 50% (poire William 25%, fraise 15%, canneberge 10%), sucre, sirop de glucose de bl&#233;, maltodextrine 5%, stabilisant : glyc&#233;rol, g&#233;lifiant : pectine, acidifiant : acide citrique, ar&#244;me naturel de fraise, ar&#244;me naturel de canneberge, poudre d&#39;ac&#233;rola (ac&#233;rola, maltodextrine) 0,4%, vitamines : B1, B6 et B12. Fabriqu&#233; dans un atelier utilisant: GLUTEN*, FRUITS A COQUE*. * Allerg&#232;nes&#34;</p>

<p>This function splits the list to put the generic name in the generic_name_[lc] field and the ingredients list in the ingredients_text_[lc] field.</p>

<p>If there is already a generic name, it is not overridden.</p>

<p>WARNING: This function should be called only during the import of data from producers. It should not be called on lists that can be the result of an OCR, as there is no guarantee that the text before the ingredients list is the generic name. It should also not be called when we import product data from the producers platform to the public database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="clean_ingredients_text_for_lang_(_product_ref_language_code_)"
>clean_ingredients_text_for_lang ( product_ref language_code )</a></h2>

<p>Perform some cleaning of the ingredients list.</p>

<p>The operations included in the cleaning must be 100% safe.</p>

<p>The function can be applied multiple times on the ingredients list.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="cut_ingredients_text_for_lang_(_product_ref_language_code_)"
>cut_ingredients_text_for_lang ( product_ref language_code )</a></h2>

<p>This function should be called once when getting text data from the OCR that includes an ingredients list.</p>

<p>It tries to remove phrases before and after the list that are not ingredients list.</p>

<p>It MUST NOT be applied multiple times on the ingredients list, as it could otherwise remove parts of the ingredients list. (e.g. it looks for &#34;Ingredients: &#34; and remove everything before it. If there are multiple &#34;Ingredients:&#34; listed, it would keep only the last one if called multiple times.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="replace_additive_($number,_$letter,_$variant)_-_normalize_the_additive"
>replace_additive ($number, $letter, $variant) - normalize the additive</a></h2>

<p>This function is used inside regular expressions to turn additives to a normalized form.</p>

<p>Using a function to concatenate the E-number, letter and variant makes it possible to deal with undefined $letter or $variant without triggering an undefined warning.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Synopsis"
>Synopsis</a></h3>

<pre>        $text =~ s/(\b)e( |-|\.)?$additivesregexp(\b|\s|,|\.|;|\/|-|\\|$)/replace_additive($3,$6,$9) . $12/ieg;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'

>develop_ingredients_categories_and_types ( $ingredients_lc, $text ) - turn &#34;oil (sunflower, olive and palm)&#34; into &#34;sunflower oil, olive oil, palm oil&#34;</a></h2>

<p>Some ingredients are specified by an ingredient &#34;category&#34; (e.g. &#34;oil&#34;, &#34;flavouring&#34;) and a &#34;type&#34; (e.g. &#34;sunflower&#34;, &#34;palm&#34; or &#34;strawberry&#34;, &#34;vanilla&#34;).</p>

<p>Sometimes, the category is mentioned only once for several types: &#34;strawberry and vanilla flavourings&#34;, &#34;vegetable oil (palm, sunflower)&#34;.</p>

<p>This function lists each individual ingredient: &#34;oil (sunflower, olive and palm)&#34; becomes &#34;sunflower oil, olive oil, palm oil&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language"
>Language</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Ingredients_list_text"
>Ingredients list text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Transformed_ingredients_list_text"
>Transformed ingredients list text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="%ingredients_categories_and_types"
>%ingredients_categories_and_types</a></h3>

<p>For each language, we list the categories and types of ingredients that can be combined when the ingredient list contains something like &#34;&#60;category&#62; (&#60;type1&#62;, &#60;type2&#62; and &#60;type3&#62;)&#34;</p>

<p>We can also provide a list of alternate_names, so that we can have a category like &#34;oils and fats&#34; and generate entries like &#34;sunflower oil&#34;, &#34;cocoa fat&#34; when the ingredients list contains &#34;oils and fats (sunflower, cocoa)&#34;.</p>

<p>Alternate names need to contain &#34;&#60;type&#62;&#34; which will be replaced by the type.</p>

<p>This can be especially useful in languages like German where we can create compound words with the type and the category* like &#34;Kokosnuss&#246;l&#34; or &#34;Sonnenblumenfett&#34;:</p>

<pre>        de =&#62; [
                {
                        categories =&#62; [&#34;pflanzliches Fett&#34;, &#34;pflanzliche &#214;le&#34;, &#34;pflanzliche &#214;le und Fette&#34;, &#34;Fett&#34;, &#34;&#214;le&#34;],
                        types =&#62; [&#34;Avocado&#34;, &#34;Baumwolle&#34;, &#34;Distel&#34;, &#34;Kokosnuss&#34;, &#34;Palm&#34;, &#34;Palmkern&#34;, &#34;Raps&#34;, &#34;Shea&#34;, &#34;Sonnenblumen&#34;,],
                        # Kokosnuss&#246;l, Sonnenblumenfett
                        alternate_names =&#62; [&#34;&#60;type&#62;fett&#34;, &#34;&#60;type&#62;&#246;l&#34;],
                },
        ],</pre>

<p>Simple plural (just an additional &#34;s&#34; at the end) will be added in the regexp.</p>

<p>Note that a &#34;&#60;categories&#62; ([list of types])&#34; enumeration will be developed only if all the types can be matched to the specified types in ingredients_categories_and_types.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="preparse_ingredients_text_($ingredients_lc,_$text)_-_normalize_the_ingredient_list_to_make_parsing_easier"
>preparse_ingredients_text ($ingredients_lc, $text) - normalize the ingredient list to make parsing easier</a></h2>

<p>This function transform the ingredients list in a more normalized list that is easier to parse.</p>

<p>It does the following:</p>

<p>- Normalize quote characters - Replace abbreviations by their full name - Remove extra spaces in compound words width dashes (e.g. c&#233;l&#233;ri - rave -&#62; c&#233;l&#233;ri-rave) - Split vitamins enumerations - Normalize additives and split additives enumerations - Split other enumerations (e.g. oils, some minerals) - Split allergens and traces - Deal with signs like * to indicate labels (e.g. *: Organic)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language"
>Language</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Ingredients_list_text"
>Ingredients list text</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Transformed_ingredients_list_text"
>Transformed ingredients list text</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extract_additives_from_text_($product_ref)_-_extract_additives_from_the_ingredients_text"
>extract_additives_from_text ($product_ref) - extract additives from the ingredients text</a></h2>

<p>This function extracts additives from the ingredients text and adds them to the product_ref in the additives_tags array.</p>

<p>TODO: this function is independent of the ingredient parsing, we should combine the two.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference"
>Product reference</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="count_sweeteners_and_non_nutritive_sweeteners"
>count_sweeteners_and_non_nutritive_sweeteners</a></h2>

<p>Check if the product contains sweeteners and non nutritive sweeteners (used for the Nutri-Score for beverages)</p>

<p>The NNS / Non nutritive sweeteners listed in the Nutri-Score Update report beverages_31 01 2023-voted have been added as a non_nutritive_sweetener:en:yes property in the additives taxonomy.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The function sets the following fields in the product_ref hash.</p>

<p>If there are no ingredients specified for the product, the fields are not set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredients_sweeteners_n"
>ingredients_sweeteners_n</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="ingredients_non_nutritive_sweeteners_n"
>ingredients_non_nutritive_sweeteners_n</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="detect_allergens_from_ingredients_(_$product_ref_)"
>detect_allergens_from_ingredients ( $product_ref )</a></h2>

<p>Detects allergens from the ingredients extracted from the ingredients text, using the &#34;allergens:en&#34; property associated to some ingredients in the ingredients taxonomy.</p>

<p>This functions needs to be run after the $product_ref-&#62;{ingredients} array is populated from the ingredients text.</p>

<p>It is called by detect_allergens_from_text(). Allergens are added to $product_ref-&#62;{&#34;allergens_from_ingredients&#34;} which is then used by detect_allergens_from_text() to populate the allergens_tags field.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_allergens_taxonomyid_(_$ingredients_lc,_$ingredient_or_allergen_)"
>get_allergens_taxonomyid ( $ingredients_lc, $ingredient_or_allergen )</a></h2>

<p>In the allergens provided by users, we may get ingredients that are not in the allergens taxonomy, but that are in the ingredients taxonomy and have an inherited allergens:en property. (e.g. the allergens taxonomy has an en:fish entry, but users may indicate specific fish species)</p>

<p>This function tries to match the ingredient with an allergen in the allergens taxonomy, and otherwise return the taxonomy id for the original ingredient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredients_lc"
>$ingredients_lc</a></h4>

<p>The language code of $ingredient_or_allergen.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ingredient_or_allergen"
>$ingredient_or_allergen</a></h4>

<p>The ingredient or allergen to match. Can also be an ingredient id or allergens id prefixed with a language code.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>The taxonomy id for the allergen, or the original ingredient if no allergen was found.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="detect_allergens_from_text_(_$product_ref_)"
>detect_allergens_from_text ( $product_ref )</a></h2>

<p>This function: - combines all the ways we have to detect allergens in order to populate the allergens_tags and traces_tags fields. - creates the ingredients_text_with_allergens_[lc] fields with added HTML &#60;span class=&#34;allergen&#34;&#62; tags</p>

<p>Allergens are recognized in the following ways:</p>

<p>1. using the list of ingredients that have been recognized through ingredients analysis, by looking at the allergens:en property in the ingredients taxonomy. This is done with the function detect_allergens_from_ingredients()</p>

<p>2. when entered in ALL CAPS, or between underscores</p>

<p>3. when matching exact entries o synonyms of the allergens taxonomy</p>

<p>Allergens detected using 2. or 3. are marked with &#60;span class=&#34;allergen&#34;&#62;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_ingredients_matching_function_(_$ingredients_ref,_$match_function_ref_)"
>add_ingredients_matching_function ( $ingredients_ref, $match_function_ref )</a></h2>

<p>Recursive function to compute the percentage of ingredients that match a specific function.</p>

<p>The match function takes 2 arguments: - ingredient id - processing (comma separated list of ingredients_processing taxonomy entries)</p>

<p>Used to compute % of fruits and vegetables, % of milk etc. which is needed by some algorithm like the Nutri-Score.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$percent"
>$percent</a></h4>

<p>Sum of matching ingredients percent.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$water_percent"
>$water_percent</a></h4>

<p>Percent of water (used to recompute the percentage for categories of products that are consumed after removing water)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_ingredients_matching_function_(_$product_ref,_$match_function_ref,_$nutrient_id_=_undef_)"
>estimate_ingredients_matching_function ( $product_ref, $match_function_ref, $nutrient_id = undef )</a></h2>

<p>This function analyzes the ingredients to estimate the percentage of ingredients of a specific type (e.g. fruits/vegetables/legumes for the Nutri-Score).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$match_function_ref"
>$match_function_ref</a></h4>

<p>Reference to a function that matches specific ingredients (e.g. fruits/vegetables/legumes)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_id_(optional)"
>$nutrient_id (optional)</a></h4>

<p>If the $nutrient_id argument is defined, we also store the nutrient value in $product_ref-&#62;{nutriments}.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>Estimated percentage of ingredients matching the function.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_fruits_vegetables_nuts_olive_walnut_rapeseed_oils_(_$ingredient_id,_$processing_=_undef_)"
>is_fruits_vegetables_nuts_olive_walnut_rapeseed_oils ( $ingredient_id, $processing = undef )</a></h2>

<p>Determine if an ingredient should be counted as &#34;fruits, vegetables, nuts, olive / walnut / rapeseed oils&#34; in Nutriscore 2021 algorithm.</p>

<p>- we use the nutriscore_fruits_vegetables_nuts:en property to identify qualifying ingredients - we check that the parent of those ingredients is not a flour - we check that the ingredient does not have a processing like en:powder</p>

<p>NUTRI-SCORE FREQUENTLY ASKED QUESTIONS - UPDATED 27/09/2022:</p>

<p>&#34;However, fruits, vegetables and pulses that are subject to further processing (e.g. concentrated fruit juice sugars, powders, freeze-drying, candied fruits, fruits in stick form, flours leading to loss of water) do not count. As an example, corn in the form of popcorn or soy proteins cannot be considered as vegetables. Regarding the frying process, fried vegetables which are thick and only partially dehydrated by the process can be taken into account, whereas crisps which are thin and completely dehydrated are excluded.&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_nutriscore_2021_fruits_vegetables_nuts_percent_from_ingredients_(_product_ref_)"
>estimate_nutriscore_2021_fruits_vegetables_nuts_percent_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the minimum percentage of fruits, vegetables, nuts, olive / walnut / rapeseed oil, so that we can compute the Nutri-Score fruit points if we don&#39;t have a value given by the manufacturer or estimated by users.</p>

<p>Results are stored in $product_ref-&#62;{nutriments}{&#34;fruits-vegetables-nuts-estimate-from-ingredients_100g&#34;} (and _serving)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_fruits_vegetables_legumes_(_$ingredient_id,_$processing_=_undef)"
>is_fruits_vegetables_legumes ( $ingredient_id, $processing = undef)</a></h2>

<p>Determine if an ingredient should be counted as &#34;fruits, vegetables, legumes&#34; in Nutriscore 2023 algorithm.</p>

<p>- we use the eurocode_2_group_1:en and eurocode_2_group_2:en property to identify qualifying ingredients - we check that the parent of those ingredients is not a flour - we check that the ingredient does not have a processing like en:powder</p>

<p>1.2.2. Ingredients contributing to the &#34;Fruit, vegetables and legumes&#34; component</p>

<p>The list of ingredients qualifying for the &#34;Fruit, vegetables and legumes&#34; component has been revised to include the following Eurocodes: &#8226; Vegetables groups o 8.10 (Leaf vegetables); o 8.15 (Brassicas); o 8.20 (Stalk vegetables); o 8.25 (Shoot vegetables); o 8.30 (Onion-family vegetables); o 8.38 (Root vegetables); o 8.40 (Fruit vegetables); o 8.42 (Flower-head vegetables); o 8.45 (Seed vegetables and immature pulses); o 8.50 (Edible fungi); o 8.55 (Seaweeds and algae); o 8.60 (Vegetable mixtures) Fruits groups o 9.10 (Malaceous fruit); o 9.20 (Prunus species fruit); o 9.25 (Other stone fruit); o 9.30 (Berries); o 9.40 (Citrus fruit); o 9.50 (Miscellaneous fruit); o 9.60 (Fruit mixtures). Pulses groups o 7.10 (Pulses).</p>

<p>Additionally, in the fats and oils category specifically, oils derived from ingredients in the list qualify for the component (e.g. olive and avocado).</p>

<p>--</p>

<p>NUTRI-SCORE FREQUENTLY ASKED QUESTIONS - UPDATED 27/09/2022:</p>

<p>&#34;However, fruits, vegetables and pulses that are subject to further processing (e.g. concentrated fruit juice sugars, powders, freeze-drying, candied fruits, fruits in stick form, flours leading to loss of water) do not count. As an example, corn in the form of popcorn or soy proteins cannot be considered as vegetables. Regarding the frying process, fried vegetables which are thick and only partially dehydrated by the process can be taken into account, whereas crisps which are thin and completely dehydrated are excluded.&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_nutriscore_2023_fruits_vegetables_legumes_percent_from_ingredients_(_product_ref_)"
>estimate_nutriscore_2023_fruits_vegetables_legumes_percent_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the minimum percentage of fruits, vegetables, legumes, so that we can compute the Nutri-Score (2023) fruit points.</p>

<p>Results are stored in $product_ref-&#62;{nutriments}{&#34;fruits-vegetables-legumes-estimate-from-ingredients_100g&#34;} (and _serving)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_milk_(_$ingredient_id,_$processing_=_undef_)"
>is_milk ( $ingredient_id, $processing = undef )</a></h2>

<p>Determine if an ingredient should be counted as milk in Nutriscore 2021 algorithm</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_nutriscore_2021_milk_percent_from_ingredients_(_product_ref_)"
>estimate_nutriscore_2021_milk_percent_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the percentage of milk in a product, in order to know if a dairy drink should be considered as a food (at least 80% of milk) or a beverage.</p>

<p>Return value: estimated % of milk.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_red_meat_(_$ingredient_id_)"
>is_red_meat ( $ingredient_id )</a></h2>

<p>Determine if an ingredient should be counted as red meat in Nutriscore 2023 algorithm</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_nutriscore_2023_red_meat_percent_from_ingredients_(_product_ref_)"
>estimate_nutriscore_2023_red_meat_percent_from_ingredients ( product_ref )</a></h2>

<p>This function analyzes the ingredients to estimate the percentage of red meat, so that we can determine if the maximum limit of 2 points for proteins should be applied in the Nutri-Score 2023 algorithm.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="sub_get_ingredients_with_property_value_($ingredients_ref,_$property,_$value)"
>sub get_ingredients_with_property_value ($ingredients_ref, $property, $value)</a></h2>

<p>Returns a list of ingredients that have a specific property value.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="estimate_added_sugars_percent_from_ingredients_($product_ref)"
>estimate_added_sugars_percent_from_ingredients ($product_ref)</a></h2>

<p>This function analyzes the ingredients to estimate the percentage of added sugars in a product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="sub_get_ingredients_with_parent_($ingredients_ref,_$property,_$value)"
>sub get_ingredients_with_parent ($ingredients_ref, $property, $value)</a></h2>

<p>Returns a list of ingredients that have a specific parent.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="detect_rare_crops_(_$product_ref_)"
>detect_rare_crops ( $product_ref )</a></h2>

<p>Detects if the product contains rare crops, and adds the tag en:ingredients-contain-rare-crops to the product.</p>

<p>Rare crops are defined by the EU project DIVINFOOD (that OFF is participating in), which calls them NUCs (Neglected and Underutilized Crops).</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
