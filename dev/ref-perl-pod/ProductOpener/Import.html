<html><head><title>ProductOpener::Import</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Tue Oct 21 07:51:01 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#list_product_images_files_in_dir_(%24image_dir%2C_%24stats)'>list_product_images_files_in_dir ($image_dir, $stats)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24image_dir_Image_directory'>$image_dir Image directory</a>
        <li class='indexItem indexItem4'><a href='#%24stats_Stats_reference'>$stats Stats reference</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24args_ref_Import_arguments_reference'>$args_ref Import arguments reference</a>
        <li class='indexItem indexItem4'><a href='#%24images_ref_Images_reference_for_the_product'>$images_ref Images reference for the product</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref_Product_reference'>$product_ref Product reference</a>
        <li class='indexItem indexItem4'><a href='#%24imported_product_ref_Imported_product_reference%3A_from_a_CSV_file%2C_may_contain_image_coordinates'>$imported_product_ref Imported product reference: from a CSV file, may contain image coordinates</a>
        <li class='indexItem indexItem4'><a href='#%24product_id_Product_ID'>$product_id Product ID</a>
        <li class='indexItem indexItem4'><a href='#%24code_Product_code'>$code Product code</a>
        <li class='indexItem indexItem4'><a href='#%24user_id_User_ID_used_to_upload_and_select_the_pictures'>$user_id User ID used to upload and select the pictures</a>
        <li class='indexItem indexItem4'><a href='#%24stats_ref_Stats_reference_to_keep_track_of_the_number_of_images_added'>$stats_ref Stats reference to keep track of the number of images added</a>
      </ul>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#preprocess_field(%24imported_product_ref%2C_%24product_ref%2C_%24field%2C_%24yes_regexp%2C_%24no_regexp)'>preprocess_field($imported_product_ref, $product_ref, $field, $yes_regexp, $no_regexp)</a>
    <li class='indexItem indexItem2'><a href='#import_csv_file_(_ARGUMENTS_)'>import_csv_file ( ARGUMENTS )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#user_id_-_required'>user_id - required</a>
        <li class='indexItem indexItem4'><a href='#org_id_-_optional'>org_id - optional</a>
        <li class='indexItem indexItem4'><a href='#owner_id_-_optional'>owner_id - optional</a>
        <li class='indexItem indexItem4'><a href='#csv_file_-_required'>csv_file - required</a>
        <li class='indexItem indexItem4'><a href='#global_values_-_optional'>global_values - optional</a>
        <li class='indexItem indexItem4'><a href='#images_dir_-_optional'>images_dir - optional</a>
        <li class='indexItem indexItem4'><a href='#comment_-_optional'>comment - optional</a>
        <li class='indexItem indexItem4'><a href='#no_source_-_optional'>no_source - optional</a>
        <li class='indexItem indexItem4'><a href='#source_id_-_required_(unless_no_source_is_indicated)'>source_id - required (unless no_source is indicated)</a>
        <li class='indexItem indexItem4'><a href='#source_name_-_required_(unless_no_source_is_indicated)'>source_name - required (unless no_source is indicated)</a>
        <li class='indexItem indexItem4'><a href='#source_url_-_required_(unless_no_source_is_indicated)'>source_url - required (unless no_source is indicated)</a>
        <li class='indexItem indexItem4'><a href='#source_licence_-_optional_(unless_no_source_is_indicated)'>source_licence - optional (unless no_source is indicated)</a>
        <li class='indexItem indexItem4'><a href='#source_licence_url_-_optional_(unless_no_source_is_indicated)'>source_licence_url - optional (unless no_source is indicated)</a>
        <li class='indexItem indexItem4'><a href='#manufacturer_-_optional'>manufacturer - optional</a>
        <li class='indexItem indexItem4'><a href='#test_-_optional'>test - optional</a>
        <li class='indexItem indexItem4'><a href='#skip_if_not_code_-_optional'>skip_if_not_code - optional</a>
        <li class='indexItem indexItem4'><a href='#skip_not_existing_products_-_optional'>skip_not_existing_products - optional</a>
        <li class='indexItem indexItem4'><a href='#skip_products_without_info_-_optional'>skip_products_without_info - optional</a>
        <li class='indexItem indexItem4'><a href='#skip_products_without_images_-_optional'>skip_products_without_images - optional</a>
        <li class='indexItem indexItem4'><a href='#skip_existing_values_-_optional'>skip_existing_values - optional</a>
        <li class='indexItem indexItem4'><a href='#only_select_not_existing_images_-_optional'>only_select_not_existing_images - optional</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#update_export_status_for_csv_file(_ARGUMENTS_)'>update_export_status_for_csv_file( ARGUMENTS )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#user_id_-_required'>user_id - required</a>
        <li class='indexItem indexItem4'><a href='#org_id_-_optional'>org_id - optional</a>
        <li class='indexItem indexItem4'><a href='#owner_id_-_optional'>owner_id - optional</a>
        <li class='indexItem indexItem4'><a href='#csv_file_-_required'>csv_file - required</a>
        <li class='indexItem indexItem4'><a href='#exported_t_-_required'>exported_t - required</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#import_products_categories_from_public_database_(_ARGUMENTS_)'>import_products_categories_from_public_database ( ARGUMENTS )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#user_id_-_required'>user_id - required</a>
        <li class='indexItem indexItem4'><a href='#org_id_-_optional'>org_id - optional</a>
        <li class='indexItem indexItem4'><a href='#owner_id_-_required'>owner_id - required</a>
      </ul>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Import - import products data in CSV format and products photos</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Import</code> is used to import product data in the Open Food Facts CSV format and associated product photos.</p>

<pre>    use ProductOpener::Import qw/:all/;
        import_csv_file( {
                user_id =&#62; &#34;user&#34;,
                org_id =&#62; &#34;organization&#34;,
                csv_file =&#62; &#34;/path/to/product_data.csv&#34;,
        });</pre>

<p>This module is used to import product data provided by manufacturers on the producers platform: the data from manufacturers (in CSV or Excel files) is first converted to the Open Food Facts CSV format, then imported with <code>import_csv_file</code>.</p>

<p>It is also used to export product data from the producers platform to the public database. The data is first exported from the producers platform with the <code>ProductOpener::Export</code> module, and then imported in the public database with the <code>import_csv_file</code> function.</p>

<p>In the producers platform, the <code>import_csv_file</code> function is executed through a Minion worker.</p>

<p>It is also used in the <code>scripts/import_csv_file.pl</code> script.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>..</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="list_product_images_files_in_dir_($image_dir,_$stats)"
>list_product_images_files_in_dir ($image_dir, $stats)</a></h2>

<p>List product images files in a directory. The resulting list can be used by import_images_for_product() to upload the images.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$image_dir_Image_directory"
>$image_dir Image directory</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$stats_Stats_reference"
>$stats Stats reference</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>A reference to a hash of product codes with image types (front, ingredients, nutrition, other) with optional language codes as keys, and image file names as values.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>upload_images_for_product ($args_ref, $images_ref, $product_ref, $imported_product_ref, $product_id, $code, $user_id, $comment, $stats_ref)</a></h2>

<p>Given a list of images for a product with possible image types (front, ingredients, nutrition, other), upload them to the server and select the image type.</p>

<p>This function is called by import_csv_file() as CSV file can contain links to images, or we may have associated images in a directory (loaded with list_product_images_files_in_dir()).</p>

<p>It is is also called directly by the import_images.pl script, to upload images from a directory.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$args_ref_Import_arguments_reference"
>$args_ref Import arguments reference</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$images_ref_Images_reference_for_the_product"
>$images_ref Images reference for the product</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_Product_reference"
>$product_ref Product reference</a></h4>

<p>Only needed to get the &#34;images&#34; field, and &#34;lc&#34; field to determine the language of the product.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$imported_product_ref_Imported_product_reference:_from_a_CSV_file,_may_contain_image_coordinates"
>$imported_product_ref Imported product reference: from a CSV file, may contain image coordinates</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id_Product_ID"
>$product_id Product ID</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$code_Product_code"
>$code Product code</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id_User_ID_used_to_upload_and_select_the_pictures"
>$user_id User ID used to upload and select the pictures</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$stats_ref_Stats_reference_to_keep_track_of_the_number_of_images_added"
>$stats_ref Stats reference to keep track of the number of images added</a></h4>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="preprocess_field($imported_product_ref,_$product_ref,_$field,_$yes_regexp,_$no_regexp)"
>preprocess_field($imported_product_ref, $product_ref, $field, $yes_regexp, $no_regexp)</a></h2>

<p>Do some pre-processing on input field values:</p>

<p>- Fields suffixed with _if_not_existing are loaded only if the product does not have an existing value - Special handling of tags fields: - Empty values are skipped - For labels and categories, we can have columns like labels:Bio with values like 1, Y, Yes - [tags type]_if_match_in_taxonomy : contains candidate values that we import only if we have a matching taxonomy entry - Values for multiple columns for the same tag field. e.g. brands, brands.2, brands.3 etc. are concatenated with a comma</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>set_field_value($args_ref, $imported_product_ref, $product_ref, $field, $yes_regexp, $no_regexp, $stats_ref, $modified_ref, $differing_ref)</a></h2>

<p>Update a product field value in $product_ref based on the value in the imported product $imported_product_ref</p>

<p>Return an incremented $modified value if a change was made.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="import_csv_file_(_ARGUMENTS_)"
>import_csv_file ( ARGUMENTS )</a></h2>

<p><code>import_csv_file()</code> imports product data in the Open Food Facts CSV format and associated product photos.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Arguments are passed through a single hash reference with the following keys:</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="user_id_-_required"
>user_id - required</a></h4>

<p>User id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<p>If the user_id is &#39;all&#39;, the change will be attributed to the org of the product. (e.g. when importing products from the producers database to the public database)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="org_id_-_optional"
>org_id - optional</a></h4>

<p>Organization id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="owner_id_-_optional"
>owner_id - optional</a></h4>

<p>For databases with private products, owner (user or org) that the products belong to. Values are of the form user-[user id] or org-[organization id].</p>

<p>If not set, for databases with private products, it will be constructed from the user_id and org_id parameters.</p>

<p>The owner can be overrode if the CSV file contains a org_name field. In that case, the owner is set to the value of the org_name field, and a new org is created if it does not exist yet.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="csv_file_-_required"
>csv_file - required</a></h4>

<p>Path and file name of the CSV file to import.</p>

<p>The CSV file needs to be in the Open Food Facts CSV format, encoded in UTF-8 with tabs as separators.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="global_values_-_optional"
>global_values - optional</a></h4>

<p>Hash ref that specifies fields and values that will be used as default values.</p>

<p>If the CSV contains a non-empty value for a field, the value from the CSV file is used.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="images_dir_-_optional"
>images_dir - optional</a></h4>

<p>Path to a directory that contains images for the products.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="comment_-_optional"
>comment - optional</a></h4>

<p>Comment that will be saved in the product history.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="no_source_-_optional"
>no_source - optional</a></h4>

<p>Indicates that there should not be a data source attribution.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="source_id_-_required_(unless_no_source_is_indicated)"
>source_id - required (unless no_source is indicated)</a></h4>

<p>Source id for the data and images.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="source_name_-_required_(unless_no_source_is_indicated)"
>source_name - required (unless no_source is indicated)</a></h4>

<p>Name of the source.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="source_url_-_required_(unless_no_source_is_indicated)"
>source_url - required (unless no_source is indicated)</a></h4>

<p>URL for the source.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="source_licence_-_optional_(unless_no_source_is_indicated)"
>source_licence - optional (unless no_source is indicated)</a></h4>

<p>License that the source data is available in.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="source_licence_url_-_optional_(unless_no_source_is_indicated)"
>source_licence_url - optional (unless no_source is indicated)</a></h4>

<p>URL for the license.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="manufacturer_-_optional"
>manufacturer - optional</a></h4>

<p>A positive value indicates that the data is imported from the manufacturer of the products.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="test_-_optional"
>test - optional</a></h4>

<p>Compute statistics on the number of products the import would add or change, but do not actually import and save the changes.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="skip_if_not_code_-_optional"
>skip_if_not_code - optional</a></h4>

<p>Only import one product with the corresponding code.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="skip_not_existing_products_-_optional"
>skip_not_existing_products - optional</a></h4>

<p>Only import product data if the product already exists in the database. This can be useful when we have very sparse data to import (e.g. a list of codes of products sold in a given store chain), and we do not want to create products when we have no other existing data.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="skip_products_without_info_-_optional"
>skip_products_without_info - optional</a></h4>

<p>Do not import products when we do not have info (product name or brands)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="skip_products_without_images_-_optional"
>skip_products_without_images - optional</a></h4>

<p>Do not import products if there are no corresponding images in the directory specified by the images_dir argument/</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="skip_existing_values_-_optional"
>skip_existing_values - optional</a></h4>

<p>If a product already has existing values for some fields, do not overwrite it with values from the CSV file.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="only_select_not_existing_images_-_optional"
>only_select_not_existing_images - optional</a></h4>

<p>If the product already has an image for front, ingredients or nutrition in a given language, do not overwrite it with an image from the import. The image will still be uploaded and added to the product, but it will not be selected.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="update_export_status_for_csv_file(_ARGUMENTS_)"
>update_export_status_for_csv_file( ARGUMENTS )</a></h2>

<p>Once products from a CSV file have been exported from the producers platform and imported on the public platform, update_export_status_for_csv_file() marks them as exported on the producers platform.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Arguments are passed through a single hash reference with the following keys:</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="user_id_-_required"
>user_id - required</a></h4>

<p>User id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="org_id_-_optional"
>org_id - optional</a></h4>

<p>Organization id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="owner_id_-_optional"
>owner_id - optional</a></h4>

<p>For databases with private products, owner (user or org) that the products belong to. Values are of the form user-[user id] or org-[organization id].</p>

<p>If not set, for databases with private products, it will be constructed from the user_id and org_id parameters.</p>

<p>The owner can be overrode if the CSV file contains a org_name field. In that case, the owner is set to the value of the org_name field, and a new org is created if it does not exist yet.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="csv_file_-_required"
>csv_file - required</a></h4>

<p>Path and file name of the CSV file to import.</p>

<p>The CSV file needs to be in the Open Food Facts CSV format, encoded in UTF-8 with tabs as separators.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="exported_t_-_required"
>exported_t - required</a></h4>

<p>Time of the export.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="import_products_categories_from_public_database_(_ARGUMENTS_)"
>import_products_categories_from_public_database ( ARGUMENTS )</a></h2>

<p><code>import_products_categories_from_public_database()</code> imports categories from the public Open Food Facts database to the producers platform, for products with a specific owner.</p>

<p>The products have to already exist in the producers platform.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Arguments are passed through a single hash reference with the following keys:</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="user_id_-_required"
>user_id - required</a></h4>

<p>User id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="org_id_-_optional"
>org_id - optional</a></h4>

<p>Organization id to which the changes (new products, added or changed values, new images) will be attributed.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="owner_id_-_required"
>owner_id - required</a></h4>

<p>Owner of the products on the producers platform.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
