<html><head><title>ProductOpener::Images</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Tue Aug 26 16:34:13 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#Product_images_on_disk'>Product images on disk</a>
  <li class='indexItem indexItem1'><a href='#SUPPORTED_IMAGE_TYPES'>SUPPORTED IMAGE TYPES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#VALID_IMAGE_TYPES'>VALID IMAGE TYPES</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#get_image_type_and_image_lc_from_imagefield_(%24imagefield)'>get_image_type_and_image_lc_from_imagefield ($imagefield)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24imagefield_e.g._%22front_fr%22'>$imagefield e.g. &#34;front_fr&#34;</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_select_crop_(%24object_ref%2C_%24image_type%2C_%24image_lc%2C_%24language%2C_%24request_ref)_%7B'>display_select_crop ($object_ref, $image_type, $image_lc, $language, $request_ref) {</a>
    <li class='indexItem indexItem2'><a href='#display_select_crop_init_(%24object_ref)'>display_select_crop_init ($object_ref)</a>
    <li class='indexItem indexItem2'><a href='#get_code_and_imagefield_from_file_name_(_%24l_%24filename_)'>get_code_and_imagefield_from_file_name ( $l $filename )</a>
    <li class='indexItem indexItem2'><a href='#generate_resized_images_(%24path%2C_%24filename%2C_%24image_source%2C_%24sizes_ref%2C_%40sizes)'>generate_resized_images ($path, $filename, $image_source, $sizes_ref, @sizes)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24path'>$path</a>
        <li class='indexItem indexItem4'><a href='#%24filename'>$filename</a>
        <li class='indexItem indexItem4'><a href='#%24image_source'>$image_source</a>
        <li class='indexItem indexItem4'><a href='#%24sizes_ref'>$sizes_ref</a>
        <li class='indexItem indexItem4'><a href='#%40sizes'>@sizes</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_image_upload_(_%24product_ref%2C_%24imagefield%2C_%24user_id%2C_%24time%2C_%24comment%2C_%24imgid_ref%2C_%24debug_string_ref_)'>process_image_upload ( $product_ref, $imagefield, $user_id, $time, $comment, $imgid_ref, $debug_string_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_ref_%24product_ref'>Product ref $product_ref</a>
        <li class='indexItem indexItem4'><a href='#Image_field_%24imagefield'>Image field $imagefield</a>
        <li class='indexItem indexItem4'><a href='#User_id_%24user_id'>User id $user_id</a>
        <li class='indexItem indexItem4'><a href='#Timestamp_of_the_image_%24time'>Timestamp of the image $time</a>
        <li class='indexItem indexItem4'><a href='#Comment_%24comment'>Comment $comment</a>
        <li class='indexItem indexItem4'><a href='#Reference_to_an_image_id_%24img_id'>Reference to an image id $img_id</a>
        <li class='indexItem indexItem4'><a href='#Debug_string_reference_%24debug_string_ref'>Debug string reference $debug_string_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_ref_%24product_ref'>Product ref $product_ref</a>
        <li class='indexItem indexItem4'><a href='#File_handle_%24filehandle_to_the_image_data'>File handle $filehandle to the image data</a>
        <li class='indexItem indexItem4'><a href='#User_id_%24user_id'>User id $user_id</a>
        <li class='indexItem indexItem4'><a href='#Timestamp_of_the_image_%24time'>Timestamp of the image $time</a>
        <li class='indexItem indexItem4'><a href='#Comment_%24comment'>Comment $comment</a>
        <li class='indexItem indexItem4'><a href='#Reference_to_an_image_id_%24imgid_ref'>Reference to an image id $imgid_ref</a>
        <li class='indexItem indexItem4'><a href='#Debug_string_reference_%24debug_string_ref'>Debug string reference $debug_string_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#remove_images_by_prefix_(_%24product_ref%2C_%24prefix_)'>remove_images_by_prefix ( $product_ref, $prefix )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24prefix'>$prefix</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#delete_uploaded_image_and_associated_selected_images_(_%24product_ref%2C_%24imgid_)'>delete_uploaded_image_and_associated_selected_images ( $product_ref, $imgid )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24imgid'>$imgid</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_image_move_(_%24user_id%2C_%24code%2C_%24imgids%2C_%24move_to%2C_%24ownerid_)'>process_image_move ( $user_id, $code, $imgids, $move_to, $ownerid )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
        <li class='indexItem indexItem4'><a href='#%24code'>$code</a>
        <li class='indexItem indexItem4'><a href='#%24imgids'>$imgids</a>
        <li class='indexItem indexItem4'><a href='#%24move_to'>$move_to</a>
        <li class='indexItem indexItem4'><a href='#%24ownerid'>$ownerid</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#same_image_generation_parameters_(_%24generation_1_ref%2C_%24generation_2_ref_)'>same_image_generation_parameters ( $generation_1_ref, $generation_2_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24generation_1_ref'>$generation_1_ref</a>
        <li class='indexItem indexItem4'><a href='#%24generation_2_ref'>$generation_2_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_generation_ref_(_%24generation_ref_)'>normalize_generation_ref ( $generation_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24generation_ref'>$generation_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Return_values'>Return values</a>
    <li class='indexItem indexItem2'><a href='#get_image_url_(%24product_ref%2C_%24image_ref%2C_%24size)'>get_image_url ($product_ref, $image_ref, $size)</a>
    <li class='indexItem indexItem2'><a href='#get_image_in_best_language_(%24product_ref%2C_%24image_type%2C_%24target_lc)'>get_image_in_best_language ($product_ref, $image_type, $target_lc)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_images_urls_to_product_(%24product_ref%2C_%24target_lc%2C_%24specific_image_type_%3D_undef)'>add_images_urls_to_product ($product_ref, $target_lc, $specific_image_type = undef)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24target_lc'>$target_lc</a>
        <li class='indexItem indexItem4'><a href='#%24specific_image_type'>$specific_image_type</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#data_to_display_image_(_%24product_ref%2C_%24image_type%2C_%24target_lc_)'>data_to_display_image ( $product_ref, $image_type, $target_lc )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
        <li class='indexItem indexItem4'><a href='#Image_type_%24image_type%3A_one_of_%5Bfront%7Cingredients%7Cnutrition%7Cpackaging%5D'>Image type $image_type: one of [front|ingredients|nutrition|packaging]</a>
        <li class='indexItem indexItem4'><a href='#Language_code_%24target_lc'>Language code $target_lc</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#display_image_(_%24product_ref%2C_%24image_type%2C_%24target_lc%2C_%24size_)'>display_image ( $product_ref, $image_type, $target_lc, $size )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
        <li class='indexItem indexItem4'><a href='#Image_type_%24image_type%3A_one_of_%5Bfront%7Cingredients%7Cnutrition%7Cpackaging%5D'>Image type $image_type: one of [front|ingredients|nutrition|packaging]</a>
        <li class='indexItem indexItem4'><a href='#Language_code_%24target_lc'>Language code $target_lc</a>
        <li class='indexItem indexItem4'><a href='#Size_%24size%3A_one_of_%24thumb_size%2C_%24small_size%2C_%24display_size'>Size $size: one of $thumb_size, $small_size, $display_size</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#select_ocr_engine_(%24requested_ocr_engine)'>select_ocr_engine ($requested_ocr_engine)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24requested_ocr_engine'>$requested_ocr_engine</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#extract_text_from_image(_%24product_ref%2C_%24id%2C_%24field%2C_%24ocr_engine%2C_%24results_ref_)'>extract_text_from_image( $product_ref, $id, $field, $ocr_engine, $results_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_reference_%24product_ref'>product reference $product_ref</a>
        <li class='indexItem indexItem4'><a href='#id_of_the_image_%24id'>id of the image $id</a>
        <li class='indexItem indexItem4'><a href='#field_name_%24field'>field name $field</a>
        <li class='indexItem indexItem4'><a href='#Requested_OCR_engine_%24requested_ocr_engine'>Requested OCR engine $requested_ocr_engine</a>
        <li class='indexItem indexItem4'><a href='#Results_reference_%24results_ref'>Results reference $results_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#send_image_to_cloud_vision_(%24image_path%2C_%24json_file%2C_%24features_ref%2C_%24gv_logs)'>send_image_to_cloud_vision ($image_path, $json_file, $features_ref, $gv_logs)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24image_path_-_str_path_to_image'>$image_path - str path to image</a>
        <li class='indexItem indexItem4'><a href='#%24json_file_-_str_path_to_the_file_where_we_will_store_OCR_result_as_gzipped_JSON'>$json_file - str path to the file where we will store OCR result as gzipped JSON</a>
        <li class='indexItem indexItem4'><a href='#%24features_ref_-_hash_reference_-_the_%22features%22_parameter_of_Google_Cloud_Vision'>$features_ref - hash reference - the &#34;features&#34; parameter of Google Cloud Vision</a>
        <li class='indexItem indexItem4'><a href='#%24gv_logs_-_file_handle'>$gv_logs - file handle</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Response'>Response</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Images - adds,
processes,
manages and displays product photos</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p><code>ProductOpener::Images</code> is used to: - upload product images - select and crop product images - run OCR on images - display product images</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Product_images_on_disk"
>Product images on disk</a></h1>

<p>Product images are stored in html/images/products/[product barcode split with slashes]/</p>

<p>For each product,
this directory contains:</p>

<dl>
<dt><a name="[image_number].[extension].orig_(e.g._1.jpg.orig,_2.jpg.orig_etc.)"
>[image number].[extension].orig (e.g.
1.jpg.orig,
2.jpg.orig etc.)</a></dt>

<dd>
<p>Original images uploaded by users or imported</p>

<dt><a name="[image_number].jpg"
>[image number].jpg</a></dt>

<dd>
<p>Same image saved as JPEG with specific settings,
and after some minimal processing (auto orientation,
removing EXIF data,
flattening PNG images to remove transparency).</p>

<p>Those images are not displayed on the web site (except on the product edit form),
but can be selected and cropped.</p>

<dt><a name="[image_number].[100|400].jpg"
>[image number].[100|400].jpg</a></dt>

<dd>
<p>Same image saved with a maximum width and height of 100 and 400 pixels.
Those thumbnails are used in the product edit form to show the available images.</p>

<dt><a name="[image_number].json"
>[image number].json</a></dt>

<dd>
<p>OCR output from Google Cloud Vision.</p>

<p>When a new image is uploaded,
a symbolic link to it is created in /new_images.
This triggers a script to generate and save the OCR: <code>run_cloud_vision_ocr.pl</code>.</p>

<dt><a name="[front|ingredients|nutrition|packaging]_[2_letter_language_code].[product_revision].[full|100|200|400].jpg"
>[front|ingredients|nutrition|packaging]_[2 letter language code].[product revision].[full|100|200|400].jpg</a></dt>

<dd>
<p>Cropped and selected image for the front of the product,
the ingredients list,
the nutrition facts table,
and the packaging information / recycling instructions,
in 4 different sizes (full size,
100 / 200 / 400 pixels maximum width or height).</p>

<p>The product revision is a number that is incremented for each change to the product (each image upload and each image selection are also individual changes that create a new revision).</p>

<p>The selected images are shown on the website,
in the app etc.</p>

<p>When a new image is selected for a given field (e.g.
ingredients) and language (e.g.
French),
the existing selected images are kept.
(e.g.
we can have ingredients_fr.21.100.jpg and a new ingredients_fr.28.100.jpg).</p>

<p>Previously selected images are shown only when people access old product revisions.</p>

<p>Cropping coordinates for all revisions are stored in the &#34;images&#34; field of the product,
so we could regenerate old selected and cropped images on demand.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SUPPORTED_IMAGE_TYPES"
>SUPPORTED IMAGE TYPES</a></h1>

<p>gif,
jpeg,
jpf,
png,
heic</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="VALID_IMAGE_TYPES"
>VALID IMAGE TYPES</a></h2>

<p>Depending on the product type,
different image types are allowed.
e.g.
food,
pet food and beauty products have an &#34;ingredients&#34; image type.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_image_type_and_image_lc_from_imagefield_($imagefield)"
>get_image_type_and_image_lc_from_imagefield ($imagefield)</a></h2>

<p>We used to identify selected images with a field called &#34;imagefield&#34; which was of the form [image type]_[language code].
In some very old products revisions (e.g.
from 2012),
we had values with only the image type (e.g.
&#34;front&#34;).</p>

<p>This function splits the field name into its components,
and is used to maintain backward compatibility.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$imagefield_e.g._&#34;front_fr&#34;"
>$imagefield e.g.
&#34;front_fr&#34;</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>$image_type e.g.
&#34;front&#34; $image_lc e.g.
&#34;fr&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_select_crop_($object_ref,_$image_type,_$image_lc,_$language,_$request_ref)_{"
>display_select_crop ($object_ref,
$image_type,
$image_lc,
$language,
$request_ref) {</a></h2>

<p>This function is used in the product edit form to display the select cropper with the images that are already uploaded.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_select_crop_init_($object_ref)"
>display_select_crop_init ($object_ref)</a></h2>

<p>This function is used to generate the code to initialize the select cropper in the product edit form with the images that are already uploaded.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_code_and_imagefield_from_file_name_(_$l_$filename_)"
>get_code_and_imagefield_from_file_name ( $l $filename )</a></h2>

<p>This function is used to guess if an image is the front of the product,
its list of ingredients,
or the nutrition facts table,
based on the filename.</p>

<p>It is used in particular for bulk upload of photos sent by manufacturers.
The file names have many different formats,
but they very often include the barcode of the product,
and sometimes an indication of what the image is.</p>

<p>Producers are advised to use the [front|ingredients|nutrition|packaging]_[language code] format,
but in practice we receive many other names.</p>

<p>The %file_names_to_imagefield_regexps structure below contains some patterns used to guess what the image is about.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="generate_resized_images_($path,_$filename,_$image_source,_$sizes_ref,_@sizes)"
>generate_resized_images ($path,
$filename,
$image_source,
$sizes_ref,
@sizes)</a></h2>

<p>This function generates resized images from the original image.</p>

<p>For uploaded images,
we resize to 100 and 400 pixels maximum width or height.</p>

<p>For selected images,
we resize to 100,
200,
and 400 pixels maximum width or height.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$path"
>$path</a></h4>

<p>The path to the image directory (e.g.
html/images/products/1234567890123/).</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$filename"
>$filename</a></h4>

<p>The name of the image file (without the extension).</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$image_source"
>$image_source</a></h4>

<p>The source image object (Image::Magick).</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$sizes_ref"
>$sizes_ref</a></h4>

<p>A reference to a hash that will be filled with the sizes of the generated images.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="@sizes"
>@sizes</a></h4>

<p>An array of sizes to generate.
The sizes are the maximum width or height of the image.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The function returns the error code from ImageMagick if there was an error writing the image.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_image_upload_(_$product_ref,_$imagefield,_$user_id,_$time,_$comment,_$imgid_ref,_$debug_string_ref_)"
>process_image_upload ( $product_ref,
$imagefield,
$user_id,
$time,
$comment,
$imgid_ref,
$debug_string_ref )</a></h2>

<p>Process an image uploaded to a product (from the web site,
from the API,
or from an import):</p>

<p>- Read the image - Create a JPEG version - Create resized versions - Store the image in the product data</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_ref_$product_ref"
>Product ref $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Image_field_$imagefield"
>Image field $imagefield</a></h4>

<p>Indicates what the image is and its language,
or indicate a path to the image file (for imports and when uploading an image with a barcode)</p>

<p>Format: [front|ingredients|nutrition|packaging|other]_[2 letter language code]</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id_$user_id"
>User id $user_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Timestamp_of_the_image_$time"
>Timestamp of the image $time</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Comment_$comment"
>Comment $comment</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Reference_to_an_image_id_$img_id"
>Reference to an image id $img_id</a></h4>

<p>Used to return the number identifying the image to the caller.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Debug_string_reference_$debug_string_ref"
>Debug string reference $debug_string_ref</a></h4>

<p>Used to return some debug information to the caller.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>-2: imgupload field not set -3: we have already received an image with this file size -4: the image is too small -5: the image file cannot be read by ImageMagick</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>process_image_upload_using_filehandle ($product_ref,
$filehandle,
$user_id,
$time,
$comment,
$imgid_ref,
$debug_string_ref)</a></h2>

<p>This function processes an image uploaded to a product using a file handle.</p>

<p>It is called by:</p>

<p>- the process_image_upload() function above when the image is uploaded with a CGI multipart form data encoded field (product form + API &#60;= v2) - APIProductImagesUpload.pm for API v3</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_ref_$product_ref"
>Product ref $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="File_handle_$filehandle_to_the_image_data"
>File handle $filehandle to the image data</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id_$user_id"
>User id $user_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Timestamp_of_the_image_$time"
>Timestamp of the image $time</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Comment_$comment"
>Comment $comment</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Reference_to_an_image_id_$imgid_ref"
>Reference to an image id $imgid_ref</a></h4>

<p>Used to return the number identifying the image to the caller.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Debug_string_reference_$debug_string_ref"
>Debug string reference $debug_string_ref</a></h4>

<p>Used to return some debug information to the caller.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>-2: imgupload field not set -3: we have already received an image with this file size -4: the image is too small -5: the image file cannot be read by ImageMagick</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="remove_images_by_prefix_(_$product_ref,_$prefix_)"
>remove_images_by_prefix ( $product_ref,
$prefix )</a></h2>

<p>This function removes images files from a product by a given prefix (matching uploaded images or selected images).
The image files are moved to a deleted directory.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>A reference to the product data structure.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$prefix"
>$prefix</a></h4>

<p>The prefix of the images to be removed.</p>

<p>For uploaded images,
the prefix is the imgid.</p>

<p>For selected images,
the prefix is the image type and language code + the product revision.
e.g.
&#34;ingredients_en.5&#34; or &#34;nutrition_fr.6&#34;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_uploaded_image_and_associated_selected_images_(_$product_ref,_$imgid_)"
>delete_uploaded_image_and_associated_selected_images ( $product_ref,
$imgid )</a></h2>

<p>This function deletes an uploaded image and its associated selected images.</p>

<p>Note: the corresponding product is not saved by this function,
it should be saved by the caller.
We do not save it in this function so that we can delete multiple images and save the updated product only once.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>A reference to the product data structure.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$imgid"
>$imgid</a></h4>

<p>The image id to be deleted.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1: success -1: image not found</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_image_move_(_$user_id,_$code,_$imgids,_$move_to,_$ownerid_)"
>process_image_move ( $user_id,
$code,
$imgids,
$move_to,
$ownerid )</a></h2>

<p>This function moves images from one product to another,
or to the trash.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<p>The user id of the person moving the image.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$code"
>$code</a></h4>

<p>The code of the product from which the image is moved.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$imgids"
>$imgids</a></h4>

<p>The image ids to be moved,
in a comma-separated list.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$move_to"
>$move_to</a></h4>

<p>The product code to which the image is moved,
or &#39;trash&#39; if the image is deleted.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ownerid"
>$ownerid</a></h4>

<p>The owner id of the product from which the image is moved.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The function returns an error message if there was an error,
or undef if the operation was successful.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="same_image_generation_parameters_(_$generation_1_ref,_$generation_2_ref_)"
>same_image_generation_parameters ( $generation_1_ref,
$generation_2_ref )</a></h2>

<p>This function checks if the image generation parameters are the same for two images.</p>

<p>It is useful to avoid selecting the same image with the same parameters twice.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$generation_1_ref"
>$generation_1_ref</a></h4>

<p>A reference to the first image generation parameters.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$generation_2_ref"
>$generation_2_ref</a></h4>

<p>A reference to the second image generation parameters.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1: the image generation parameters are the same</p>

<p>0: the image generation parameters are different</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_generation_ref_(_$generation_ref_)"
>normalize_generation_ref ( $generation_ref )</a></h2>

<p>This function normalizes the generation_ref so that we store only useful values.</p>

<p>- If the image is not rotated,
we don&#39;t store the angle.
- If the image is not cropped,
we don&#39;t store the coordinates.
- If the image is not normalized,
we don&#39;t store the normalize value.
- If the image is not processed white magic,
we don&#39;t store the white magic value.</p>

<p>If generation_ref is empty,
we return an undef value</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$generation_ref"
>$generation_ref</a></h4>

<p>A reference to the image generation parameters.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>A reference to the normalized generation_ref.</p>

<p>Or undef if the generation_ref is empty.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>process_image_crop ( $user_id,
$product_ref,
$image_type,
$image_lc,
$imgid,
$angle,
$normalize,
$white_magic,
$x1,
$y1,
$x2,
$y2,
$coordinates_image_size )</a></h2>

<p>Select and possibly crop an uploaded image to represent the front,
ingredients,
nutrition or packaging image in a specific language.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h2>

<pre> 1: crop done
-1: image not found
-2: image cannot be read</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_image_url_($product_ref,_$image_ref,_$size)"
>get_image_url ($product_ref, $image_ref, $size)</a></h2>

<p>Return the URL of the image in the requested size.</p>

<p>Note: $image_ref in selected.images.[image type].[image code] does not contain the id field with the image type and language code (which are keys) It must be added to the image_ref before calling this function.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_image_in_best_language_($product_ref,_$image_type,_$target_lc)"
>get_image_in_best_language ($product_ref, $image_type, $target_lc)</a></h2>

<p>We return the image object in the best language available for the image type, in the order of preference: - $target_lc - main language of the product - English - any other available language (if any), in alphabetical order</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>- $product_ref: the product reference - $image_type: the image type (front, ingredients, nutrition, packaging) - $target_lc: the target language code - $image_lc_ref: a reference to return the language code of the image (optional)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- the image reference in the best language available, with an added &#34;id&#34; field containing the image type and language code (e.g. &#34;front_en&#34;)</p>

<p>The language code of the best language is set in $image_lc_ref (if provided)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_images_urls_to_product_($product_ref,_$target_lc,_$specific_image_type_=_undef)"
>add_images_urls_to_product ($product_ref, $target_lc, $specific_image_type = undef)</a></h2>

<p>Add fields like image_[front|ingredients|nutrition|packaging]_[url|small_url|thumb_url] to a product object.</p>

<p>If it exists, the image for the target language will be returned, otherwise we will return the image in the main language of the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to a complete product a subfield.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$target_lc"
>$target_lc</a></h4>

<p>2 language code of the preferred language for the product images.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$specific_image_type"
>$specific_image_type</a></h4>

<p>Optional parameter to specify the type of image to add. Default is to add all types.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="data_to_display_image_(_$product_ref,_$image_type,_$target_lc_)"
>data_to_display_image ( $product_ref, $image_type, $target_lc )</a></h2>

<p>Generates a data structure to display a product image.</p>

<p>The resulting data structure can be passed to a template to generate HTML or the JSON data for a knowledge panel.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Image_type_$image_type:_one_of_[front|ingredients|nutrition|packaging]"
>Image type $image_type: one of [front|ingredients|nutrition|packaging]</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language_code_$target_lc"
>Language code $target_lc</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- Reference to a data structure with needed data to display. - undef if no image is available for the requested image type</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="display_image_(_$product_ref,_$image_type,_$target_lc,_$size_)"
>display_image ( $product_ref, $image_type, $target_lc, $size )</a></h2>

<p>Generate the HTML code to display a product image.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Image_type_$image_type:_one_of_[front|ingredients|nutrition|packaging]"
>Image type $image_type: one of [front|ingredients|nutrition|packaging]</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Language_code_$target_lc"
>Language code $target_lc</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Size_$size:_one_of_$thumb_size,_$small_size,_$display_size"
>Size $size: one of $thumb_size, $small_size, $display_size</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- HTML code to display the image</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="select_ocr_engine_($requested_ocr_engine)"
>select_ocr_engine ($requested_ocr_engine)</a></h2>

<p>Select the OCR engine to use based on the requested OCR engine and the available engines.</p>

<p>If the requested OCR engine is not available, we return the first available one.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$requested_ocr_engine"
>$requested_ocr_engine</a></h4>

<p>Either &#39;tesseract&#39; or &#39;google_cloud_vision&#39;.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- &#39;google_cloud_vision&#39; if Google Cloud Vision API key is available - &#39;tesseract&#39; if Tesseract OCR is available - undef if no OCR engine is available</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extract_text_from_image(_$product_ref,_$id,_$field,_$ocr_engine,_$results_ref_)"
>extract_text_from_image( $product_ref, $id, $field, $ocr_engine, $results_ref )</a></h2>

<p>Perform OCR for a specific image (either a source image, or a selected image) and return the results.</p>

<p>OCR can be performed with a locally installed Tesseract, or through Google Cloud Vision.</p>

<p>In the case of Google Cloud Vision, we also store the results of the OCR as a JSON file (requested through HTTP by Robotoff).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_reference_$product_ref"
>product reference $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="id_of_the_image_$id"
>id of the image $id</a></h4>

<p>Either a number like 1, 2 etc. to perform the OCR on a source image (1.jpg, 2.jpg) or a field name in the form of [front|ingredients|nutrition|packaging]_[2 letter language code].</p>

<p>If $id is a field name, the last selected image for that field is used.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="field_name_$field"
>field name $field</a></h4>

<p>Field to update in the product object. e.g. ingredients_text_from_image, nutrition_text_from_image, packaging_text_from_image</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Requested_OCR_engine_$requested_ocr_engine"
>Requested OCR engine $requested_ocr_engine</a></h4>

<p>Either &#34;tesseract&#34; or &#34;google_cloud_vision&#34;. Note: if the requested OCR engine is not available, we will select the first available one.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Results_reference_$results_ref"
>Results reference $results_ref</a></h4>

<p>A hash reference to store the results.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="send_image_to_cloud_vision_($image_path,_$json_file,_$features_ref,_$gv_logs)"
>send_image_to_cloud_vision ($image_path, $json_file, $features_ref, $gv_logs)</a></h2>

<p>Call to Google Cloud vision API</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$image_path_-_str_path_to_image"
>$image_path - str path to image</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$json_file_-_str_path_to_the_file_where_we_will_store_OCR_result_as_gzipped_JSON"
>$json_file - str path to the file where we will store OCR result as gzipped JSON</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$features_ref_-_hash_reference_-_the_&#34;features&#34;_parameter_of_Google_Cloud_Vision"
>$features_ref - hash reference - the &#34;features&#34; parameter of Google Cloud Vision</a></h4>

<p>This determine which detection will be performed. Remember each feature is a cost.</p>

<p><code>@CLOUD_VISION_FEATURES_FULL</code> and <code>@CLOUD_VISION_FEATURES_TEXT</code> are two constant you can use.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$gv_logs_-_file_handle"
>$gv_logs - file handle</a></h4>

<p>A file where we write additional logs, specific to the service.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Response"
>Response</a></h3>

<p>Return JSON content of the response.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
