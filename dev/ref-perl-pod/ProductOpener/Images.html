<html><head><title>ProductOpener::Images</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Nov  7 09:51:14 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#Product_images_on_disk'>Product images on disk</a>
  <li class='indexItem indexItem1'><a href='#SUPPORTED_IMAGE_TYPES'>SUPPORTED IMAGE TYPES</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#get_code_and_imagefield_from_file_name_(_%24l_%24filename_)'>get_code_and_imagefield_from_file_name ( $l $filename )</a>
    <li class='indexItem indexItem2'><a href='#process_image_upload_(_%24product_id%2C_%24imagefield%2C_%24user_id%2C_%24time%2C_%24comment%2C_%24imgid_ref%2C_%24debug_string_ref_)'>process_image_upload ( $product_id, $imagefield, $user_id, $time, $comment, $imgid_ref, $debug_string_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_id_%24product_id'>Product id $product_id</a>
        <li class='indexItem indexItem4'><a href='#Image_field_%24imagefield'>Image field $imagefield</a>
        <li class='indexItem indexItem4'><a href='#User_id_%24user_id'>User id $user_id</a>
        <li class='indexItem indexItem4'><a href='#Timestamp_of_the_image_%24time'>Timestamp of the image $time</a>
        <li class='indexItem indexItem4'><a href='#Comment_%24comment'>Comment $comment</a>
        <li class='indexItem indexItem4'><a href='#Reference_to_an_image_id_%24img_id'>Reference to an image id $img_id</a>
        <li class='indexItem indexItem4'><a href='#Debug_string_reference_%24debug_string_ref'>Debug string reference $debug_string_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#extract_text_from_image(_%24product_ref%2C_%24id%2C_%24field%2C_%24ocr_engine%2C_%24results_ref_)'>extract_text_from_image( $product_ref, $id, $field, $ocr_engine, $results_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#product_reference_%24product_ref'>product reference $product_ref</a>
        <li class='indexItem indexItem4'><a href='#id_of_the_image_%24id'>id of the image $id</a>
        <li class='indexItem indexItem4'><a href='#OCR_engine_%24ocr_engine'>OCR engine $ocr_engine</a>
        <li class='indexItem indexItem4'><a href='#Results_reference_%24results_ref'>Results reference $results_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#send_image_to_cloud_vision_(%24image_path%2C_%24json_file%2C_%24features_ref%2C_%24gv_logs)'>send_image_to_cloud_vision ($image_path, $json_file, $features_ref, $gv_logs)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24image_path_-_str_path_to_image'>$image_path - str path to image</a>
        <li class='indexItem indexItem4'><a href='#%24json_file_-_str_path_to_the_file_where_we_will_store_OCR_result_as_gzipped_JSON'>$json_file - str path to the file where we will store OCR result as gzipped JSON</a>
        <li class='indexItem indexItem4'><a href='#%24features_ref_-_hash_reference_-_the_%22features%22_parameter_of_Google_Cloud_Vision'>$features_ref - hash reference - the &#34;features&#34; parameter of Google Cloud Vision</a>
        <li class='indexItem indexItem4'><a href='#%24gv_logs_-_file_handle'>$gv_logs - file handle</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Response'>Response</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#send_image_to_robotoff_(%24code%2C_%24image_url%2C_%24json_url%2C_%24api_server_domain)'>send_image_to_robotoff ($code, $image_url, $json_url, $api_server_domain)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24code_-_product_code'>$code - product code</a>
        <li class='indexItem indexItem4'><a href='#%24image_url_-_public_url_of_the_image'>$image_url - public url of the image</a>
        <li class='indexItem indexItem4'><a href='#%24json_url_-_public_url_of_OCR_result_as_JSON'>$json_url - public url of OCR result as JSON</a>
        <li class='indexItem indexItem4'><a href='#%24api_server_domain_-_the_API_url_for_this_product_opener_instance'>$api_server_domain - the API url for this product opener instance</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Response'>Response</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Images - adds,
processes,
manages and displays product photos</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p><code>ProductOpener::Images</code> is used to: - upload product images - select and crop product images - run OCR on images - display product images</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Product_images_on_disk"
>Product images on disk</a></h1>

<p>Product images are stored in html/images/products/[product barcode split with slashes]/</p>

<p>For each product,
this directory contains:</p>

<dl>
<dt><a name="[image_number].[extension].orig_(e.g._1.jpg.orig,_2.jpg.orig_etc.)"
>[image number].[extension].orig (e.g.
1.jpg.orig,
2.jpg.orig etc.)</a></dt>

<dd>
<p>Original images uploaded by users or imported</p>

<dt><a name="[image_number].jpg"
>[image number].jpg</a></dt>

<dd>
<p>Same image saved as JPEG with specific settings,
and after some minimal processing (auto orientation,
removing EXIF data,
flattening PNG images to remove transparency).</p>

<p>Those images are not displayed on the web site (except on the product edit form),
but can be selected and cropped.</p>

<dt><a name="[image_number].[100|400].jpg"
>[image number].[100|400].jpg</a></dt>

<dd>
<p>Same image saved with a maximum width and height of 100 and 400 pixels.
Those thumbnails are used in the product edit form to show the available images.</p>

<dt><a name="[image_number].json"
>[image number].json</a></dt>

<dd>
<p>OCR output from Google Cloud Vision.</p>

<p>When a new image is uploaded,
a symbolic link to it is created in /new_images.
This triggers a script to generate and save the OCR: <code>run_cloud_vision_ocr.pl</code>.</p>

<dt><a name="[front|ingredients|nutrition|packaging]_[2_letter_language_code].[product_revision].[full|100|200|400].jpg"
>[front|ingredients|nutrition|packaging]_[2 letter language code].[product revision].[full|100|200|400].jpg</a></dt>

<dd>
<p>Cropped and selected image for the front of the product,
the ingredients list,
the nutrition facts table,
and the packaging information / recycling instructions,
in 4 different sizes (full size,
100 / 200 / 400 pixels maximum width or height).</p>

<p>The product revision is a number that is incremented for each change to the product (each image upload and each image selection are also individual changes that create a new revision).</p>

<p>The selected images are shown on the website,
in the app etc.</p>

<p>When a new image is selected for a given field (e.g.
ingredients) and language (e.g.
French),
the existing selected images are kept.
(e.g.
we can have ingredients_fr.21.100.jpg and a new ingredients_fr.28.100.jpg).</p>

<p>Previously selected images are shown only when people access old product revisions.</p>

<p>Cropping coordinates for all revisions are stored in the &#34;images&#34; field of the product,
so we could regenerate old selected and cropped images on demand.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SUPPORTED_IMAGE_TYPES"
>SUPPORTED IMAGE TYPES</a></h1>

<p>gif,
jpeg,
jpf,
png,
heic</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_code_and_imagefield_from_file_name_(_$l_$filename_)"
>get_code_and_imagefield_from_file_name ( $l $filename )</a></h2>

<p>This function is used to guess if an image is the front of the product,
its list of ingredients,
or the nutrition facts table,
based on the filename.</p>

<p>It is used in particular for bulk upload of photos sent by manufacturers.
The file names have many different formats,
but they very often include the barcode of the product,
and sometimes an indication of what the image is.</p>

<p>Producers are advised to use the [front|ingredients|nutrition|packaging]_[language code] format,
but in practice we receive many other names.</p>

<p>The %file_names_to_imagefield_regexps structure below contains some patterns used to guess what the image is about.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_image_upload_(_$product_id,_$imagefield,_$user_id,_$time,_$comment,_$imgid_ref,_$debug_string_ref_)"
>process_image_upload ( $product_id,
$imagefield,
$user_id,
$time,
$comment,
$imgid_ref,
$debug_string_ref )</a></h2>

<p>Process an image uploaded to a product (from the web site,
from the API,
or from an import):</p>

<p>- Read the image - Create a JPEG version - Create resized versions - Store the image in the product data</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_id_$product_id"
>Product id $product_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Image_field_$imagefield"
>Image field $imagefield</a></h4>

<p>Indicates what the image is and its language,
or indicate a path to the image file (for imports and when uploading an image with a barcode)</p>

<p>Format: [front|ingredients|nutrition|packaging|other]_[2 letter language code]</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id_$user_id"
>User id $user_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Timestamp_of_the_image_$time"
>Timestamp of the image $time</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Comment_$comment"
>Comment $comment</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Reference_to_an_image_id_$img_id"
>Reference to an image id $img_id</a></h4>

<p>Used to return the number identifying the image to the caller.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Debug_string_reference_$debug_string_ref"
>Debug string reference $debug_string_ref</a></h4>

<p>Used to return some debug information to the caller.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="extract_text_from_image(_$product_ref,_$id,_$field,_$ocr_engine,_$results_ref_)"
>extract_text_from_image( $product_ref,
$id,
$field,
$ocr_engine,
$results_ref )</a></h2>

<p>Perform OCR for a specific image (either a source image,
or a selected image) and return the results.</p>

<p>OCR can be performed with a locally installed Tesseract,
or through Google Cloud Vision.</p>

<p>In the case of Google Cloud Vision,
we also store the results of the OCR as a JSON file (requested through HTTP by Robotoff).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="product_reference_$product_ref"
>product reference $product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="id_of_the_image_$id"
>id of the image $id</a></h4>

<p>Either a number like 1,
2 etc.
to perform the OCR on a source image (1.jpg,
2.jpg) or a field name in the form of [front|ingredients|nutrition|packaging]_[2 letter language code].</p>

<p>If $id is a field name,
the last selected image for that field is used.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="OCR_engine_$ocr_engine"
>OCR engine $ocr_engine</a></h4>

<p>Either &#34;tesseract&#34; or &#34;google_cloud_vision&#34;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Results_reference_$results_ref"
>Results reference $results_ref</a></h4>

<p>A hash reference to store the results.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="send_image_to_cloud_vision_($image_path,_$json_file,_$features_ref,_$gv_logs)"
>send_image_to_cloud_vision ($image_path,
$json_file,
$features_ref,
$gv_logs)</a></h2>

<p>Call to Google Cloud vision API</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$image_path_-_str_path_to_image"
>$image_path - str path to image</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$json_file_-_str_path_to_the_file_where_we_will_store_OCR_result_as_gzipped_JSON"
>$json_file - str path to the file where we will store OCR result as gzipped JSON</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$features_ref_-_hash_reference_-_the_&#34;features&#34;_parameter_of_Google_Cloud_Vision"
>$features_ref - hash reference - the &#34;features&#34; parameter of Google Cloud Vision</a></h4>

<p>This determine which detection will be performed.
Remember each feature is a cost.</p>

<p><code>@CLOUD_VISION_FEATURES_FULL</code> and <code>@CLOUD_VISION_FEATURES_TEXT</code> are two constant you can use.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$gv_logs_-_file_handle"
>$gv_logs - file handle</a></h4>

<p>A file where we write additional logs,
specific to the service.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Response"
>Response</a></h3>

<p>Return JSON content of the response.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="send_image_to_robotoff_($code,_$image_url,_$json_url,_$api_server_domain)"
>send_image_to_robotoff ($code,
$image_url,
$json_url,
$api_server_domain)</a></h2>

<p>Send a notification about a new image (already gone through OCR) to Robotoff</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$code_-_product_code"
>$code - product code</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$image_url_-_public_url_of_the_image"
>$image_url - public url of the image</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$json_url_-_public_url_of_OCR_result_as_JSON"
>$json_url - public url of OCR result as JSON</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$api_server_domain_-_the_API_url_for_this_product_opener_instance"
>$api_server_domain - the API url for this product opener instance</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Response"
>Response</a></h3>

<p>Return Robotoff HTTP::Response object.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
