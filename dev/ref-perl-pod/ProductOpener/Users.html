<html><head><title>ProductOpener::Users</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Nov 28 08:53:34 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#generate_token()'>generate_token()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#create_password_hash(%24password)'>create_password_hash($password)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#check_password_hash_(%24password%2C_%24hash)'>check_password_hash ($password, $hash)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#delete_user_(%24user_ref)'>delete_user ($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#delete_user_task_(%24job%2C_%24args_ref)'>delete_user_task ($job, $args_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#is_admin_user()'>is_admin_user()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#check_user_org(%24user_ref%2C_%24new_org)'>check_user_org($user_ref, $new_org)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#String_new_org_name_%24new_org'>String new org name $new_org</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#check_user_form(%24type%2C_%24user_ref%2C_%24errors_ref)'>check_user_form($type, $user_ref, $errors_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#String_action_type_%24type_edit_%2F_add_%2F_delete'>String action type $type edit / add / delete</a>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#Array_to_report_errors_%24errors_ref'>Array to report errors $errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#notify_user_requested_org(%24user_ref%2C_%24org_created)'>notify_user_requested_org($user_ref, $org_created)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#boolean_%24org_created'>boolean $org_created</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_user_requested_org(%24user_ref)'>process_user_requested_org($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_user_form(%24type%2C_%24user_ref%2C_%24request_ref)'>process_user_form($type, $user_ref, $request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#String_action_type_%24type_edit_%2F_add_%2F_delete'>String action type $type edit / add / delete</a>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#Request_object_%24request_ref'>Request object $request_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#check_edit_owner(%24user_ref%2C_%24errors_ref)'>check_edit_owner($user_ref, $errors_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#array_to_collect_errors_%24errors_ref'>array to collect errors $errors_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#migrate_password_hash(%24user_ref)'>migrate_password_hash($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#remove_old_sessions(%24user_ref)'>remove_old_sessions($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#generate_session_cookie(%24user_id%2C_%24user_session)'>generate_session_cookie($user_id, $user_session)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_id_%24user_id'>User id $user_id</a>
        <li class='indexItem indexItem4'><a href='#Session_token_%24user_session'>Session token $user_session</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#open_user_session(%24user_ref%2C_%24request_ref)'>open_user_session($user_ref, $request_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_object_%24user_ref'>User object $user_ref</a>
        <li class='indexItem indexItem4'><a href='#Request_object_%24request_ref'>Request object $request_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#is_ip_known_or_whitelisted_()'>is_ip_known_or_whitelisted ()</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Users - manage user profiles and sessions</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Users</code> contains functions to create and edit user profiles and to manage user sessions.</p>

<pre>    use ProductOpener::Users qw/:all/;

        [..]

        init_user($request_ref);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>[..]</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="generate_token()"
>generate_token()</a></h2>

<p><code>generate_token()</code> generates a secure token for the session IDs. More information: https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html#Session_ID_Content_.28or_Value.29</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Creates a new session ID</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_password_hash($password)"
>create_password_hash($password)</a></h2>

<p>Takes $password and hashes it using scrypt</p>

<p><code>create_password_hash()</code> This function hashes the user&#39;s password using Scrypt which is a salted hashing algorithm. Password salting adds a random sequence of data to each password and then hashes it. Password hashing is turning a password into a random string by using some algorithm.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>$password : String</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Returns the salted hashed sequence.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_password_hash_($password,_$hash)"
>check_password_hash ($password, $hash)</a></h2>

<p>Turns $password into hash using md5 or scrypt and compares it to $hash.</p>

<p><code>check_password_hash()</code> This function takes the hash generated by create_password_hash() and the input password string. Further, it hashes the input password string md5 or scrypt and verifies if it matches with stored password hash. If the stored hash matches the input-password hash, it returns 1. Otherwise, it&#39;s a 0.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Takes in 2 string: $password and $hash generated by create_password_hash()</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Boolean: This function returns a 1/0 (True or False)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_user_($user_ref)"
>delete_user ($user_ref)</a></h2>

<p><code>delete_user()</code> Creates a background job to delete the user</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Takes in the $user_ref of the user to be deleted</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_user_task_($job,_$args_ref)"
>delete_user_task ($job, $args_ref)</a></h2>

<p><code>delete_user_task()</code> Background task that deletes a user. This function removes the user files, the email and re-assigns product edits to openfoodfacts-contributors-[random number]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Minion job arguments. $args_ref contains the userid and email</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_admin_user()"
>is_admin_user()</a></h2>

<p>Checks if the user with the passed user ID is an admin or not.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>The user ID is passed</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Boolean: This function returns a 1/0 (True or False)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_user_org($user_ref,_$new_org)"
>check_user_org($user_ref, $new_org)</a></h2>

<p>This method checks a new org entry for a user.</p>

<p>warning: It has the side effect of already listing user in the org, and removing it from eventual previous one. If new_org is empty, user is removed from previous org.</p>

<p>It also creates the org if did not yet exists.</p>

<p>It should be called only by admin.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="String_new_org_name_$new_org"
>String new org name $new_org</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_user_form($type,_$user_ref,_$errors_ref)"
>check_user_form($type, $user_ref, $errors_ref)</a></h2>

<p><code>check_user_form()</code> This method checks and validates the different entries in the user form. It also handles Spam-usernames, fields for the organization accounts.</p>

<p>This will then be used in process_user_form</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="String_action_type_$type_edit_/_add_/_delete"
>String action type $type edit / add / delete</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Array_to_report_errors_$errors_ref"
>Array to report errors $errors_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="notify_user_requested_org($user_ref,_$org_created)"
>notify_user_requested_org($user_ref, $org_created)</a></h2>

<p>Notify admin that a user requested to be part of an org</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="boolean_$org_created"
>boolean $org_created</a></h4>

<p>Is the org newly created ?</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_user_requested_org($user_ref)"
>process_user_requested_org($user_ref)</a></h2>

<p>A user requested to be part of a producer organization. Process it.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_user_form($type,_$user_ref,_$request_ref)"
>process_user_form($type, $user_ref, $request_ref)</a></h2>

<p>Process user form.</p>

<p>To be used after check_user_form</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="String_action_type_$type_edit_/_add_/_delete"
>String action type $type edit / add / delete</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Request_object_$request_ref"
>Request object $request_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_edit_owner($user_ref,_$errors_ref)"
>check_edit_owner($user_ref, $errors_ref)</a></h2>

<p>This sets pro_moderator_owner according to request parameter. Sets it in $User global and $user_ref.</p>

<p>This variable is used to say that a moderator or admin is acting on the pro platform as part of a specific company.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="array_to_collect_errors_$errors_ref"
>array to collect errors $errors_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="migrate_password_hash($user_ref)"
>migrate_password_hash($user_ref)</a></h2>

<p>We used to use crypt instead of scrypt to store hashed passwords. If the user is logging in with a correct password, we can update the password hash.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="remove_old_sessions($user_ref)"
>remove_old_sessions($user_ref)</a></h2>

<p>Remove the oldest session if we have too many sessions opened for an user.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="generate_session_cookie($user_id,_$user_session)"
>generate_session_cookie($user_id, $user_session)</a></h2>

<p>Generate a session cookie.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id_$user_id"
>User id $user_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Session_token_$user_session"
>Session token $user_session</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Session cookie.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="open_user_session($user_ref,_$request_ref)"
>open_user_session($user_ref, $request_ref)</a></h2>

<p>Open a session, store it in the user object, and return a cookie with the session id in the request object.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_object_$user_ref"
>User object $user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Request_object_$request_ref"
>Request object $request_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The cookie is returned in $request_ref</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_ip_known_or_whitelisted_()"
>is_ip_known_or_whitelisted ()</a></h2>

<p>This sub introduces a server option to whitelist IPs for all cookies.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
