<html><head><title>ProductOpener::Data</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Dec 12 10:16:53 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#execute_query(_%24subroutine_)'>execute_query( $subroutine )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#subroutine_%24sub'>subroutine $sub</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
      <li class='indexItem indexItem3'><a href='#Synopsis'>Synopsis</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_products_collection(_%24parameters_ref_)'>get_products_collection( $parameters_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#database_MongoDB_database_name'>database MongoDB database name</a>
        <li class='indexItem indexItem4'><a href='#timeout_User_defined_timeout_in_milliseconds'>timeout User defined timeout in milliseconds</a>
        <li class='indexItem indexItem4'><a href='#obsolete'>obsolete</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_mongodb_client()'>get_mongodb_client()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#remove_documents_by_ids(%24ids_to_remove_ref%2C_%24coll%2C_%24bulk_write_size%3D100)'>remove_documents_by_ids($ids_to_remove_ref, $coll, $bulk_write_size=100)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24ids_to_remove_ref_-_ref_to_list_of_ids_to_remove'>$ids_to_remove_ref - ref to list of ids to remove</a>
        <li class='indexItem indexItem4'><a href='#%24coll_-_a_document_collection'>$coll - a document collection</a>
        <li class='indexItem indexItem4'><a href='#%24bulk_size_-_how_many_concurrent_deletion_in_a_bulk'>$bulk_size - how many concurrent deletion in a bulk</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Data - methods to create or get the mongoDB client and fetch &#34;data collections&#34; from the MongoDB database;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The module implements the methods required to fetch certain collections from the MongoDB database.
The functions used in this module are responsible for executing queries,
to get connection to database and also to select the collection required.</p>

<p>The products collection contains a complete document for each product in the OpenFoodFacts database which exposes all available information about the product.</p>

<p>Obsolete products that have been withdrawn from the market have separate collections: products_obsolete</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="execute_query(_$subroutine_)"
>execute_query( $subroutine )</a></h2>

<p><code>execute_query()</code> executes a query on the database.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="subroutine_$sub"
>subroutine $sub</a></h4>

<p>A query subroutine that performs a query against the database.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>The function returns the return value of the query subroutine $sub passed as a parameter to it.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Synopsis"
>Synopsis</a></h3>

<p>eval { $result = execute_query(sub { return get_products_collection()-&#62;query({})-&#62;sort({code =&#62; 1}); }); }</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_products_collection(_$parameters_ref_)"
>get_products_collection( $parameters_ref )</a></h2>

<p><code>get_products_collection()</code> establishes a connection to MongoDB and uses timeout as an argument.
This then selects a collection from within the database.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>This method takes parameters in an optional hash reference with the following keys:</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="database_MongoDB_database_name"
>database MongoDB database name</a></h4>

<p>Defaults to $ProductOpener::Config::mongodb</p>

<p>This is useful when moving products to another flavour (e.g.
from Open Food Facts (database: off) to Open Beauty Facts (database: obf))</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="timeout_User_defined_timeout_in_milliseconds"
>timeout User defined timeout in milliseconds</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="obsolete"
>obsolete</a></h4>

<p>If set to a true value,
the function returns a collection that contains only obsolete products,
otherwise it returns the collection with products that are not obsolete.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Returns a mongoDB collection object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_mongodb_client()"
>get_mongodb_client()</a></h2>

<p><code>get_mongodb_client()</code> gets the MongoDB client.
It first checks if the client already exists and if not,
it creates and configures a new MongoDB::MongoClient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>This method takes in arguments of integer type (user defined timeout in milliseconds).
It is optional for this subroutine to have an argument.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Returns $client of type MongoDB::MongoClient object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="remove_documents_by_ids($ids_to_remove_ref,_$coll,_$bulk_write_size=100)"
>remove_documents_by_ids($ids_to_remove_ref,
$coll,
$bulk_write_size=100)</a></h2>

<p>Efficiently removes a set of documents</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$ids_to_remove_ref_-_ref_to_list_of_ids_to_remove"
>$ids_to_remove_ref - ref to list of ids to remove</a></h4>

<p>correspond to the _id field</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$coll_-_a_document_collection"
>$coll - a document collection</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$bulk_size_-_how_many_concurrent_deletion_in_a_bulk"
>$bulk_size - how many concurrent deletion in a bulk</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Returns a hash with: &#60;dl&#62; &#60;dt&#62;removed&#60;/dt&#62; &#60;dd&#62;int - number of effectively removed items&#60;/dd&#62; &#60;dt&#62;errors&#60;/dt&#62; &#60;dd&#62;ref to a list of errors&#60;/dd&#62; &#60;/dl&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
