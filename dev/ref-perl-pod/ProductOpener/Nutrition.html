<html><head><title>ProductOpener::Nutrition</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Mon Feb 23 15:15:43 2026 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#add_computed_values_to_nutrient_sets_(%24input_sets_ref)'>add_computed_values_to_nutrient_sets ($input_sets_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_sets_ref'>$input_sets_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#generate_nutrient_aggregated_set'>generate_nutrient_aggregated_set</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#generate_nutrient_aggregated_set_from_sets'>generate_nutrient_aggregated_set_from_sets</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_sets_ref'>$input_sets_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#sort_sets_by_priority'>sort_sets_by_priority</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_sets_ref'>$input_sets_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_non_estimated_nutrient_per_100g_or_100ml_for_preparation_(%24product_ref%2C_%24preparation%2C_%24nid)'>get_non_estimated_nutrient_per_100g_or_100ml_for_preparation ($product_ref, $preparation, $nid)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24preparation'>$preparation</a>
        <li class='indexItem indexItem4'><a href='#%24nid_of_the_nutrient_to_get'>$nid of the nutrient to get</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#set_nutrient_values'>set_nutrient_values</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24aggregated_nutrient_set_ref'>$aggregated_nutrient_set_ref</a>
        <li class='indexItem indexItem4'><a href='#%40input_sets'>@input_sets</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#convert_nutrient_to_standard_unit'>convert_nutrient_to_standard_unit</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24nutrient_ref'>$nutrient_ref</a>
        <li class='indexItem indexItem4'><a href='#%24nutrient_id'>$nutrient_id</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#convert_nutrient_to_100g'>convert_nutrient_to_100g</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24nutrient_ref'>$nutrient_ref</a>
        <li class='indexItem indexItem4'><a href='#%24original_per_quantity'>$original_per_quantity</a>
        <li class='indexItem indexItem4'><a href='#%24original_per_unit'>$original_per_unit</a>
        <li class='indexItem indexItem4'><a href='#%24wanted_per_quantity'>$wanted_per_quantity</a>
        <li class='indexItem indexItem4'><a href='#%24wanted_per_unit'>$wanted_per_unit</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_specific_nutrition_input_set_(%24product_ref%2C_%24source%2C_%24preparation%2C_%24per)'>get_specific_nutrition_input_set ($product_ref, $source, $preparation, $per)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24source'>$source</a>
        <li class='indexItem indexItem4'><a href='#%24preparation'>$preparation</a>
        <li class='indexItem indexItem4'><a href='#%24per'>$per</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#set_per_quantity_and_unit(%24product_ref%2C_%24input_set_ref)'>set_per_quantity_and_unit($product_ref, $input_set_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref_-_product'>$product_ref - product</a>
        <li class='indexItem indexItem4'><a href='#%24input_set_ref_-_nutrient_input_set'>$input_set_ref - nutrient input set</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_nutrition_input_sets_in_a_hash_(%24product_ref)'>get_nutrition_input_sets_in_a_hash ($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#convert_nutrition_input_sets_hash_to_array_(%24input_sets_hash_ref%2C_%24product_ref)'>convert_nutrition_input_sets_hash_to_array ($input_sets_hash_ref, $product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_sets_hash_ref'>$input_sets_hash_ref</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_source_for_site_and_org_(_%24org_id_%3D_undef_)'>get_source_for_site_and_org ( $org_id = undef )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_id'>$org_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_preparations_for_product_type'>get_preparations_for_product_type</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_type'>$product_type</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_pers_for_product_type'>get_pers_for_product_type</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_type'>$product_type</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_unit_options_for_nutrient_(%24nid)'>get_unit_options_for_nutrient ($nid)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24nid'>$nid</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_nutrient_value_string_and_modifier_(_%24value_ref%2C_%24modifier_ref_)'>normalize_nutrient_value_string_and_modifier ( $value_ref, $modifier_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#string_value_reference_%24value_ref'>string value reference $value_ref</a>
        <li class='indexItem indexItem4'><a href='#modifier_reference_%24modifier_ref'>modifier reference $modifier_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Possible_return_values'>Possible return values</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#value'>value</a>
        <li class='indexItem indexItem4'><a href='#modifier'>modifier</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_sets_hash_ref'>$input_sets_hash_ref</a>
        <li class='indexItem indexItem4'><a href='#%24source'>$source</a>
        <li class='indexItem indexItem4'><a href='#%24preparation'>$preparation</a>
        <li class='indexItem indexItem4'><a href='#%24per'>$per</a>
        <li class='indexItem indexItem4'><a href='#%24nid'>$nid</a>
        <li class='indexItem indexItem4'><a href='#value_string'>value_string</a>
        <li class='indexItem indexItem4'><a href='#unit'>unit</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#assign_nutrition_values_from_old_request_parameters_(_%24request_ref%2C_%24product_ref%2C_%24nutrient_table%2C_%24source_)'>assign_nutrition_values_from_old_request_parameters ( $request_ref, $product_ref, $nutrient_table, $source )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref'>$request_ref</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24nutrient_table'>$nutrient_table</a>
        <li class='indexItem indexItem4'><a href='#%24source'>$source</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#assign_nutrition_values_from_request_parameters_(_%24request_ref%2C_%24product_ref%2C_%24nutrient_table%2C_%24source_)'>assign_nutrition_values_from_request_parameters ( $request_ref, $product_ref, $nutrient_table, $source )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref'>$request_ref</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24nutrient_table'>$nutrient_table</a>
        <li class='indexItem indexItem4'><a href='#%24source'>$source</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#assign_nutrition_values_from_imported_csv_product_(_%24imported_csv_product_ref%2C_%24product_ref%2C_%24nutrient_table_)'>assign_nutrition_values_from_imported_csv_product ( $imported_csv_product_ref, $product_ref, $nutrient_table )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24imported_csv_product_ref'>$imported_csv_product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24nutrient_table'>$nutrient_table</a>
        <li class='indexItem indexItem4'><a href='#%24source'>$source</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#assign_nutrition_values_from_request_object_(_%24request_ref%2C_%24product_ref_)'>assign_nutrition_values_from_request_object ( $request_ref, $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24request_ref'>$request_ref</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_estimated_nutrients_(_%24product_ref_)'>compute_estimated_nutrients ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#remove_empty_nutrient_values_and_set_unspecified_nutrients_(%24input_set_ref)'>remove_empty_nutrient_values_and_set_unspecified_nutrients ($input_set_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24input_set_ref'>$input_set_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_nutrition_fields_from_product_to_populated_fields(%24product_ref%2C_%5C%25populated_fields%2C_%24sort_key)'>add_nutrition_fields_from_product_to_populated_fields($product_ref, \%populated_fields, $sort_key)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%5C%25populated_fields'>\%populated_fields</a>
        <li class='indexItem indexItem4'><a href='#%24sort_key'>$sort_key</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#filter_out_nutrients_not_in_taxonomy_(%24product_ref)'>filter_out_nutrients_not_in_taxonomy ($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Example_input_data'>Example input data</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#convert_sodium_to_salt_(_%24sodium_value_)'>convert_sodium_to_salt ( $sodium_value )</a>
    <li class='indexItem indexItem2'><a href='#convert_salt_to_sodium_(_%24salt_value_)'>convert_salt_to_sodium ( $salt_value )</a>
    <li class='indexItem indexItem2'><a href='#compute_energy_from_nutrients_for_nutrients_set_(_%24nutrients_ref%2C_%24unit_)'>compute_energy_from_nutrients_for_nutrients_set ( $nutrients_ref, $unit )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24nutrients_ref%3A_reference_to_the_nutrients_hash.'>$nutrients_ref: reference to the nutrients hash.</a>
        <li class='indexItem indexItem4'><a href='#%24unit%3A_unit_to_use_for_energy_computation_(%22kJ%22_or_%22kcal%22).'>$unit: unit to use for energy computation (&#34;kJ&#34; or &#34;kcal&#34;).</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#has_non_estimated_nutrition_data_(_%24product_ref_)'>has_non_estimated_nutrition_data ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_nutrition_data_as_key_values_pairs_(_%24product_ref_)'>get_nutrition_data_as_key_values_pairs ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#has_no_nutrition_data_on_packaging_(_%24product_ref_)'>has_no_nutrition_data_on_packaging ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#remove_empty_nutrition_data_(_%24product_ref_)'>remove_empty_nutrition_data ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#get_nutrient_from_nutrient_set_in_default_unit_(_%24nutrients_ref%2C_%24nid_)'>get_nutrient_from_nutrient_set_in_default_unit ( $nutrients_ref, $nid )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24nutrients_ref%3A_reference_to_the_nutrients_hash.'>$nutrients_ref: reference to the nutrients hash.</a>
        <li class='indexItem indexItem4'><a href='#%24nid%3A_nutrient_id.'>$nid: nutrient id.</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Returns'>Returns</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#default_unit_for_nid_(_%24nid)'>default_unit_for_nid ( $nid)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Nutrition - functions related to nutrition facts of food products</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p><code>ProductOpener::Nutrition</code> contains functions specific to food products,
in particular related to the new schema of nutrition facts.
This module provides functions It does not contain functions related to ingredients which are in the <code>ProductOpener::Ingredients</code> module.</p>

<p>..</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_computed_values_to_nutrient_sets_($input_sets_ref)"
>add_computed_values_to_nutrient_sets ($input_sets_ref)</a></h2>

<p>Adds computed values to each nutrient set in the given array of nutrient sets:</p>

<p>- energy is computed from macronutrients if enough macronutrients are available - salt and sodium are computed from each other</p>

<p>Values are stored in the value_computed field of each nutrient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_sets_ref"
>$input_sets_ref</a></h4>

<p>Reference to array of nutrient sets</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="generate_nutrient_aggregated_set"
>generate_nutrient_aggregated_set</a></h2>

<p>Generates the aggregated nutrient set for a product from its input sets and stores it in the product hash.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>None</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="generate_nutrient_aggregated_set_from_sets"
>generate_nutrient_aggregated_set_from_sets</a></h2>

<p>Generates and returns a hash reference of the aggregated nutrient set from the given list of nutrient sets.</p>

<p>The generated set is a combined set of nutrients with the preferred sources,
per references and preparation states and with normalized units.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_sets_ref"
>$input_sets_ref</a></h4>

<p>Array of nutrients sets used to generate the aggregated set</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The generated aggregated nutrient set</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="sort_sets_by_priority"
>sort_sets_by_priority</a></h2>

<p>Sorts hashes of nutrient sets in a given array based on a custom priority.
The array is sorted in place and also returned.</p>

<p>The priority is based on the preparation states,
the sources,
and the per references present in the nutrient sets.</p>

<p>We want the preparation state first,
as if we have prepared data,
then we should use prepared data to compute Nutri-Score etc.
Then we want the source,
as some sources are more reliable than others (e.g.
estimates from ingredients should be last) Then we want the per reference,
as we will convert to 100g or 100ml if possible,
so we want to prefer sets that already have 100g or 100ml as per reference.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_sets_ref"
>$input_sets_ref</a></h4>

<p>Reference to array of unsorted input nutrient sets</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_non_estimated_nutrient_per_100g_or_100ml_for_preparation_($product_ref,_$preparation,_$nid)"
>get_non_estimated_nutrient_per_100g_or_100ml_for_preparation ($product_ref,
$preparation,
$nid)</a></h2>

<p>Gets the value of a nutrient from the first non-estimated input set with per = 100g or 100ml.
We take the first value defined in the sorted input set,
that we can convert to 100g or 100ml.</p>

<p>This function is needed to estimate the % of ingredients,
in order to set the max for ingredients like salt and sugar.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$preparation"
>$preparation</a></h4>

<p>Preparation state to look for in the input sets</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nid_of_the_nutrient_to_get"
>$nid of the nutrient to get</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_nutrient_values"
>set_nutrient_values</a></h2>

<p>For each nutrient appearing in the nutrient sets array,
sets its values in the aggregated set.</p>

<p>The units of the nutrients quantities are normalized (g,
kJ or kcal).</p>

<p>Each nutrient is only added once.
Its value is the one in the set with the highest priority.</p>

<p>If the preparation value in a set is different from the one in the aggregated set,
the nutrient is not added to the aggregated set.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$aggregated_nutrient_set_ref"
>$aggregated_nutrient_set_ref</a></h4>

<p>The generated aggregated nutrient set.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="@input_sets"
>@input_sets</a></h4>

<p>The sorted array of nutrient set hashes used to generate the aggregated set.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="convert_nutrient_to_standard_unit"
>convert_nutrient_to_standard_unit</a></h2>

<p>Normalizes the unit of the nutrient value if necessary.</p>

<p>The normalized units are g,
kJ or kcal based on the nutrient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_ref"
>$nutrient_ref</a></h4>

<p>Hash of the nutrient to normalize</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_id"
>$nutrient_id</a></h4>

<p>Name of the nutrient to normalize</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="convert_nutrient_to_100g"
>convert_nutrient_to_100g</a></h2>

<p>Converts the value of the amount of the nutrient based on the wanted per reference if necessary.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_ref"
>$nutrient_ref</a></h4>

<p>Hash of the nutrient set with the value to convert</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$original_per_quantity"
>$original_per_quantity</a></h4>

<p>Current per amount of the nutrient</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$original_per_unit"
>$original_per_unit</a></h4>

<p>Current per unit of the nutrient</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$wanted_per_quantity"
>$wanted_per_quantity</a></h4>

<p>Wanted per amount of the nutrient</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$wanted_per_unit"
>$wanted_per_unit</a></h4>

<p>Wanted per unit of the nutrient</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_specific_nutrition_input_set_($product_ref,_$source,_$preparation,_$per)"
>get_specific_nutrition_input_set ($product_ref,
$source,
$preparation,
$per)</a></h2>

<p>Returns the input set matching the given source,
preparation and per values.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$source"
>$source</a></h4>

<p>Source of the input set to find</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$preparation"
>$preparation</a></h4>

<p>Preparation state of the input set to find</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$per"
>$per</a></h4>

<p>Per reference of the input set to find</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The input set hash reference if found,
undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_per_quantity_and_unit($product_ref,_$input_set_ref)"
>set_per_quantity_and_unit($product_ref,
$input_set_ref)</a></h2>

<p>Fill the per_quantity and per_unit field of nutrients input set,
based upon the &#34;per&#34; value of the nutrient input set,
or product serving_quantity and unit for &#34;serving&#34;.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_-_product"
>$product_ref - product</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_set_ref_-_nutrient_input_set"
>$input_set_ref - nutrient input set</a></h4>

<p>It is modified to add per_quantity and per_unit.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_nutrition_input_sets_in_a_hash_($product_ref)"
>get_nutrition_input_sets_in_a_hash ($product_ref)</a></h2>

<p>Returns the input sets of a product in a hash reference for easier access,
so that we can use $input_sets_hash_ref-&#62;{$source}{$preparation}{$per} to get a specific input set.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The hash reference of input sets</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="convert_nutrition_input_sets_hash_to_array_($input_sets_hash_ref,_$product_ref)"
>convert_nutrition_input_sets_hash_to_array ($input_sets_hash_ref,
$product_ref)</a></h2>

<p>Converts a hash reference of input sets back to an array reference,
which is the format we store in the product structure</p>

<p>Input sets are normalized: - nutrients with undefined or empty values are removed - nutrient with a modifier &#34;-&#34; are removed and added to the unspecified nutrients array - input sets with no nutrients are removed - the source,
preparation and per values from the input sets hash keys are set in the input set</p>

<p>The nutrients sets are sorted with sort_sets_by_priority()</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_sets_hash_ref"
>$input_sets_hash_ref</a></h4>

<p>Reference to hash of input sets</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Used to get the serving size (quantity + unit) if needed for input sets with per = &#34;serving&#34;</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Reference to array of input sets</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_source_for_site_and_org_(_$org_id_=_undef_)"
>get_source_for_site_and_org ( $org_id = undef )</a></h2>

<p>Returns the default source of nutrition data for the current site and organization.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_id"
>$org_id</a></h4>

<p>Organization id</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- &#34;packaging&#34; for the public platform - &#34;manufacturer&#34; for the pro platform</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_preparations_for_product_type"
>get_preparations_for_product_type</a></h2>

<p>Returns the list of valid preparation states for a given product type.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_type"
>$product_type</a></h4>

<p>Type of the product (food,
petfood,
etc)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>List of valid preparation states for the given product type</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_pers_for_product_type"
>get_pers_for_product_type</a></h2>

<p>Returns the list of valid per quantities for a given product type.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_type"
>$product_type</a></h4>

<p>Type of the product (food,
petfood,
etc)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>List of valid per references for the given product type</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_unit_options_for_nutrient_($nid)"
>get_unit_options_for_nutrient ($nid)</a></h2>

<p>Returns the list of valid unit options for a given nutrient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nid"
>$nid</a></h4>

<p>Nutrient id</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Reference to an array of valid unit options for the given nutrient</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_nutrient_value_string_and_modifier_(_$value_ref,_$modifier_ref_)"
>normalize_nutrient_value_string_and_modifier ( $value_ref,
$modifier_ref )</a></h2>

<p>Each nutrient value is entered as a string (by users on the product edit form,
or through the API).
The string value may not always be numeric (e.g.
it can include a &#60; sign).</p>

<p>This function normalizes the string value to remove signs,
and stores extra information in the &#34;modifier&#34; field.</p>

<p>Modifiers may also be inputted directly (e.g.
through the API),
and are normalized as well.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="string_value_reference_$value_ref"
>string value reference $value_ref</a></h4>

<p>Input and output string value reference.
The value will be normalized.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="modifier_reference_$modifier_ref"
>modifier reference $modifier_ref</a></h4>

<p>Input and output modifier reference.
The value will be normalized if it is defined.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Possible_return_values"
>Possible return values</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="value"
>value</a></h4>

<p>- 0 if the input value indicates traces - Number (as a string) - undef for &#39;NaN&#39; (not a number,
sometimes sent by broken API clients)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="modifier"
>modifier</a></h4>

<p>&#60;,
&#62;,
&#8804;,
&#8805;,
~ character sign,
for lesser,
greater,
lesser or equal,
greater or equal,
and about - (minus sign) character when the input value is - (or other dashes) : indicates that the value is not present on the package</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>assign_nutrient_modifier_value_string_and_unit ($input_sets_hash_ref,
$source,
$preparation,
$per,
$nid,
$modifier,
$value_string,
$unit)</a></h2>

<p>Assign a value with a unit and an optional modifier (&#60; or ~) to a nutrient in the nutriments structure.</p>

<p>If a modifier,
value_string or unit is undef or empty,
the corresponding field is set to undef.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_sets_hash_ref"
>$input_sets_hash_ref</a></h4>

<p>Reference to the hash of input sets,
as returned by get_nutrition_input_sets_in_a_hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$source"
>$source</a></h4>

<p>Source of the nutrition data: e.g.
&#34;packaging&#34;,
&#34;manufacturer&#34;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$preparation"
>$preparation</a></h4>

<p>&#34;as_sold&#34; or &#34;prepared&#34;</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$per"
>$per</a></h4>

<p>&#34;100g&#34;,
&#34;100ml&#34;,
&#34;serving&#34;,
&#34;1kg&#34; (for pet food)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nid"
>$nid</a></h4>

<p>Nutrient id</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="value_string"
>value_string</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="unit"
>unit</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_nutrition_values_from_old_request_parameters_(_$request_ref,_$product_ref,_$nutrient_table,_$source_)"
>assign_nutrition_values_from_old_request_parameters ( $request_ref,
$product_ref,
$nutrient_table,
$source )</a></h2>

<p>This function provides backward compatibility for apps that use product edit API v2 (/cgi/product_jqm_multingual.pl) before the introduction of the new nutrition data schema.</p>

<p>It reads the old nutrition data parameters from the request,
and assigns them to the new product nutrition structure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref"
>$request_ref</a></h4>

<p>Reference to the request parameters hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash where the nutrition data will be stored.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_table"
>$nutrient_table</a></h4>

<p>The nutriment table to use.
It should be one of the keys of %nutrients_tables in Config.pm</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$source"
>$source</a></h4>

<p>The source of the nutrition data.
e.g.
&#34;packaging&#34; or &#34;manufacturer&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_nutrition_values_from_request_parameters_(_$request_ref,_$product_ref,_$nutrient_table,_$source_)"
>assign_nutrition_values_from_request_parameters ( $request_ref,
$product_ref,
$nutrient_table,
$source )</a></h2>

<p>This function is used by the web product edit form and apps that use product edit API v2 (/cgi/product_jqm_multingual.pl) after the introduction of the new nutrition data schema.</p>

<p>It reads the new nutrition data parameters from the request,
and assigns them to the new product nutrition structure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref"
>$request_ref</a></h4>

<p>Reference to the request object</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash where the nutrition data will be stored.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_table"
>$nutrient_table</a></h4>

<p>The nutriment table to use.
It should be one of the keys of %nutrients_tables in Config.pm</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$source"
>$source</a></h4>

<p>The source of the nutrition data.
e.g.
&#34;packaging&#34; or &#34;manufacturer&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_nutrition_values_from_imported_csv_product_(_$imported_csv_product_ref,_$product_ref,_$nutrient_table_)"
>assign_nutrition_values_from_imported_csv_product ( $imported_csv_product_ref,
$product_ref,
$nutrient_table )</a></h2>

<p>This function is used by Import.pm to import new nutrition data from an imported product (though a CSV file) to an existing product.</p>

<p>It reads the new nutrition data parameters from the imported product,
and assigns them to the new product nutrition structure.</p>

<p>Note: the serving_size fields need to be imported first,
as we need it to set the per_quantity and per_unit fields of the &#34;serving&#34; input sets.</p>

<p>Note: a source is not specified as argument to this function,
as it should be set in the field names.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$imported_csv_product_ref"
>$imported_csv_product_ref</a></h4>

<p>Reference to the imported product hash where the nutrition data will be read.</p>

<p>All the fields in the imported product are at the root level,
e.g.
nutrition.input_sets.as_sold.100g.nutrients.energy.value_string</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash where the nutrition data will be stored.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrient_table"
>$nutrient_table</a></h4>

<p>The nutriment table to use.
It should be one of the keys of %nutrients_tables in Config.pm</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$source"
>$source</a></h4>

<p>The source of the nutrition data.
e.g.
&#34;packaging&#34; or &#34;manufacturer&#34;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>import_nutrients_old_fields($args_ref,
$imported_product_ref,
$product_ref,
$stats_ref,
$modified_ref,
$modified_fields_ref,
$differing_ref,
$differing_fields_ref,
$nutrients_edited_ref,
$time)</a></h2>

<p>Import nutrient values from old style fields like fat_100g_value,
fat_100g_unit,
fat_prepared_100g_value,
etc.</p>

<p>We consider the source to be &#34;packaging&#34; on the public platform,
and &#34;manufacturer&#34; on the producers platform</p>

<p>Note: the serving_size fields need to be imported first,
as we need it to set the per_quantity and per_unit fields of the &#34;serving&#34; input sets.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_nutrition_values_from_request_object_(_$request_ref,_$product_ref_)"
>assign_nutrition_values_from_request_object ( $request_ref,
$product_ref )</a></h2>

<p>This function is used by the product edit API v3 (/api/v3/product) to write the nutrition data.
Nutrition data is passed in nutrition.input_sets as an array of input sets.</p>

<p>It reads the nutrition data from the request,
and assigns them to the new product nutrition structure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$request_ref"
>$request_ref</a></h4>

<p>Reference to the request object</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash where the nutrition data will be stored.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_estimated_nutrients_(_$product_ref_)"
>compute_estimated_nutrients ( $product_ref )</a></h2>

<p>Compute estimated nutrients from ingredients.</p>

<p>If we have a high enough confidence (95% of the ingredients (by quantity) have a known nutrient profile),
we store the result in an nutrient input set with the source &#34;estimate&#34;.</p>

<p>Otherwise we remove the estimated nutrients input set if it exists.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="remove_empty_nutrient_values_and_set_unspecified_nutrients_($input_set_ref)"
>remove_empty_nutrient_values_and_set_unspecified_nutrients ($input_set_ref)</a></h2>

<p>Removes nutrients with empty values from an input set.</p>

<p>If a nutrient has a modifier equal to &#34;-&#34;,
it means no value is specified on the packaging.</p>

<p>The nutrient is removed from the input set and added to the unspecified_nutrients array.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$input_set_ref"
>$input_set_ref</a></h4>

<p>Reference to the input set hash</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_nutrition_fields_from_product_to_populated_fields($product_ref,_\%populated_fields,_$sort_key)"
>add_nutrition_fields_from_product_to_populated_fields($product_ref,
\%populated_fields,
$sort_key)</a></h2>

<p>This function is used by Export.pm to generate the list of populated nutrition fields for a product.
Export.pm can then create a CSV file with columns that have data for at least one product.</p>

<p>If we have a value for a nutrient in an input set of the product,
we add the corresponding field to the populated fields hash,
so that it can be output in the CSV file.</p>

<p>e.g.
for an input set like:</p>

<p>input_sets =&#62; [ { preparation =&#62; &#34;as_sold&#34;,
per =&#62; &#34;serving&#34;,
per_quantity =&#62; &#34;1&#34;,
per_unit =&#62; &#34;l&#34;,
source =&#62; &#34;packaging&#34;,
nutrients =&#62; { &#34;sodium&#34; =&#62; { value_string =&#62; &#34;0.25&#34;,
value =&#62; 0.25,
unit =&#62; &#34;g&#34;,
},
&#34;sugars&#34; =&#62; { value_string =&#62; &#34;2.0&#34;,
value =&#62; 2,
unit =&#62; &#34;g&#34;,
} } },
{ preparation =&#62; &#34;as_sold&#34;,
per =&#62; &#34;serving&#34;,
per_quantity =&#62; &#34;50&#34;,
per_unit =&#62; &#34;ml&#34;,
source =&#62; &#34;manufacturer&#34;,
nutrients =&#62; { &#34;sugars&#34; =&#62; { value_string =&#62; &#34;0.063&#34;,
value =&#62; 0.063,
unit =&#62; &#34;g&#34;,
} } } ]</p>

<p>We generate those keys and values in the populated fields hash:</p>

<p>{ &#34;nutrition.input_sets.manufacturer.as_sold.serving.nutrients.sugars.unit&#34; : &#34;nutrition_01-manufacturer_as_sold_serving_2-nutrients_043-sugars_unit&#34;,
&#34;nutrition.input_sets.manufacturer.as_sold.serving.nutrients.sugars.value&#34; : &#34;nutrition_01-manufacturer_as_sold_serving_2-nutrients_043-sugars_value&#34;,
&#34;nutrition.input_sets.manufacturer.as_sold.serving.nutrients.sugars.value_string&#34; : &#34;nutrition_01-manufacturer_as_sold_serving_2-nutrients_043-sugars_value_string&#34;,
&#34;nutrition.input_sets.manufacturer.as_sold.serving.per_quantity&#34; : &#34;nutrition_01-manufacturer_as_sold_serving_0-root_per_quantity&#34;,
&#34;nutrition.input_sets.manufacturer.as_sold.serving.per_unit&#34; : &#34;nutrition_01-manufacturer_as_sold_serving_0-root_per_unit&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sodium.unit&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_068-sodium_unit&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sodium.value&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_068-sodium_value&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sodium.value_string&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_068-sodium_value_string&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sugars.unit&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_043-sugars_unit&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sugars.value&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_043-sugars_value&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.nutrients.sugars.value_string&#34; : &#34;nutrition_01-packaging_as_sold_serving_2-nutrients_043-sugars_value_string&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.per_quantity&#34; : &#34;nutrition_01-packaging_as_sold_serving_0-root_per_quantity&#34;,
&#34;nutrition.input_sets.packaging.as_sold.serving.per_unit&#34; : &#34;nutrition_01-packaging_as_sold_serving_0-root_per_unit&#34; }</p>

<p>The key is the CSV field name,
and the value is a sort key used to sort the fields in the CSV file.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="\%populated_fields"
>\%populated_fields</a></h4>

<p>Reference to the hash of populated fields</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$sort_key"
>$sort_key</a></h4>

<p>A string used to sort the fields in the CSV file.
The nutrition fields sort keys will be prefixed by this sort key.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="filter_out_nutrients_not_in_taxonomy_($product_ref)"
>filter_out_nutrients_not_in_taxonomy ($product_ref)</a></h2>

<p>In the old nutrition facts schema (2025 and before),
we authorized users to add any nutrient they wanted,
even if they did not exist in the taxonomy.
In the new nutrition facts schema,
we only authorize nutrients that exist in the taxonomy.</p>

<p>This function tries to map unknown nutrients to known nutrients in the taxonomy (as the taxonomy is evolving,
some nutrients that were unknown before may now exist in the taxonomy).
It then filters out nutrients that do not exist in the taxonomy and that could not be mapped to known nutrients.</p>

<p>Removes nutrients from the product&#39;s <code>nutriments</code> hash that are not present in the taxonomy.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Example_input_data"
>Example input data</a></h3>

<p>The following are examples of unknown nutrients that may be present in the <code>nutriments</code> hash:</p>

<pre>  # unknown nutrient prefixed with language
  &#39;fr-nitrate&#39; =&#62; 0.38,
  &#39;fr-nitrate_100g&#39; =&#62; 0.38,
  &#39;fr-nitrate_label&#39; =&#62; &#34;Nitrate&#34;,
  &#39;fr-nitrate_serving&#39; =&#62; 0.0038,
  &#39;fr-nitrate_unit&#39; =&#62; &#34;g&#34;,
  &#39;fr-nitrate_value&#39; =&#62; 0.38,

  # unknown nutrient not prefixed with language (old fields)
  &#39;sulfat&#39; =&#62; 0.0141,
  &#39;sulfat_100g&#39; =&#62; 0.0141,
  &#39;sulfat_label&#39; =&#62; &#34;Sulfat&#34;,
  &#39;sulfat_serving&#39; =&#62; 0.141,
  &#39;sulfat_unit&#39; =&#62; &#34;mg&#34;,
  &#39;sulfat_value&#39; =&#62; 14.1,

  # unknown nutrient that is not in the taxonomy
  &#39;en-some-unknown-nutrient&#39; =&#62; 1.23,
  &#39;en-some-unknown-nutrient_100g&#39; =&#62; 1.23,
  &#39;en-some-unknown-nutrient_label&#39; =&#62; &#34;Some unknown nutrient&#34;,
  &#39;en-some-unknown-nutrient_unit&#39; =&#62; &#34;g&#34;,
  &#39;en-some-unknown-nutrient_value&#39; =&#62; 1.23,</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="convert_sodium_to_salt_(_$sodium_value_)"
>convert_sodium_to_salt ( $sodium_value )</a></h2>

<p>Converts a sodium value to its equivalent salt value using the EU standard conversion factor (2.5).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="convert_salt_to_sodium_(_$salt_value_)"
>convert_salt_to_sodium ( $salt_value )</a></h2>

<p>Converts a salt value to its equivalent sodium value using the EU standard conversion factor (2.5).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_energy_from_nutrients_for_nutrients_set_(_$nutrients_ref,_$unit_)"
>compute_energy_from_nutrients_for_nutrients_set ( $nutrients_ref, $unit )</a></h2>

<p>Computes the energy from other nutrients for a given input set.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrients_ref:_reference_to_the_nutrients_hash."
>$nutrients_ref: reference to the nutrients hash.</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$unit:_unit_to_use_for_energy_computation_(&#34;kJ&#34;_or_&#34;kcal&#34;)."
>$unit: unit to use for energy computation (&#34;kJ&#34; or &#34;kcal&#34;).</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>The computed energy value.</p>

<p>The value is also stored in energy nutrients hashes as &#34;value_computed&#34;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="has_non_estimated_nutrition_data_(_$product_ref_)"
>has_non_estimated_nutrition_data ( $product_ref )</a></h2>

<p>Checks if the product has at least one nutrient with a non-estimated value</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_nutrition_data_as_key_values_pairs_(_$product_ref_)"
>get_nutrition_data_as_key_values_pairs ( $product_ref )</a></h2>

<p>This function is used by ProductOpener::Product::complete_product_history_and_completeness()</p>

<p>It serialize the nutrition data into key-value pairs (flat hashmap) for easier comparison of product history entries.</p>

<p>Estimates are not returned.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>A reference to a hash of key-value pairs representing the nutrition data of the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="has_no_nutrition_data_on_packaging_(_$product_ref_)"
>has_no_nutrition_data_on_packaging ( $product_ref )</a></h2>

<p>Checks if the product has the no_nutrition_data_on_packaging flag set to true.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the product hash</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="remove_empty_nutrition_data_(_$product_ref_)"
>remove_empty_nutrition_data ( $product_ref )</a></h2>

<p>Remove the empty nutrition data (empty input_sets and/or aggregated_set), and the nutrition hash if it is empty.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_nutrient_from_nutrient_set_in_default_unit_(_$nutrients_ref,_$nid_)"
>get_nutrient_from_nutrient_set_in_default_unit ( $nutrients_ref, $nid )</a></h2>

<p>Get the value of a nutrient from a nutrients set, converted to the default unit for that nutrient.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nutrients_ref:_reference_to_the_nutrients_hash."
>$nutrients_ref: reference to the nutrients hash.</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$nid:_nutrient_id."
>$nid: nutrient id.</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Returns"
>Returns</a></h3>

<p>The value of the nutrient in the default unit, or undef if not defined.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="default_unit_for_nid_(_$nid)"
>default_unit_for_nid ( $nid)</a></h2>

<p>Return the default unit that we convert everything to internally (e.g. in the aggregated set)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<p>$nid: String</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>Default value for that certain unit</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
