<html><head><title>ProductOpener::Products</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Fri Sep 12 07:55:10 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Revisions'>Revisions</a>
    <li class='indexItem indexItem2'><a href='#Completeness%2C_data_quality_and_edit_history'>Completeness, data quality and edit history</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)'>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a>
    <li class='indexItem indexItem2'><a href='#assign_new_code_(_)'>assign_new_code ( )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <li class='indexItem indexItem3'><a href='#Caveats'>Caveats</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Invalid_codes'>Invalid codes</a>
        <li class='indexItem indexItem4'><a href='#Code_conflicts'>Code conflicts</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_code()'>normalize_code()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_code_zeroes(%24code)'>normalize_code_zeroes($code)</a>
    <li class='indexItem indexItem2'><a href='#is_valid_upc12(%24code)'>is_valid_upc12($code)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_code_with_gs1_ai(%24code)'>normalize_code_with_gs1_ai($code)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#is_valid_code(%24code)'>is_valid_code($code)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#split_code()'>split_code()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_id_for_owner_(_OWNER_ID%2C_CODE_)'>product_id_for_owner ( OWNER_ID, CODE )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Owner_id'>Owner id</a>
        <li class='indexItem indexItem4'><a href='#Code'>Code</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#server_for_product_type_(_%24product_type_)'>server_for_product_type ( $product_type )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_type'>$product_type</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_server_for_product_(_%24product_ref_)'>get_server_for_product ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#product_path_from_id_(_%24product_id_)'>product_path_from_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_path_(_%24product_ref_)'>product_path ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_id_from_path_(_%24product_path_)'>product_id_from_path ( $product_path )</a>
    <li class='indexItem indexItem2'><a href='#init_product_(_%24userid%2C_%24orgid%2C_%24code%2C_%24countryid%2C_%24client_id_%3D_undef_)'>init_product ( $userid, $orgid, $code, $countryid, $client_id = undef )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_Type'>Return Type</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#change_product_code_(%24product_ref%2C_%24new_code)'>change_product_code ($product_ref, $new_code)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24new_code'>$new_code</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#change_product_type_(%24product_ref%2C_%24new_product_type)'>change_product_type ($product_ref, $new_product_type)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24new_product_type'>$new_product_type</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_sort_keys_(_%24product_ref_)'>compute_sort_keys ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#last_modified_t_-_date_of_last_modification_of_the_product_page'>last_modified_t - date of last modification of the product page</a>
      <li class='indexItem indexItem3'><a href='#popularity_key_-_Popular_and_recent_products'>popularity_key - Popular and recent products</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#store_product_(%24user_id%2C_%24product_ref%2C_%24comment%2C_%24client_id_%3D_undef)'>store_product ($user_id, $product_ref, $comment, $client_id = undef)</a>
    <li class='indexItem indexItem2'><a href='#compute_data_sources_(_%24product_ref%2C_%24changes_ref_)'>compute_data_sources ( $product_ref, $changes_ref )</a>
    <li class='indexItem indexItem2'><a href='#normalize_product_data(%24product_ref)'>normalize_product_data($product_ref)</a>
    <li class='indexItem indexItem2'><a href='#get_change_userid_or_uuid_(_%24change_ref_)'>get_change_userid_or_uuid ( $change_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24change_ref'>$change_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#replace_user_id_in_product_(_%24product_id%2C_%24user_id%2C_%24new_user_id_)'>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_id'>Product id</a>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#find_and_replace_user_id_in_products_(_%24user_id%2C_%24new_user_id_)'>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#record_user_edit_type(%24users_ref%2C_%24user_type%2C_%24user_id)'>record_user_edit_type($users_ref, $user_type, $user_id)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24users_ref_Structure_that_holds_the_records_by_type'>$users_ref Structure that holds the records by type</a>
        <li class='indexItem indexItem4'><a href='#%24user_type_e.g._editors%2C_photographers%2C_weighers'>$user_type e.g. editors, photographers, weighers</a>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_name_brand_(_%24ref_)'>product_name_brand ( $ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Reference_to_product_object_%24ref'>Reference to product object $ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_name_brand_quantity_(_%24ref_)'>product_name_brand_quantity ( $ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Reference_to_product_object_%24ref'>Reference to product object $ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_url_(_%24code_or_ref_)'>product_url ( $code_or_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_code_or_reference_to_product_object_%24code_or_ref'>Product code or reference to product object $code_or_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_action_url_(_%24code%2C_%24action_)'>product_action_url ( $code, $action )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_code_or_reference_to_product_object_%24code_or_ref'>Product code or reference to product object $code_or_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#review_product_type_(_%24product_ref_)'>review_product_type ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_product_edit_rules_(%24product_ref)'>process_product_edit_rules ($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#where_it_applies'>where it applies</a>
      <li class='indexItem indexItem3'><a href='#edit_rules_structure'>edit_rules structure</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#conditions'>conditions</a>
        <li class='indexItem indexItem4'><a href='#actions'>actions</a>
        <li class='indexItem indexItem4'><a href='#notifications'>notifications</a>
        <li class='indexItem indexItem4'><a href='#Example_of_an_edit_rule'>Example of an edit rule</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_changes_diff_text_(_%24change_ref_)'>compute_changes_diff_text ( $change_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_user_teams_(_%24product_ref_)'>add_user_teams ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_data_is_protected_(_%24product_ref_)'>product_data_is_protected ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#delete_fields_(%24product_ref%2C_%24fields_ref)'>delete_fields ($product_ref, $fields_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24fields_ref'>$fields_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#analyze_and_enrich_product_data_(%24product_ref%2C_%24response_ref)'>analyze_and_enrich_product_data ($product_ref, $response_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref_(input)'>$product_ref (input)</a>
        <li class='indexItem indexItem4'><a href='#%24response_ref_(output)'>$response_ref (output)</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#is_owner_field(%24product_ref%2C_%24field)'>is_owner_field($product_ref, $field)</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Products - create and save products</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Products</code> is used to create products and save them in Product Opener&#39;s database and file system.</p>

<pre>    use ProductOpener::Products qw/:all/;

        my $product_ref = init_product($User_id, $Org_id, $code, $countryid);

        $product_ref-&#62;{product_name_en} = &#34;Chocolate cookies&#34;;

        store_product(&#34;my-user&#34;, $product_ref, &#39;helpful comment&#39;);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Revisions"
>Revisions</a></h2>

<p>When a product is saved, a new revision of the product is created. All revisions are saved in the file system:</p>

<p>products/[barcode path]/1 - first revision products/[barcode path]/2 - 2nd revision ... products/[barcode path]/product - link to latest revision</p>

<p>The latest revision is stored in the products collection of the MongoDB database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Completeness,_data_quality_and_edit_history"
>Completeness, data quality and edit history</a></h2>

<p>Before a product is saved, this module compute the completeness and quality of the data, and the edit history.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)"
>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a></h2>

<p><code>make_sure_numbers_are_stored_as_numbers()</code> forces numbers contained in the product data to be stored as numbers (and not strings) in MongoDB.</p>

<p>Perl scalars are not typed, the internal type depends on the last operator used on the variable... e.g. if it is printed with a string concatenation, then it&#39;s converted to a string.</p>

<p>See https://metacpan.org/pod/JSON%3a%3aXS#PERL---JSON</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_new_code_(_)"
>assign_new_code ( )</a></h2>

<p><code>assign_new_code()</code> assigns a new unused code to store a new product that does not have a barcode.</p>

<pre>        my ($code, $product_id) = assign_new_code();</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>A list with the new code and the corresponding product_id.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Caveats"
>Caveats</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Invalid_codes"
>Invalid codes</a></h4>

<p>This function currently assign new codes in sequence starting from 2000000000001. We increment the number by 1 for each product (which means codes are not valid as the last digit is supposed to be the check digit), and check if there is already a product for that number.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code_conflicts"
>Code conflicts</a></h4>

<p>Codes starting with 2 are reserved for internal uses, there may be conflicts as other companies can use the same codes.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_code()"
>normalize_code()</a></h2>

<p><code>normalize_code()</code> this function normalizes the product code by: - running the given code through normalization method provided by GS1 to format a GS1 data string, or data URL to a GTIN, - keeping only digits and removing spaces/dashes etc., - normalizing the length by adding leading zeroes or removing the leading zero (in case of 14 digit codes)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code in the Raw form: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Normalized version of the code</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_code_zeroes($code)"
>normalize_code_zeroes($code)</a></h2>

<p>On disk, we store product files and images in directories named after the product code, and we add leading 0s to the paths. So we need to normalize the number of leading 0s of product codes, so that we don&#39;t have 2 products for codes that differ only by leading 0s.</p>

<p>This function normalizes the product code by: - removing leading zeroes, - adding leading zeroes to have at least 13 digits, - removing leading zeroes for EAN8s to keep only 8 digits</p>

<p>Note: this function adds leading 0s even if the GS1 code is not valid.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_valid_upc12($code)"
>is_valid_upc12($code)</a></h2>

<p><code>is_valid_upc12()</code> this function validates a UPC-12 code by: - checking if the input is exactly 12 digits long, - verifying the check digit using the modulo 10 algorithm.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>UPC-12 Code in the Raw form: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>1 (true) if the UPC-12 code is valid, 0 (false) otherwise.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_code_with_gs1_ai($code)"
>normalize_code_with_gs1_ai($code)</a></h2>

<p><code>normalize_code_with_gs1_ai()</code> this function normalizes the product code by: - running the given code through normalization method provided by GS1 to format a GS1 data string, or data URI to a GTIN, - keeping only digits and removing spaces/dashes etc., - normalizing the length by adding leading zeroes or removing the leading zero (in case of 14 digit codes)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code in the Raw form: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Normalized version of the code, and GS1 AI data string of the code, if a valid GS1 string was given as the argument</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_valid_code($code)"
>is_valid_code($code)</a></h2>

<p><code>is_valid_code()</code> checks if the given code is a valid product code.</p>

<p>It checks if the code is defined, if it contains only digits, and if its length is between 4 and 40 digits, excluding leading zeroes.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Boolean value indicating if the code is valid or not.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="split_code()"
>split_code()</a></h2>

<p><code>split_code()</code> this function splits the product code for determining the product path and the _id. product_path_from_id() utilizes this for the said purpose.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Code that has been split into 3 sections of three digits and one fourth section with the remaining digits. Example: 1234567890123 :- 123/456/789/0123</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_id_for_owner_(_OWNER_ID,_CODE_)"
>product_id_for_owner ( OWNER_ID, CODE )</a></h2>

<p><code>product_id_for_owner()</code> returns the product id associated with a product barcode.</p>

<p>If the products on the server are public, the product id is equal to the product code.</p>

<p>If the products on the server are private (e.g. on the platform for producers), the product_id is of the form user-[user id]/[code] or org-[organization id]/code.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Owner_id"
>Owner id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code"
>Code</a></h4>

<p>Product barcode</p>

<p>In most cases, pass $Owner_id which is initialized by ProductOpener::Users::init_user()</p>

<pre>  undef for public products
  user-[user id] or org-[organization id] for private products</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The product id.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="server_for_product_type_(_$product_type_)"
>server_for_product_type ( $product_type )</a></h2>

<p>Returns the server for the product, if it is not on the current server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_type"
>$product_type</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>undef is the product is on the current server, or server id of the server of the product otherwise.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_server_for_product_(_$product_ref_)"
>get_server_for_product ( $product_ref )</a></h2>

<p>Return the MongoDB database for the product: off, obf, opf, opff or off-pro</p>

<p>If we are on the producers platform, we currently have only one server: off-pro</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_from_id_(_$product_id_)"
>product_path_from_id ( $product_id )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_(_$product_ref_)"
>product_path ( $product_ref )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Product object reference.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_id_from_path_(_$product_path_)"
>product_id_from_path ( $product_path )</a></h2>

<p>Reverse of product_path_from_id.</p>

<p>There is no guarantee the result will be correct... but it&#39;s way faster than loading the sto !</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_product_(_$userid,_$orgid,_$code,_$countryid,_$client_id_=_undef_)"
>init_product ( $userid, $orgid, $code, $countryid, $client_id = undef )</a></h2>

<p>Initializes and return a $product_ref structure for a new product. If $countryid is defined and is not &#34;en:world&#34;, then assign this country for the countries field. Otherwise, use the country associated with the ip address of the user.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Type"
>Return Type</a></h3>

<p>Returns a $product_ref structure</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="change_product_code_($product_ref,_$new_code)"
>change_product_code ($product_ref, $new_code)</a></h2>

<p>Utility function to change the barcode of a product. Fails and returns an error if the code is invalid, or if there is already a product with the new code.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$new_code"
>$new_code</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>If successful: undef If there was an error: invalid_code or new_code_already_exists</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="change_product_type_($product_ref,_$new_product_type)"
>change_product_type ($product_ref, $new_product_type)</a></h2>

<p>Utility function to change the product type of a product. Fails and returns an error if the product type is invalid.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$new_product_type"
>$new_product_type</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>If successful: undef If there was an error: invalid_product_type</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_sort_keys_(_$product_ref_)"
>compute_sort_keys ( $product_ref )</a></h2>

<p>Compute sort keys that are stored in the MongoDB database and used to order results of queries.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="last_modified_t_-_date_of_last_modification_of_the_product_page"
>last_modified_t - date of last modification of the product page</a></h3>

<p>Used on the web site for facets pages, except the index page.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="popularity_key_-_Popular_and_recent_products"
>popularity_key - Popular and recent products</a></h3>

<p>Used for the Personal Search project to provide generic search results that apps can personalize later.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="store_product_($user_id,_$product_ref,_$comment,_$client_id_=_undef)"
>store_product ($user_id, $product_ref, $comment, $client_id = undef)</a></h2>

<p>Save changes of a product: - in a new .sto file on the disk - in MongoDB (in the products collection, or products_obsolete collection if the product is obsolete)</p>

<p>Before saving, some field values are computed, and product history and completeness is computed.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_data_sources_(_$product_ref,_$changes_ref_)"
>compute_data_sources ( $product_ref, $changes_ref )</a></h2>

<p>Analyze the sources field of the product, as well as the changes to add to the data_sources field.</p>

<p>Sources allows to add some producers imports that were done before the producers platform was created.</p>

<p>The changes structure allows to add apps.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_product_data($product_ref)"
>normalize_product_data($product_ref)</a></h2>

<p>Function to do some normalization of product data (from the product database or input product data from a service)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_change_userid_or_uuid_(_$change_ref_)"
>get_change_userid_or_uuid ( $change_ref )</a></h2>

<p>For a specific change, analyze change identifiers (comment, user agent, userid etc.) to determine if the change was done through an app, the OFF userid, or an app specific UUID</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$change_ref"
>$change_ref</a></h4>

<p>reference to a change record</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>The function returns by order of preference: - a real user userid if we have an userid which is not the userid of an app - an appid + app uuid (e.g. some-app.Z626FZF4RTFSG6) - an app userid if the app did not provide an app uuid - openfoodfacts-contributors</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="replace_user_id_in_product_(_$product_id,_$user_id,_$new_user_id_)"
>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a></h2>

<p>For a specific product, replace a specific user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_id"
>Product id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_and_replace_user_id_in_products_(_$user_id,_$new_user_id_)"
>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a></h2>

<p>Find all products changed by a specific user_id, and replace the user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="record_user_edit_type($users_ref,_$user_type,_$user_id)"
>record_user_edit_type($users_ref, $user_type, $user_id)</a></h2>

<p>Record that a user has made a change of a specific type to the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$users_ref_Structure_that_holds_the_records_by_type"
>$users_ref Structure that holds the records by type</a></h4>

<p>For each type, there is a &#34;list&#34; array, and a &#34;seen&#34; hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_type_e.g._editors,_photographers,_weighers"
>$user_type e.g. editors, photographers, weighers</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_name_brand_(_$ref_)"
>product_name_brand ( $ref )</a></h2>

<p>Returns a product full name, which is a combination of product name and first brand.</p>

<p>We use a small dash (instead of a minus -) as a separator between the product name and the brand.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Reference_to_product_object_$ref"
>Reference to product object $ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_name_brand_quantity_(_$ref_)"
>product_name_brand_quantity ( $ref )</a></h2>

<p>Returns a product full name, which is a combination of product name, first brand and quantity.</p>

<p>We use a small dash (instead of a minus -) as a separator between the product name and the brand.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Reference_to_product_object_$ref"
>Reference to product object $ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_url_(_$code_or_ref_)"
>product_url ( $code_or_ref )</a></h2>

<p>Returns a relative URL for a product on the website.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_code_or_reference_to_product_object_$code_or_ref"
>Product code or reference to product object $code_or_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_action_url_(_$code,_$action_)"
>product_action_url ( $code, $action )</a></h2>

<p>Returns a relative URL for an action on a product on the website.</p>

<p>This function is called by the web/panels/panel.tt.html template for knowledge panels that have associated actions.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_code_or_reference_to_product_object_$code_or_ref"
>Product code or reference to product object $code_or_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="review_product_type_(_$product_ref_)"
>review_product_type ( $product_ref )</a></h2>

<p>Reviews the product type based on the presence of specific tags in the categories field. Updates the product type if necessary.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<p>A reference to a hash containing the product details.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_product_edit_rules_($product_ref)"
>process_product_edit_rules ($product_ref)</a></h2>

<p>Process the edit_rules (see <code>@edit_rules</code> in in Config file).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="where_it_applies"
>where it applies</a></h3>

<p>It applies in all API/form that edit the product. It applies to apply an image crop.</p>

<p>It does not block image upload.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="edit_rules_structure"
>edit_rules structure</a></h3>

<ul>
<li>name: rule name to identify it in logs and describe it</li>

<li>conditions: the conditions the product must match, a list of [field name, value]</li>

<li>actions: the actions to take, a list, where each element is a list with a rule name, and eventual arguments</li>

<li>notifications: also notify, list of email addresses or specific notification rules</li>
</ul>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="conditions"
>conditions</a></h4>

<p>Each condition is either a match on <code>user_id</code> or it&#39;s contrary <code>user_id_not</code>, or <code>in_TAG_NAME_tags</code> for a tag field to match a specific tag id.</p>

<p>Note that conditions are checked before editing the product !</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="actions"
>actions</a></h4>

<p><code>ignore</code> alone, ignore every edits.</p>

<p>You can also have rules of the form <code>ignore_FIELD</code> and <code>warn_FIELD</code> which will ignore (or notify) edits on the specific field.</p>

<p>Note that ignore rules also create a notification.</p>

<p>For nutriments use <code>nutriments_NUTRIMENT_NAME</code> for <code>FIELD</code>.</p>

<p>You can guard the rule on the field with a condition: <code>ignore_if_CONDITION_FIELD</code> or <code>warn_if_CONDITION_FIELD</code> This time it&#39;s to check the value the user want&#39;s to add.</p>

<p><code>CONDITION</code> is one of the following:</p>

<ul>
<li>existing - user tries to edit this field with a non empty value</li>

<li>0 - user tries to put numerical value 0 in the field</li>

<li>equal / lesser / greater - comparison of numeric value (requires a value as argument)</li>

<li>match - comparison to a string (equality, requires a value as argument)</li>

<li>regexp_match - match against a regexp (requires a regexp value as argument)</li>
</ul>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="notifications"
>notifications</a></h4>

<p>Notifications are email addresses to send emails, or &#34;slack_CHANNEL_NAME&#34; (<b>warning</b> currently channel name is ignored, we post to <i>edit-alerts</i>)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Example_of_an_edit_rule"
>Example of an edit rule</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_changes_diff_text_(_$change_ref_)"
>compute_changes_diff_text ( $change_ref )</a></h2>

<p>Generates a text that describes the changes made. The text is displayed in the edit history of products.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>$change_ref: reference to a change record</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_user_teams_(_$product_ref_)"
>add_user_teams ( $product_ref )</a></h2>

<p>If the user who add or edits the product belongs to one or more teams, add them to the teams_tags array.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<p>$product_ref</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_data_is_protected_(_$product_ref_)"
>product_data_is_protected ( $product_ref )</a></h2>

<p>Checks if the product data should be protected from edits. e.g. official producer data that should not be changed by anonymous users through the API</p>

<p>Product data is protected if it has an owner and if the corresponding organization has the &#34;protect data&#34; checkbox checked.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>- 1 if the data is protected - 0 if the data is not protected</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_fields_($product_ref,_$fields_ref)"
>delete_fields ($product_ref, $fields_ref)</a></h2>

<p>Utility function to delete fields from a product_ref or a subfield.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to a complete product a subfield.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$fields_ref"
>$fields_ref</a></h4>

<p>An array of field names to remove.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="analyze_and_enrich_product_data_($product_ref,_$response_ref)"
>analyze_and_enrich_product_data ($product_ref, $response_ref)</a></h2>

<p>This function processes product raw data to analyze it and enrich it. For instance to analyze ingredients and compute scores such as Nutri-Score and Environmental-Score.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref_(input)"
>$product_ref (input)</a></h4>

<p>Reference to a product.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$response_ref_(output)"
>$response_ref (output)</a></h4>

<p>Reference to a response object to which we can add errors and warnings.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="is_owner_field($product_ref,_$field)"
>is_owner_field($product_ref, $field)</a></h2>

<p>Return 1 if the field value was provided by the owner (producer) and the field is not a tag field.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'

>product_iter($initial_path = $BASE_DIRS{PRODUCTS}, $name_pattern = qr/product$/i, $exclude_path_pattern = qr/^(conflicting|invalid)-codes$/)</a></h2>

<p>Iterate over all products in the specified path whose name matches the $name_pattern regex and whose path does not match the $exclude_path_pattern. Provides default exclusions so people don&#39;t forget to apply them</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
