<html><head><title>ProductOpener::Products</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Thu Sep 21 11:51:22 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Revisions'>Revisions</a>
    <li class='indexItem indexItem2'><a href='#Completeness%2C_data_quality_and_edit_history'>Completeness, data quality and edit history</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)'>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a>
    <li class='indexItem indexItem2'><a href='#assign_new_code_(_)'>assign_new_code ( )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <li class='indexItem indexItem3'><a href='#Caveats'>Caveats</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Invalid_codes'>Invalid codes</a>
        <li class='indexItem indexItem4'><a href='#Code_conflicts'>Code conflicts</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#normalize_code()'>normalize_code()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#split_code()'>split_code()</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <li class='indexItem indexItem3'><a href='#Return_Values'>Return Values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_id_for_owner_(_OWNER_ID%2C_CODE_)'>product_id_for_owner ( OWNER_ID, CODE )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Owner_id'>Owner id</a>
        <li class='indexItem indexItem4'><a href='#Code'>Code</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#server_for_product_id_(_%24product_id_)'>server_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#data_root_for_product_id_(_%24product_id_)'>data_root_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#www_root_for_product_id_(_%24product_id_)'>www_root_for_product_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_path_from_id_(_%24product_id_)'>product_path_from_id ( $product_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_id'>$product_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_path_(_%24product_ref_)'>product_path ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_id_from_path_(_%24product_path_)'>product_id_from_path ( $product_path )</a>
    <li class='indexItem indexItem2'><a href='#init_product_(_%24userid%2C_%24orgid%2C_%24code%2C_%24countryid_)'>init_product ( $userid, $orgid, $code, $countryid )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_Type'>Return Type</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#send_notification_for_product_change_(_%24user_id%2C_%24product_ref%2C_%24action%2C_%24comment%2C_%24diffs_)'>send_notification_for_product_change ( $user_id, $product_ref, $action, $comment, $diffs )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
        <li class='indexItem indexItem4'><a href='#%24product_ref'>$product_ref</a>
        <li class='indexItem indexItem4'><a href='#%24action'>$action</a>
        <li class='indexItem indexItem4'><a href='#%24comment'>$comment</a>
        <li class='indexItem indexItem4'><a href='#%24diffs'>$diffs</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_sort_keys_(_%24product_ref_)'>compute_sort_keys ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#last_modified_t_-_date_of_last_modification_of_the_product_page'>last_modified_t - date of last modification of the product page</a>
      <li class='indexItem indexItem3'><a href='#popularity_key_-_Popular_and_recent_products'>popularity_key - Popular and recent products</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#store_product_(%24user_id%2C_%24product_ref%2C_%24comment)'>store_product ($user_id, $product_ref, $comment)</a>
    <li class='indexItem indexItem2'><a href='#compute_data_sources_(_%24product_ref%2C_%24changes_ref_)'>compute_data_sources ( $product_ref, $changes_ref )</a>
    <li class='indexItem indexItem2'><a href='#get_change_userid_or_uuid_(_%24change_ref_)'>get_change_userid_or_uuid ( $change_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24change_ref_reference_to_a_change_record'>$change_ref reference to a change record</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_value'>Return value</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#replace_user_id_in_product_(_%24product_id%2C_%24user_id%2C_%24new_user_id_)'>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_id'>Product id</a>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#find_and_replace_user_id_in_products_(_%24user_id%2C_%24new_user_id_)'>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#User_id'>User id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#New_user_id'>New user id</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#record_user_edit_type(%24users_ref%2C_%24user_type%2C_%24user_id)'>record_user_edit_type($users_ref, $user_type, $user_id)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24users_ref_Structure_that_holds_the_records_by_type'>$users_ref Structure that holds the records by type</a>
        <li class='indexItem indexItem4'><a href='#%24user_type_e.g._editors%2C_photographers%2C_weighers'>$user_type e.g. editors, photographers, weighers</a>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_url_(_%24code_or_ref_)'>product_url ( $code_or_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_code_or_reference_to_product_object_%24code_or_ref'>Product code or reference to product object $code_or_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#product_action_url_(_%24code%2C_%24action_)'>product_action_url ( $code, $action )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Parameters'>Parameters</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_code_or_reference_to_product_object_%24code_or_ref'>Product code or reference to product object $code_or_ref</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#process_product_edit_rules_(%24product_ref)'>process_product_edit_rules ($product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#where_it_applies'>where it applies</a>
      <li class='indexItem indexItem3'><a href='#edit_rules_structure'>edit_rules structure</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#conditions'>conditions</a>
        <li class='indexItem indexItem4'><a href='#actions'>actions</a>
        <li class='indexItem indexItem4'><a href='#notifications'>notifications</a>
        <li class='indexItem indexItem4'><a href='#Example_of_an_edit_rule'>Example of an edit rule</a>
      </ul>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#POD_ERRORS'>POD ERRORS</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::Products - create and save products</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::Products</code> is used to create products and save them in Product Opener&#39;s database and file system.</p>

<pre>    use ProductOpener::Products qw/:all/;

        my $product_ref = init_product($User_id, $Org_id, $code, $countryid);

        $product_ref-&#62;{product_name_en} = &#34;Chocolate cookies&#34;;

        store_product(&#34;my-user&#34;, $product_ref, &#39;helpful comment&#39;);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Revisions"
>Revisions</a></h2>

<p>When a product is saved, a new revision of the product is created. All revisions are saved in the file system:</p>

<p>products/[barcode path]/1.sto - first revision products/[barcode path]/2.sto - 2nd revision ... products/[barcode path]/product.sto - link to latest revision</p>

<p>The latest revision is stored in the products collection of the MongoDB database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Completeness,_data_quality_and_edit_history"
>Completeness, data quality and edit history</a></h2>

<p>Before a product is saved, this module compute the completeness and quality of the data, and the edit history.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="make_sure_numbers_are_stored_as_numbers_(_PRODUCT_REF_)"
>make_sure_numbers_are_stored_as_numbers ( PRODUCT_REF )</a></h2>

<p><code>make_sure_numbers_are_stored_as_numbers()</code> forces numbers contained in the product data to be stored as numbers (and not strings) in MongoDB.</p>

<p>Perl scalars are not typed, the internal type depends on the last operator used on the variable... e.g. if it is printed with a string concatenation, then it&#39;s converted to a string.</p>

<p>See https://metacpan.org/pod/JSON%3a%3aXS#PERL---JSON</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="assign_new_code_(_)"
>assign_new_code ( )</a></h2>

<p><code>assign_new_code()</code> assigns a new unused code to store a new product that does not have a barcode.</p>

<pre>        my ($code, $product_id) = assign_new_code();</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>A list with the new code and the corresponding product_id.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Caveats"
>Caveats</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Invalid_codes"
>Invalid codes</a></h4>

<p>This function currently assign new codes in sequence starting from 2000000000001. We increment the number by 1 for each product (which means codes are not valid as the last digit is supposed to be the check digit), and check if there is already a product for that number.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code_conflicts"
>Code conflicts</a></h4>

<p>Codes starting with 2 are reserved for internal uses, there may be conflicts as other companies can use the same codes.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="normalize_code()"
>normalize_code()</a></h2>

<p><code>normalize_code()</code> this function normalizes the product code by: - Keeps only digits and removes spaces/dashes etc. - Normalizes the length by adding leading zeroes or removing the leading zero (in case of 14 digit codes)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code in the Raw form: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Normalized version of the code</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="split_code()"
>split_code()</a></h2>

<p><code>split_code()</code> this function splits the product code for determining the product path and the _id. product_path_from_id() utilizes this for the said purpose.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<p>Product Code: $code</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Values"
>Return Values</a></h3>

<p>Code that has been split into 3 sections of three digits and one fourth section with the remaining digits. Example: 1234567890123 :- 123/456/789/0123</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_id_for_owner_(_OWNER_ID,_CODE_)"
>product_id_for_owner ( OWNER_ID, CODE )</a></h2>

<p><code>product_id_for_owner()</code> returns the product id associated with a product barcode.</p>

<p>If the products on the server are public, the product id is equal to the product code.</p>

<p>If the products on the server are private (e.g. on the platform for producers), the product_id is of the form user-[user id]/[code] or org-[organization id]/code.</p>

<p>The product id can be prefixed by a server id to indicate that is is on another server (e.g. Open Food Facts, Open Beauty Facts, Open Products Facts or Open Pet Food Facts) e.g. off:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Owner_id"
>Owner id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Code"
>Code</a></h4>

<p>Product barcode</p>

<p>In most cases, pass $Owner_id which is initialized by ProductOpener::Users::init_user()</p>

<pre>  undef for public products
  user-[user id] or org-[organization id] for private products</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The product id.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="server_for_product_id_(_$product_id_)"
>server_for_product_id ( $product_id )</a></h2>

<p>Returns the server for the product, if it is not on the current server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code] or [server-id]:[owner-id]/[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>undef is the product is on the current server, or server id of the server of the product otherwise.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="data_root_for_product_id_(_$product_id_)"
>data_root_for_product_id ( $product_id )</a></h2>

<p>Returns the data root for the product, possibly on another server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The data root for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="www_root_for_product_id_(_$product_id_)"
>www_root_for_product_id ( $product_id )</a></h2>

<p>Returns the www root for the product, possibly on another server.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The www root for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_from_id_(_$product_id_)"
>product_path_from_id ( $product_id )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_id"
>$product_id</a></h4>

<p>Product id of the form [code], [owner-id]/[code], or [server-id]:[code]</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_path_(_$product_ref_)"
>product_path ( $product_ref )</a></h2>

<p>Returns the relative path for the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Product object reference.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The relative path for the product.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_id_from_path_(_$product_path_)"
>product_id_from_path ( $product_path )</a></h2>

<p>Reverse of product_path_from_id.</p>

<p>There is no guarantee the result will be correct... but it&#39;s way faster than loading the sto !</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_product_(_$userid,_$orgid,_$code,_$countryid_)"
>init_product ( $userid, $orgid, $code, $countryid )</a></h2>

<p>Initializes and return a $product_ref structure for a new product. If $countryid is defined and is not &#34;en:world&#34;, then assign this country for the countries field. Otherwise, use the country associated with the ip address of the user.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_Type"
>Return Type</a></h3>

<p>Returns a $product_ref structure</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="send_notification_for_product_change_(_$user_id,_$product_ref,_$action,_$comment,_$diffs_)"
>send_notification_for_product_change ( $user_id, $product_ref, $action, $comment, $diffs )</a></h2>

<p>Notify Robotoff when products are updated or deleted.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<p>ID of the user that triggered the update/deletion (String, may be undefined)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$product_ref"
>$product_ref</a></h4>

<p>Reference to the updated/deleted product.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$action"
>$action</a></h4>

<p>The action performed, either `deleted` or `updated` (String).</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$comment"
>$comment</a></h4>

<p>The update comment (String)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$diffs"
>$diffs</a></h4>

<p>The `diffs` of the update (Hash)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_sort_keys_(_$product_ref_)"
>compute_sort_keys ( $product_ref )</a></h2>

<p>Compute sort keys that are stored in the MongoDB database and used to order results of queries.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="last_modified_t_-_date_of_last_modification_of_the_product_page"
>last_modified_t - date of last modification of the product page</a></h3>

<p>Used on the web site for facets pages, except the index page.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="popularity_key_-_Popular_and_recent_products"
>popularity_key - Popular and recent products</a></h3>

<p>Used for the Personal Search project to provide generic search results that apps can personalize later.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="store_product_($user_id,_$product_ref,_$comment)"
>store_product ($user_id, $product_ref, $comment)</a></h2>

<p>Save changes of a product: - in a new .sto file on the disk - in MongoDB (in the products collection, or products_obsolete collection if the product is obsolete)</p>

<p>Before saving, some field values are computed, and product history and completeness is computed.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_data_sources_(_$product_ref,_$changes_ref_)"
>compute_data_sources ( $product_ref, $changes_ref )</a></h2>

<p>Analyze the sources field of the product, as well as the changes to add to the data_sources field.</p>

<p>Sources allows to add some producers imports that were done before the producers platform was created.</p>

<p>The changes structure allows to add apps.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_change_userid_or_uuid_(_$change_ref_)"
>get_change_userid_or_uuid ( $change_ref )</a></h2>

<p>For a specific change, analyze change identifiers (comment, user agent, userid etc.) to determine if the change was done through an app, the OFF userid, or an app specific UUID</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$change_ref_reference_to_a_change_record"
>$change_ref reference to a change record</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_value"
>Return value</a></h3>

<p>The function returns by order of preference: - a real user userid if we have an userid which is not the userid of an app - an appid + app uuid (e.g. some-app.Z626FZF4RTFSG6) - an app userid if the app did not provide an app uuid - openfoodfacts-contributors</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="replace_user_id_in_product_(_$product_id,_$user_id,_$new_user_id_)"
>replace_user_id_in_product ( $product_id, $user_id, $new_user_id )</a></h2>

<p>For a specific product, replace a specific user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_id"
>Product id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_and_replace_user_id_in_products_(_$user_id,_$new_user_id_)"
>find_and_replace_user_id_in_products ( $user_id, $new_user_id )</a></h2>

<p>Find all products changed by a specific user_id, and replace the user_id associated with changes (edits, new photos etc.) by another user_id.</p>

<p>This can be used when we want to rename a user_id, or when an user asks its data to be deleted: we can rename it to a generic user account like openfoodfacts-contributors.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="User_id"
>User id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="New_user_id"
>New user id</a></h3>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="record_user_edit_type($users_ref,_$user_type,_$user_id)"
>record_user_edit_type($users_ref, $user_type, $user_id)</a></h2>

<p>Record that a user has made a change of a specific type to the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$users_ref_Structure_that_holds_the_records_by_type"
>$users_ref Structure that holds the records by type</a></h4>

<p>For each type, there is a &#34;list&#34; array, and a &#34;seen&#34; hash</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_type_e.g._editors,_photographers,_weighers"
>$user_type e.g. editors, photographers, weighers</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_url_(_$code_or_ref_)"
>product_url ( $code_or_ref )</a></h2>

<p>Returns a relative URL for a product on the website.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_code_or_reference_to_product_object_$code_or_ref"
>Product code or reference to product object $code_or_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="product_action_url_(_$code,_$action_)"
>product_action_url ( $code, $action )</a></h2>

<p>Returns a relative URL for an action on a product on the website.</p>

<p>This function is called by the web/panels/panel.tt.html template for knowledge panels that have associated actions.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Parameters"
>Parameters</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_code_or_reference_to_product_object_$code_or_ref"
>Product code or reference to product object $code_or_ref</a></h4>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_product_edit_rules_($product_ref)"
>process_product_edit_rules ($product_ref)</a></h2>

<p>Process the edit_rules (see <code>@edit_rules</code> in in Config file).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="where_it_applies"
>where it applies</a></h3>

<p>It applies in all API/form that edit the product. It applies to apply an image crop.</p>

<p>It does not block image upload.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="edit_rules_structure"
>edit_rules structure</a></h3>

<blockquote></blockquote>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="conditions"
>conditions</a></h4>

<p>Each condition is either a match on <code>user_id</code> or it&#39;s contrary <code>user_id_not</code>, or <code>in_TAG_NAME_tags</code> for a tag field to match a specific tag id.</p>

<p>Note that conditions are checked before editing the product !</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="actions"
>actions</a></h4>

<p><code>ignore</code> alone, ignore every edits.</p>

<p>You can also have rules of the form <code>ignore_FIELD</code> and <code>warn_FIELD</code> which will ignore (or notify) edits on the specific field.</p>

<p>Note that ignore rules also create a notification.</p>

<p>For nutriments use <code>nutriments_NUTRIMENT_NAME</code> for <code>FIELD</code>.</p>

<p>You can guard the rule on the field with a condition: <code>ignore_if_CONDITION_FIELD</code> or <code>warn_if_CONDITION_FIELD</code> This time it&#39;s to check the value the user want&#39;s to add.</p>

<p><code>CONDITION</code> is one of the following: =over 1 =item * existing - user tries to edit this field with a non empty value =item * 0 - user tries to put numerical value 0 in the field =item * equal / lesser / greater - comparison of numeric value (requires a value as argument) =item * match - comparison to a string (equality, requires a value as argument) =item * regexp_match - match against a regexp (requires a regexp value as argument) =back</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="notifications"
>notifications</a></h4>

<p>Notifications are email addresses to send emails, or &#34;slack_CHANNEL_NAME&#34; (<b>warning</b> currently channel name is ignored, we post to <i>edit-alerts</i>)</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Example_of_an_edit_rule"
>Example of an edit rule</a></h4>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="POD_ERRORS"
>POD ERRORS</a></h1>

<p>Hey! <b>The above document had some coding errors, which are explained below:</b></p>

<dl>
<dt><a name="Around_line_2886:"
>Around line 2886:</a></dt>

<dd>
<p>=over should be: &#39;=over&#39; or &#39;=over positive_number&#39;</p>

<dt><a name="Around_line_2893:"
>Around line 2893:</a></dt>

<dd>
<p>You forgot a &#39;=back&#39; before &#39;=head4&#39;</p>
</dd>
</dl>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
