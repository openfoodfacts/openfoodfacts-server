<html><head><title>ProductOpener::CRM</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Thu Jan 30 16:27:22 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#find_or_create_contact_(%24user_ref)'>find_or_create_contact ($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_ref'>$user_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#link_user_with_contact_(%24org_ref%2C_%24contact_id_%3D_undef)'>link_user_with_contact ($org_ref, $contact_id = undef)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_ref'>$user_ref</a>
        <li class='indexItem indexItem4'><a href='#%24contact_id'>$contact_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#find_contact_(%24user_ref)'>find_contact ($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_ref'>$user_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#create_contact_(%24user_ref)'>create_contact ($user_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#_get_country_(%24tag)'>_get_country ($tag)</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#find_or_create_company_(%24org_ref%2C_%24contact_id_%3D_undef)'>find_or_create_company ($org_ref, $contact_id = undef)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
        <li class='indexItem indexItem4'><a href='#%24contact_id'>$contact_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#link_org_with_company_(%24org_ref%2C_%24company_id)'>link_org_with_company ($org_ref, $company_id)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
        <li class='indexItem indexItem4'><a href='#%24company_id'>$company_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#find_company_(%24name)'>find_company ($name)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_ref'>$user_ref</a>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#create_company_(%24org_ref)'>create_company ($org_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_contact_to_company_(%24org_ref)'>add_contact_to_company ($org_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24contact_id'>$contact_id</a>
        <li class='indexItem indexItem4'><a href='#%24company_id'>$company_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#create_onboarding_opportunity_(%24name%2C_%24company_id%2C_%24partner_id%2C_salesperson_email_%3D_undef)'>create_onboarding_opportunity ($name, $company_id, $partner_id, salesperson_email = undef)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24name'>$name</a>
        <li class='indexItem indexItem4'><a href='#%24partner_id'>$partner_id</a>
        <li class='indexItem indexItem4'><a href='#%24salesperson_email'>$salesperson_email</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_user_to_company_(%24user_id%2C_%24company_id)'>add_user_to_company ($user_id, $company_id)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
        <li class='indexItem indexItem4'><a href='#%24company_id'>$company_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#change_company_main_contact_(%24org_ref%2C_%24user_id)'>change_company_main_contact ($org_ref, $user_id)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
        <li class='indexItem indexItem4'><a href='#%24user_id'>$user_id</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#add_category_to_partner_(%24contact_or_org_ref%2C_%24label)'>add_category_to_partner ($contact_or_org_ref, $label)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_id'>$org_id</a>
        <li class='indexItem indexItem4'><a href='#%24label'>$label</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#update_company_last_import_type_(%24org_id%2C_%24data_source)'>update_company_last_import_type ($org_id, $data_source)</a>
    <ul   class='indexList indexList3'>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24data_source'>$data_source</a>
      </ul>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_company_url_(%24org_ref)'>get_company_url ($org_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#%24org_ref'>$org_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#make_odoo_request_(%40params)'>make_odoo_request (@params)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#init_crm_data()'>init_crm_data()</a>
    <ul   class='indexList indexList3'>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#die_if_CRM_data_cannot_be_loaded'>die if CRM data cannot be loaded</a>
      </ul>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::CRM - manages integration with the Odoo CRM</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::CRM</code> contains functions to interact with the Odoo CRM</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>For clarity: - user/org refers to the pro platform side - contact/company refers to the CRM side,
where: contact =&#62; Odoo partner is an &#39;individual&#39; company =&#62; Odoo partner is a &#39;company&#39;</p>

<pre>        - tags =&#62; crm.tag
        - category =&#62; res.partner.category</pre>

<p>Requirements before enabling CRM sync: - check required_tag_labels and required_category_labels</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_or_create_contact_($user_ref)"
>find_or_create_contact ($user_ref)</a></h2>

<p>Attempts to find a contact, and if it doesn&#39;t exist, creates it</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_ref"
>$user_ref</a></h4>

<p>the user to which a &#39;contact&#39; in the CRM should be linked</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the id of the contact, or undef if an error occur</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="link_user_with_contact_($org_ref,_$contact_id_=_undef)"
>link_user_with_contact ($org_ref, $contact_id = undef)</a></h2>

<p>Set the off_username field of a contact to the user_id</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_ref"
>$user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$contact_id"
>$contact_id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1 if success, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_contact_($user_ref)"
>find_contact ($user_ref)</a></h2>

<p>Finds a contact that has the user_id or same email as the given user_ref</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_ref"
>$user_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the contact id or undef</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_contact_($user_ref)"
>create_contact ($user_ref)</a></h2>

<p>Creates a new contact in Odoo from a user</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the id of the created contact</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="_get_country_($tag)"
>_get_country ($tag)</a></h1>

<p>Get the country id from Odoo given a country tag (en:france, en:germany, ...)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_or_create_company_($org_ref,_$contact_id_=_undef)"
>find_or_create_company ($org_ref, $contact_id = undef)</a></h2>

<p>Attempts to find a company, and if it doesn&#39;t exist, creates it</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<p>the organization to which a &#39;company&#39; in the CRM should be linked</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$contact_id"
>$contact_id</a></h4>

<p>Helps the strategy to find the company</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The id of the contact, or undef if an error occurred</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="link_org_with_company_($org_ref,_$company_id)"
>link_org_with_company ($org_ref, $company_id)</a></h2>

<p>Set the off_org field of a contact to the org_id</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$company_id"
>$company_id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1 if success, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_company_($name)"
>find_company ($name)</a></h2>

<p>Finds the oldest company following this strategy:</p>

<p>1. if the company has the corresponding off_org_id, use this one 2. if the contact_id is defined and the company he belongs to has no off_org_id, use this one 3. if there is a company with the exact same name, use this one</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_ref"
>$user_ref</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the company if found, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_company_($org_ref)"
>create_company ($org_ref)</a></h2>

<p>Creates a new company in Odoo from an org</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the id of the created company</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_contact_to_company_($org_ref)"
>add_contact_to_company ($org_ref)</a></h2>

<p>Add a contact to a company in Odoo</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$contact_id"
>$contact_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$company_id"
>$company_id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1 if success, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_onboarding_opportunity_($name,_$company_id,_$partner_id,_salesperson_email_=_undef)"
>create_onboarding_opportunity ($name, $company_id, $partner_id, salesperson_email = undef)</a></h2>

<p>create an opportunity attached to a</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$name"
>$name</a></h4>

<p>The name of the opportunity</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$partner_id"
>$partner_id</a></h4>

<p>The id of the partner to attach the opportunity to. It can be a contact or a company</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$salesperson_email"
>$salesperson_email</a></h4>

<p>The email of the salesperson to attach to the opportunity</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the id of the created opportunity</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_user_to_company_($user_id,_$company_id)"
>add_user_to_company ($user_id, $company_id)</a></h2>

<p>Add a user to a company in Odoo. Attempts to find the contact, create it if it doesn&#39;t exist, and add it to the company.</p>

<p>side effect: update user_ref with the corresponding CRM contact_id</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$company_id"
>$company_id</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the contact_id, undef if an error occurred while getting the contact_id</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="change_company_main_contact_($org_ref,_$user_id)"
>change_company_main_contact ($org_ref, $user_id)</a></h2>

<p>Change the main contact of a company Will also update the main contact of the opportunity associated with the org.</p>

<p>If the user is not linked to a contact in the CRM, it will try to find or create it.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<p>The given organization must have a crm_org_id</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$user_id"
>$user_id</a></h4>

<p>id of a member of the organization</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1 if success, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="add_category_to_partner_($contact_or_org_ref,_$label)"
>add_category_to_partner ($contact_or_org_ref, $label)</a></h2>

<p>Add a category to a partner (contact or company) in Odoo</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_id"
>$org_id</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$label"
>$label</a></h4>

<p><code>$label</code> must match one of the values in <code>@required_category_labels</code></p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>1 if success, undef otherwise</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="update_company_last_import_type_($org_id,_$data_source)"
>update_company_last_import_type ($org_id, $data_source)</a></h2>

<p>Update the last import type of a company in Odoo</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$data_source"
>$data_source</a></h4>

<p>must match one of the values in CRM.pm @data_source</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_company_url_($org_ref)"
>get_company_url ($org_ref)</a></h2>

<p>Returns the URL of the company in the CRM</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="$org_ref"
>$org_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the URL of the company in the CRM or undef if the company is not linked to the CRM</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="make_odoo_request_(@params)"
>make_odoo_request (@params)</a></h2>

<p>Calls Odoo&#39;s API with the given parameters</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>the response or undef if an error occurred</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="init_crm_data()"
>init_crm_data()</a></h2>

<p>Initialize the CRM data from Odoo. It is called by lib/startup_apache.pl startup script</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="die_if_CRM_data_cannot_be_loaded"
>die if CRM data cannot be loaded</a></h4>

<p>Die if CRM environment variables are set but required data can&#39;t be fetched from CRM nor be loaded from cache</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
