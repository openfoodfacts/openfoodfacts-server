<html><head><title>ProductOpener::EnvironmentalScore</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="simple.min" type="text/css" href="../simple.min.css" media="all" >

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Wed Aug 27 14:54:32 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#VARIABLES'>VARIABLES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#%25environmental_score_countries_enabled'>%environmental_score_countries_enabled</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#load_agribalyse_data()'>load_agribalyse_data()</a>
    <li class='indexItem indexItem2'><a href='#load_environmental_score_data_origins_of_ingredients_distances_(_%24product_ref_)'>load_environmental_score_data_origins_of_ingredients_distances ( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#load_environmental_score_data_origins_of_ingredients(_%24product_ref_)'>load_environmental_score_data_origins_of_ingredients( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#load_environmental_score_data_packaging(_%24product_ref_)'>load_environmental_score_data_packaging( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#load_environmental_score_data(_%24product_ref_)'>load_environmental_score_data( $product_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score(_%24product_ref_)'>compute_environmental_score( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score_agribalyse_(_%24product_ref_)'>compute_environmental_score_agribalyse ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score_production_system_adjustment_(_%24product_ref_)'>compute_environmental_score_production_system_adjustment ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
      <li class='indexItem indexItem3'><a href='#Notes'>Notes</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score_threatened_species_adjustment_(_%24product_ref_)'>compute_environmental_score_threatened_species_adjustment ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#aggregate_origins_of_ingredients_(_%24default_origins_ref%2C_%24aggregated_origins_ref%2C_%24ingredient_ref_)'>aggregate_origins_of_ingredients ( $default_origins_ref, $aggregated_origins_ref, $ingredient_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Default_origins_reference%3A_%24default_origins_ref'>Default origins reference: $default_origins_ref</a>
        <li class='indexItem indexItem4'><a href='#Aggregated_origins_reference_%24aggregated_origins_ref'>Aggregated origins reference $aggregated_origins_ref</a>
        <li class='indexItem indexItem4'><a href='#Ingredient_reference_%24ingredient_ref'>Ingredient reference $ingredient_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#get_country_origin_from_origins_(_%24origins_ref_)'>get_country_origin_from_origins ( $origins_ref )</a>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score_origins_of_ingredients_adjustment_(_%24product_ref_)'>compute_environmental_score_origins_of_ingredients_adjustment ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#compute_environmental_score_packaging_adjustment_(_%24product_ref_)'>compute_environmental_score_packaging_adjustment ( $product_ref )</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#localize_environmental_score_(_%24cc%2C_%24product_ref)'>localize_environmental_score ( $cc, $product_ref)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Arguments'>Arguments</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Country_code_of_the_request_%24cc'>Country code of the request $cc</a>
        <li class='indexItem indexItem4'><a href='#Product_reference_%24product_ref'>Product reference $product_ref</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Return_values'>Return values</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>ProductOpener::EnvironmentalScore - compute the EnvironmentalScore environmental grade of a food product</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p><code>ProductOpener::EnvironmentalScore</code> is used to compute the EnvironmentalScore environmental grade of a food product.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The modules implements the Environmental-Score computation as defined by a collective that Open Food Facts is part of.</p>

<p>It is based on the French AgriBalyse V3 database that contains environmental impact values for 2500 food product categories.</p>

<p>AgriBalyse provides Life Cycle Analysis (LCA) values for food products categories,
and some adjustments to the score are made for actual specific products using data about labels,
origins of ingredients,
packagings etc.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="VARIABLES"
>VARIABLES</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="%environmental_score_countries_enabled"
>%environmental_score_countries_enabled</a></h2>

<p>List of countries for which we are going to compute and display the Environmental-Score.</p>

<p>The list is different from %environmental_score_countries that can contain more countries for which we have some data to compute the Environmental-Score (e.g.
distances).</p>

<p>2021-10-28: we will now enable Environmental-Score for all available countries,
so this list will be overrode when we load the Environmental-Score data.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_agribalyse_data()"
>load_agribalyse_data()</a></h2>

<p>Loads the AgriBalyse database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_environmental_score_data_origins_of_ingredients_distances_(_$product_ref_)"
>load_environmental_score_data_origins_of_ingredients_distances ( $product_ref )</a></h2>

<p>Loads origins of ingredients distances data needed to compute the Environmental-Score.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_environmental_score_data_origins_of_ingredients(_$product_ref_)"
>load_environmental_score_data_origins_of_ingredients( $product_ref )</a></h2>

<p>Loads origins of ingredients data needed to compute the Environmental-Score.</p>

<p>Data contains: - EPI score for each origin - Original transportation score for France,
as defined in Environmental-Score original specification (distances in distances.csv have been recomputed in a slightly different way,
and the scores for France slightly differ from the original ones)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_environmental_score_data_packaging(_$product_ref_)"
>load_environmental_score_data_packaging( $product_ref )</a></h2>

<p>Loads packaging data needed to compute the Environmental-Score.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_environmental_score_data(_$product_ref_)"
>load_environmental_score_data( $product_ref )</a></h2>

<p>Loads data needed to compute the Environmental-Score.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score(_$product_ref_)"
>compute_environmental_score( $product_ref )</a></h2>

<p><code>compute_environmental_score()</code> computes the Environmental-Score of a food product,
and stores the details of the computation.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The Environmental-Score score and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>- environmental_score_score : numeric Environmental-Score value - environmental_score_grade : corresponding A to E grade - environmental_score_data : Environmental-Score computation details</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score_agribalyse_(_$product_ref_)"
>compute_environmental_score_agribalyse ( $product_ref )</a></h2>

<p><code>compute_environmental_score()</code> computes the Life Cycle Analysis (LCA) part of the Environmental-Score,
based on the French AgriBalyse database.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The LCA score and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>$product_ref-&#62;{agribalyse} hash with: -</p>

<p>$product_ref-&#62;{environmental_score_data}{missing} hash with: - categories if the product does not have a category - agb_category if the product does not have an Agribalyse match or proxy match for at least one of its categories.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score_production_system_adjustment_(_$product_ref_)"
>compute_environmental_score_production_system_adjustment ( $product_ref )</a></h2>

<p>Computes an adjustment (bonus or malus) based on production system of the product (e.g.
organic).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The adjustment value and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>$product_ref-&#62;{adjustments}{production_system} hash with: -</p>

<p>$product_ref-&#62;{environmental_score_data}{missing} hash with:</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Notes"
>Notes</a></h3>

<p>This function tests the presence of specific labels and categories that should not be renamed.
They are listed in the t/environmental_score.t test file so that the test fail if they are renamed.</p>

<p>The labels are listed in the Environmental-Score documentation: https://docs.score-environnemental.com/methodologie/produit/label</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score_threatened_species_adjustment_(_$product_ref_)"
>compute_environmental_score_threatened_species_adjustment ( $product_ref )</a></h2>

<p>Computes an adjustment (malus) if the ingredients are harmful to threatened species.
e.g.
threatened fishes,
or ingredients like palm oil that threaten the habitat of threatened species.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The adjustment value and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>$product_ref-&#62;{adjustments}{threatened_species} hash with: - value: malus (-10 for palm oil) - ingredient: the id of the ingredient responsible for the malus</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="aggregate_origins_of_ingredients_(_$default_origins_ref,_$aggregated_origins_ref,_$ingredient_ref_)"
>aggregate_origins_of_ingredients ( $default_origins_ref,
$aggregated_origins_ref,
$ingredient_ref )</a></h2>

<p>Computes adjustments(bonus or malus for transportation + EPI / Environmental Performance Index) according to the countries of origin of the ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Default_origins_reference:_$default_origins_ref"
>Default origins reference: $default_origins_ref</a></h4>

<p>Array of origins specified in the origins field,
that we will use for ingredients that do not have a specific origin.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Aggregated_origins_reference_$aggregated_origins_ref"
>Aggregated origins reference $aggregated_origins_ref</a></h4>

<p>Data structure to which we will add the percentages for the ingredient specified in $ingredient_ref</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Ingredient_reference_$ingredient_ref"
>Ingredient reference $ingredient_ref</a></h4>

<p>Ingredient reference that may contains an ingredients structure for sub-ingredients.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The percentages are stored in $aggregated_origins_ref</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_country_origin_from_origins_(_$origins_ref_)"
>get_country_origin_from_origins ( $origins_ref )</a></h2>

<p>Given a list of origins,
return the country for the first origin that is a country or a child of a country.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score_origins_of_ingredients_adjustment_(_$product_ref_)"
>compute_environmental_score_origins_of_ingredients_adjustment ( $product_ref )</a></h2>

<p>Computes adjustments(bonus or malus for transportation + EPI / Environmental Performance Index) according to the countries of origin of the ingredients.</p>

<p>The transportation bonus or malus is computed for all the countries where the Environmental-Score is enabled.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The adjustment value and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>$product_ref-&#62;{adjustments}{origins_of_ingredients} hash with: - value_[country code]: combined bonus or malus for transportation + EPI - epi_value - transportation_value_[country code] - aggregated origins: sorted array of origin + percent to show the % of ingredients by country used in the computation</p>

<p>Note: the country EPI is not taken into account if the product already has a bonus for the production system.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="compute_environmental_score_packaging_adjustment_(_$product_ref_)"
>compute_environmental_score_packaging_adjustment ( $product_ref )</a></h2>

<p>Computes adjustments (malus) based on the packaging of the product.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The adjustment value and computations details are stored in the product reference passed as input parameter.</p>

<p>Returned values:</p>

<p>$product_ref-&#62;{adjustments}{packaging} hash with: - value: malus for packaging - packagings: details of the computation</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="localize_environmental_score_(_$cc,_$product_ref)"
>localize_environmental_score ( $cc,
$product_ref)</a></h2>

<p>The Environmental-Score and some of its components depend on the country of the consumer,
as we take transportation to the consumer into account.</p>

<p>We compute the Environmental-Score for all countries,
and this function copies the values for a specific country to the main Environmental-Score fields.</p>

<p>Note: even if we could not compute the Environmental-Score (because of a missing category),
we still localize the origins of ingredients,
so that it can be displayed in separate knowledge panels.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Arguments"
>Arguments</a></h3>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Country_code_of_the_request_$cc"
>Country code of the request $cc</a></h4>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Product_reference_$product_ref"
>Product reference $product_ref</a></h4>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Return_values"
>Return values</a></h3>

<p>The adjustment value and computations details are stored in the product reference passed as input parameter.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
