version: "3.7"
services:
  backend:
    image: openfoodfacts-server/backend:dev
    build:
      context: .
      dockerfile: Dockerfile
      target: vscode
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    volumes:
      - ./:/opt/product-opener # mount local folder for reload on dev changes
      # we use this for debugging, from times to times
      - ./debug:/mnt/podata/debug/
  # in dev we want to use watch assets and recompile on the fly
  # also we want to build at start time in case some files changed, as we want to avoid recreating volumes
  dynamicfront:
    build:
      context: .
      target: builder
      dockerfile: Dockerfile.frontend
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    command: ["npm", "run", "build:dynamic"]
    volumes:
      # Static dist/ assets (JS, CSS, Icons, Image attributes)
      - icons_dist:/opt/product-opener/html/images/icons/dist
      - js_dist:/opt/product-opener/html/js/dist
      - css_dist:/opt/product-opener/html/css/dist
      # mount local folder for reload on dev changes, we follow Dockerfile.frontend COPYs
      - ./package.json:/opt/product-opener/package.json
      - ./package-lock.json:/opt/product-opener/package-lock.json
      - ./html:/opt/product-opener/html
      - ./icons:/opt/product-opener/icons
      - ./scss:/opt/product-opener/scss
      - ./gulpfile.js:/opt/product-opener/gulpfile.js
  frontend:
    image: openfoodfacts-server/frontend:dev
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
  mongodb:
    image: mongo:4.4
    networks:
      - webnet
    ports:
      - 27017:27017
volumes:
  product_images:
  html_data:
  users:
  products:
  orgs:
  podata:
