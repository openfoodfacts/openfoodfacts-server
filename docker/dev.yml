version: "3.7"

x-backend-conf: &backend-conf
  image: openfoodfacts-server/backend:dev
  build:
    context: .
    dockerfile: Dockerfile
    # align user id
    args:
      USER_UID: ${USER_UID:-1000}
      USER_GID: ${USER_GID:-1000}
  volumes:
    # mount local folder for reload on dev changes.
    # Note that this means /opt/product-opener/html/images/product wont be connected to product_images volume
    # Sadly, there is no sane way to do this, while retaining compatibility with prod
    # (which requires images/product to be empty in git)
    - ./:/opt/product-opener
    # we use this for debugging, from times to times
    - ./debug:/mnt/podata/debug/


services:
  backend: *backend-conf
  incron: *backend-conf
  # in dev we want to use watch assets and recompile on the fly
  # also we want to build at start time in case some files changed, as we want to avoid recreating volumes
  dynamicfront:
    build:
      context: .
      target: builder
      dockerfile: Dockerfile.frontend
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    command: ["npm", "run", "build:dynamic"]
    volumes:
      # Static dist/ assets (JS, CSS, Icons, Image attributes)
      - icons_dist:/opt/product-opener/html/images/icons/dist
      - js_dist:/opt/product-opener/html/js/dist
      - css_dist:/opt/product-opener/html/css/dist
      # mount local folder for reload on dev changes, we follow Dockerfile.frontend COPYs
      - ./package.json:/opt/product-opener/package.json
      - ./package-lock.json:/opt/product-opener/package-lock.json
      - ./html:/opt/product-opener/html
      - ./icons:/opt/product-opener/icons
      - ./scss:/opt/product-opener/scss
      - ./gulpfile.js:/opt/product-opener/gulpfile.js
  frontend:
    image: openfoodfacts-server/frontend:dev
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    volumes:
      - ./html:/opt/product-opener/html/
  mongodb:
    image: mongo:4.4
    command: mongod --wiredTigerCacheSizeGB ${MONGODB_CACHE_SIZE}
    environment:
      - MONGO_INITDB_ROOT_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD
    networks:
      - webnet
    ports:
      - 27017:27017
volumes:
  product_images:
  html_data:
  users:
  products:
  orgs:
  podata:
