var URL_ROOT_API="https://tuttifrutti.alwaysdata.net/",ENDPOINT_STORES="/fetchStores/",ENDPOINT_SCORE_DBS="/fetchScoreDbs",ID_TABLE_STATS="#stats_table",ID_FILE_TIMESTAMP="#file_timestamp",FLD_IS_ERROR="isInError",FLD_DB_DISPLAY_NAME="dbDisplayName",FLD_DB_NAME="dbName",FLD_DB_NICK_NAME="dbNickname",FLD_IS_ACTIVE="isActive",FLD_SIMILARITY_MIN_PERCENTAGE="similarityMinPercentage",FLD_DB_SUMMARY="dbSummary",FLD_DB_DESCRIPTION_EN="dbDescriptionEn",FLD_DB_DESCRIPTION="dbDescription",FLD_DB_MAX_SIZE="dbMaxSize",FLD_OWNER="owner",FLD_EMAIL_OWNER="emailOwner",FLD_LINK_CI="linkComputingInstance",FLD_LINK_STATS_PROSIM="statsProsim",FLD_DB_SIZE_GB="dbSize",FLD_NB_PRODUCTS_EXTRACTED="nbProductsExtracted",FLD_NB_PRODUCTS="nbProducts",FLD_NB_INTERSECTIONS="nbIntersections",FLD_PROGRESSION="progression",MAX_STORES_TO_SHOW_PER_COUNTRY=100,MIN_SCORE_FOR_SUGGESTIONS=70,MAX_SUGGESTIONS=50,MSG_WAITING_SCR_FETCH_STORES=".. fetching stores ..",MSG_WAITING_SCR_MATCH_REQUEST=".. please wait ..",URL_PARAM_BARCODE="barcode",URL_PARAM_COUNTRY="country",URL_PARAM_SCORE="score",GRAPH_WIDTH=75*$(window).innerWidth()/100,GRAPH_HEIGHT=40*$(window).innerHeight()/100,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT=!1,PRODUCT_CODE_DEFAULT="0059749894456",OFF_BACKGROUND_COLOR="#09f",ID_CELL_BANNER="#banner",ID_SERVER_LOG="#echoResultLog",ID_SERVER_ACTIVITY="#server_activity",ID_PRODUCT_CODE="#prod_ref_code",ID_PRODUCT_NAME="#prod_ref_name",ID_INPUT_PRODUCT_CODE="#input_product_code",ID_INPUT_COUNTRY="#input_country",ID_INPUT_STORE="#input_store",ID_INPUT_SCORE_DB="#input_score_db",ID_PRODUCT_IMG="#prod_ref_image",ID_PRODUCT_CATEGORIES="#prod_ref_categories",ID_PRODUCT_OFF="#url_off_prod",ID_PRODUCT_JSON="#url_off_json_prod",ID_GRAPH="#graph",ID_WARNING="#msg_warning_prod_ref",ID_IMG_OFF="#img_off_prod",ID_IMG_JSON="#img_off_json",ID_PRODUCTS_SUGGESTION="#products_suggestion",ID_MENU_SELECTION="#menu_selection",ID_BTN_SUBMIT="#submitBtn",ID_PRODUCT_IMAGE_PARTIAL="prod_img_",ID_NB_SUGGESTIONS="#nb_suggestions",ID_DETAILS_SELECTED_PRODUCT="#selected_product_details",MSG_NO_NUTRIMENTS_PROD_REF="Beware: no nutriments are known for this product.. check in OFF for details!",MSG_NO_DATA_RETRIEVED="NO MATCH FOUND!",SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS=3,CIRCLE_COLOR_DEFAULT="steelblue",CIRCLE_COLOR_SELECTED="red",CIRCLE_RADIUS_DEFAULT=5,CIRCLE_RADIUS_SELECTED=15,FILE_COUNTRIES="/static/data/countries.json",COUNTRY_PROPERTY_EN_LABEL="en_label",COUNTRY_PROPERTY_EN_NAME="en_name",COUNTRY_PROPERTY_EN_CODE="en_code",STORE_NAME_PROPERTY="name",STORE_ID_PROPERTY="id",STORE_PRODUCTS_COUNT_PROPERTY="products",LOCALSTORAGE_COUNTRIES="countries",LOCALSTORAGE_STORES_PARTIAL="stores_for_country_",LOCAL_STORAGE_SCORE_DATABASES="score_databases",LOCAL_STORAGE_CURRENT_DATABASE="current_score_database_used",URL_OFF_DEFAULT_COUNTRY="world";function block_screen(e){$("#screenBlock").empty(),$("#screenBlock").append("<p>"+e+"</p>"),$("#screenBlock").css({opacity:0,width:$(document).width(),height:$(document).height()}),$("#screenBlock").addClass("blockDiv"),$("#screenBlock").show(),$("#screenBlock").animate({opacity:.85},100)}function unblock_screen(){$("#screenBlock").animate({opacity:0},100,function(){$("#screenBlock").hide()})}function fetch_countries(){var e=getCachedCountries();null!=e&&fillHtmlElementWithCountries(e)}function getCachedCountries(){var e=LOCALSTORAGE_COUNTRIES,t=JSON.parse(window.localStorage.getItem(e));if(null!=t)return t;var r=void 0;return $.ajax({url:URL_ROOT_API+FILE_COUNTRIES,dataType:"json",async:!1,success:function(e){stats_json=e,(r=$.map(stats_json,function(e,t){return e[COUNTRY_PROPERTY_EN_LABEL]=t,e[COUNTRY_PROPERTY_EN_NAME]=e.name.en,e.hasOwnProperty("country_code_2")?e[COUNTRY_PROPERTY_EN_CODE]=e.country_code_2.en.toUpperCase():e.hasOwnProperty("country_code_3")?e[COUNTRY_PROPERTY_EN_CODE]=e.country_code_3.en.toUpperCase():e[COUNTRY_PROPERTY_EN_CODE]="",[e]})).sort(function_sort_countries),cacheCountries(r)}}),r}function cacheCountries(e){var t=LOCALSTORAGE_COUNTRIES;window.localStorage.setItem(t,JSON.stringify(e))}function set_user_country(e){en_country_name=e.value,""==en_country_name?user_country=void 0:(user_country=[]).push(find_country_object(en_country_name))}function find_country_object(e){countries=getCachedCountries(),index_of_found=-1;for(var t=0;t<countries.length&&index_of_found<0;t++)countries[t].en_label==e&&(index_of_found=t);return index_of_found<0?void 0:countries[index_of_found]}function fetch_stores(e){var t=getCachedStoresForCountry(e.value);null!=t&&fillHtmlElementWithStores(t)}function getCachedStoresForCountry(e){var t=LOCALSTORAGE_STORES_PARTIAL+e;if(stores_for_country=JSON.parse(window.localStorage.getItem(t)),null!=stores_for_country)return stores_for_country;block_screen(MSG_WAITING_SCR_FETCH_STORES),$.ajax({type:"GET",url:URL_ROOT_API+ENDPOINT_STORES,contentType:"application/json; charset=utf-8",data:{country:e},success:function(t){null!=t&&(t.tags.sort(function_sort_stores_by_nb_products),stores_most_relevant=t.tags.filter(function(e,t){return t<MAX_STORES_TO_SHOW_PER_COUNTRY}),stores_most_relevant.sort(function_sort_stores_by_name),cacheStoresForCountry(e,stores_most_relevant),fillHtmlElementWithStores(stores_most_relevant)),unblock_screen()}})}function cacheStoresForCountry(e,t){var r=LOCALSTORAGE_STORES_PARTIAL+e;window.localStorage.setItem(r,JSON.stringify(t))}function urlReplaceWorldWithSelectedCountry(e){return new_url_off=e,country_code=void 0,null!=user_country&&(country_code=user_country[0].en_code),null!=country_code&&(new_url_off=e.replace("//"+URL_OFF_DEFAULT_COUNTRY.toLowerCase()+".","//"+country_code.toLowerCase().trim()+".")),new_url_off}function_sort_countries=getSortMethod("+"+COUNTRY_PROPERTY_EN_NAME);var function_sort_stores_by_nb_products=getSortMethod("-"+STORE_PRODUCTS_COUNT_PROPERTY),function_sort_stores_by_name=getSortMethod("+"+STORE_NAME_PROPERTY),function_sort_products_bottomUp=getSortMethod("-score","-score_proximity"),function_sort_products_upToBottom=getSortMethod("+score","-score_proximity"),function_sort_min_abscisse=getSortMethod("+x");function getSortMethod(){var e=Array.prototype.slice.call(arguments);return function(t,r){for(var _ in e){var o,n,c;if(tmp_ax=t[e[_].substring(1)],"number"==typeof tmp_ax?(o=Number(tmp_ax),n=Number(r[e[_].substring(1)])):(o=Number(tmp_ax),n=Number(r[e[_].substring(1)]),(isNaN(o)||isNaN(n))&&(o=tmp_ax,n=r[e[_].substring(1)])),"-"==e[_].substring(0,1)&&(c=o,o=n,n=c),o!=n)return o<n?-1:1}}}function filter_suggestions(e,t,r){return t.filter(function(t){return 1==r.bottomUp?(e.score==r.scoreMaxValue?t.score>=e.score:t.score>e.score)&&t.score_proximity>=MIN_SCORE_FOR_SUGGESTIONS:(e.score==r.scoreMinValue?t.score<=e.score:t.score<e.score)&&t.score_proximity>=MIN_SCORE_FOR_SUGGESTIONS})}function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}function clearCache(){msg="Deleting cached DATA will enforce an update with the freshest data from the server.\n\n",msg+="Note: if you need to reload APP files from the server due to a misbehaviour of the App, then please delete the cache of your Browser instead.\n",msg+="\n\n",msg+="DATA LOCAL STORAGE (persistent)\n",msg+="\tNumber of items in the LOCAL-cache: "+window.localStorage.length+"\n\n";for(var e=0;e<window.localStorage.length;e++)msg+="\t-> "+window.localStorage.key(e)+"\n";msg+="\n",msg+="DATA SESSION STORAGE (current browsing)\n",msg+="\tNumber of items in the SESSION-cache: "+window.sessionStorage.length+"\n\n";for(e=0;e<window.sessionStorage.length;e++)msg+="\t-> "+window.sessionStorage.key(e)+"\n";msg+="\n",msg+="\nDo you want to delete all DATA-caches and get the freshest data from the server?\n\n",resp=confirm(msg),resp&&(window.localStorage.clear(),window.sessionStorage.clear(),window.location=URL_ROOT_API)}function fetch_score_databases(){var e=getCachedScoreDatabases();null!=e&&(url_score_db=getParameterByName(URL_PARAM_SCORE,window.location.href),null!=url_score_db&&""!=url_score_db&&(param_db_for_graph=e.stats.filter(function(e){return e[FLD_DB_NICK_NAME].toLowerCase()==url_score_db.toLowerCase()}),null!=param_db_for_graph&&(current_db_for_graph=param_db_for_graph[0])),null==current_db_for_graph&&(current_db_for_graph=getCachedCurrentDatabase()),null==current_db_for_graph&&(current_db_for_graph=e.stats[0]),cacheCurrentScoreDatabase(current_db_for_graph),fillHtmlElementWithDatabases(e.stats))}function getCachedScoreDatabases(){var e=LOCAL_STORAGE_SCORE_DATABASES,t=JSON.parse(window.localStorage.getItem(e));if(null!=t)return t;var r=void 0;return $.ajax({type:"GET",url:URL_ROOT_API+ENDPOINT_SCORE_DBS,async:!1,contentType:"application/json; charset=utf-8",success:function(e){cacheScoreDatabases(r=filterDatabases(e))}}),r}function getCachedCurrentDatabase(){var e=LOCAL_STORAGE_CURRENT_DATABASE;return current_db=JSON.parse(window.localStorage.getItem(e)),current_db}function filterDatabases(e){return dbs_to_show=e.stats.filter(function(e){if(window.location.href.search("/test")>=0||1==e.isActive)return e}),e.stats=dbs_to_show,e}function cacheScoreDatabases(e){var t=LOCAL_STORAGE_SCORE_DATABASES;window.localStorage.setItem(t,JSON.stringify(e))}function cacheCurrentScoreDatabase(e){var t=LOCAL_STORAGE_CURRENT_DATABASE;window.localStorage.setItem(t,JSON.stringify(e))}function changeScoreDb(e){cacheCurrentScoreDatabase(current_db_for_graph=getCachedScoreDatabases().stats[e.selectedIndex])}var suggested_products=[],client_current_selection=[-1,void 0];function cleanup_suggestions(){$(ID_PRODUCTS_SUGGESTION).empty(),$(ID_NB_SUGGESTIONS).empty(),$(ID_NB_SUGGESTIONS).append(0),$(ID_PRODUCTS_SUGGESTION).attr("height",6+$(window).innerHeight()/3+"px"),$(ID_PRODUCTS_SUGGESTION).append("<ul></ul>"),$(ID_MENU_SELECTION).attr("height",$(window).innerHeight()/5+"px")}function get_graph_stripe_colour(e,t){return indx_colour_stripe=void 0,1==e.bottomUp?indx_colour_stripe=e.scoreIntervalsStripeColour.length-1-(e.scoreMaxValue-t):indx_colour_stripe=t-e.scoreMinValue,e.scoreIntervalsStripeColour[indx_colour_stripe]}function make_suggestions(e,t,r){client_current_selection=[-1,void 0],cleanup_suggestions(),t.length>0&&(t=filter_suggestions(e,t,r),1==r.bottomUp?t.sort(function_sort_products_bottomUp):t.sort(function_sort_products_upToBottom),suggested_products=t.slice(0,MAX_SUGGESTIONS),$(ID_NB_SUGGESTIONS).empty(),$(ID_NB_SUGGESTIONS).append(suggested_products.length),suggested_products.forEach(function(e,t){style_for_border_colour="border-color: "+get_graph_stripe_colour(r,e.score),$(ID_PRODUCTS_SUGGESTION+" > ul").append("<li><img id='"+ID_PRODUCT_IMAGE_PARTIAL+t+"' src='"+e.img+"' class='grade_border' style='"+style_for_border_colour+"' height='250px' onclick='process_selected_suggestion(this, "+t+")' /></li>")}))}function process_selected_suggestion(e,t){deactivate_previous_selection(),client_current_selection[0]=t,client_current_selection[1]=e,activate_selection()}function deactivate_previous_selection(){client_current_selection[0]>-1&&(rangeInterval=current_db_for_graph.scoreMaxValue-current_db_for_graph.scoreMinValue+1,style_for_border_colour="border-color: "+get_graph_stripe_colour(current_db_for_graph,suggested_products[client_current_selection[0]].score),client_current_selection[1].setAttribute("style",style_for_border_colour),circle_node=$("#svg_graph")[0].childNodes[0].childNodes[suggested_products[client_current_selection[0]].num_circle+SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS+rangeInterval],circle_node.setAttribute("r",""+CIRCLE_RADIUS_DEFAULT),circle_node.setAttribute("fill",CIRCLE_COLOR_DEFAULT))}function activate_selection(){rangeInterval=current_db_for_graph.scoreMaxValue-current_db_for_graph.scoreMinValue+1,client_current_selection[1].setAttribute("class","product_selected"),client_current_selection[1].setAttribute("style",""),circle_node=$("#svg_graph")[0].childNodes[0].childNodes[suggested_products[client_current_selection[0]].num_circle+SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS+rangeInterval],circle_node.setAttribute("r",""+CIRCLE_RADIUS_SELECTED),circle_node.setAttribute("fill",CIRCLE_COLOR_SELECTED),$(ID_INPUT_PRODUCT_CODE).val(suggested_products[client_current_selection[0]].code)}function select_picture(e){suggested_products.length>0&&(curr_pos=client_current_selection[0],curr_pos<0?curr_pos=0:(curr_pos+=e,curr_pos<0&&(curr_pos=0),curr_pos>suggested_products.length-1&&(curr_pos=suggested_products.length-1)),deactivate_previous_selection(),client_current_selection[0]=curr_pos,next_image=$("#"+ID_PRODUCT_IMAGE_PARTIAL+curr_pos)[0],client_current_selection[1]=next_image,activate_selection())}function show_details(){curr_prod=suggested_products[client_current_selection[0]],style_for_border_colour="border-color: "+get_graph_stripe_colour(current_db_for_graph,curr_prod.score),$(ID_DETAILS_SELECTED_PRODUCT).empty(),curr_prod.url=urlReplaceWorldWithSelectedCountry(curr_prod.url),$(ID_DETAILS_SELECTED_PRODUCT).append("<table class='table_sel_prod'><tr><td class='sel_prod_img'><div><a href='"+curr_prod.url+"' target='_blank'><img src='"+curr_prod.img+"' class='grade_border' style='"+style_for_border_colour+"' /></a></div></td><td class='sel_prod_header'><div class='sel_prod_code'>"+curr_prod.code+"</div><br /><div class='sel_prod_brands'>"+curr_prod.brands+"</div><br /><div class='sel_prod_name'>"+curr_prod.name+"</div><div class='sel_prod_similarity'>[Similarity: "+curr_prod.score_proximity+"%]</div></td></tr></table>"),$(ID_DETAILS_SELECTED_PRODUCT).append(curr_prod.categories),$(ID_DETAILS_SELECTED_PRODUCT).append("<div class='close_details_sel_prod' onclick='hide_details()'>close</div>"),$(ID_DETAILS_SELECTED_PRODUCT).css({opacity:0,width:$(document).width(),height:$(document).height()}),$(ID_DETAILS_SELECTED_PRODUCT).addClass("detailsProduct"),$(ID_DETAILS_SELECTED_PRODUCT).show(),$(ID_DETAILS_SELECTED_PRODUCT).animate({opacity:.95},100)}function hide_details(){$(ID_DETAILS_SELECTED_PRODUCT).empty(),$(ID_DETAILS_SELECTED_PRODUCT).animate({opacity:0},100,function(){$(ID_DETAILS_SELECTED_PRODUCT).hide()})}function go_search(){curr_prod=client_current_selection[0],curr_prod>=0&&(code_product=suggested_products[curr_prod].code,$(ID_INPUT_PRODUCT_CODE).val(code_product),$(ID_INPUT_PRODUCT_CODE).css("background-color",OFF_BACKGROUND_COLOR),$(ID_BTN_SUBMIT).click())}function draw_graph(e,t,r,_,o,n){var c=30,s=30,a=60,i=50,u=GRAPH_WIDTH-i-s-4*GRAPH_WIDTH/100,l=GRAPH_HEIGHT-c-a,d=d3.scale.linear().range([0,u]),p=d3.scale.linear().range([l,0]),E=null==r.categories_tags||0==r.categories_tags.length?8:r.categories_tags.length,T=Math.ceil(E/2),R=t.scoreNbIntervals,O=1-T/E,D=O,I=d3.svg.axis().scale(d).orient("bottom").ticks(T).tickFormat(function(e){return e==O?"low":1==e?"high":""}),S=[...Array(T+1).keys()],g=[];S.forEach(function(e){e>0&&g.push(e/T)});var C=d3.svg.axis().scale(d).orient("top").ticks(T).tickValues(g).innerTickSize([l]).outerTickSize([l]),f=d3.svg.axis().scale(p).orient("left").ticks(R).tickFormat(function(e){return e>=t.scoreMinValue&&e<=t.scoreMaxValue?1==t.bottomUp?t.scoreIntervalsLabels[e-1]:t.scoreIntervalsLabels[t.scoreNbIntervals-e]:""}),N=d3.select("body").append("div").attr("class","tooltip").style("opacity",0).style("display","none"),A=d3.select("body").append("svg").attr("id","svg_graph").attr("width",u+i+s).attr("height",l+c+a).append("g").attr("transform","translate("+i+","+c+")");A.append("g").attr("class","x axis").attr("transform","translate(0,"+l+c+a+")").call(C),d.domain([O,1]),p.domain([0,R]);for(var U=[],m=t.scoreMaxValue-t.scoreMinValue+1,P=m/t.scoreNbIntervals,L=0,y=t.scoreMinValue;y<=t.scoreMaxValue;y+=P)numTick=y-t.scoreMinValue+P,U.push({v:y,color:t.scoreIntervalsStripeColour[L]}),L++;A.selectAll("rect").data(U).enter().append("rect").attr("width",u).attr("height",l/t.scoreNbIntervals).attr("y",function(e){return 1==t.bottomUp?(m-e.v)*l/m:(e.v-P)*l/m}).attr("fill",function(e){return e.color});var b=[{score:1}];0!=r.length&&(b=[{score:r.score}]),A.selectAll("ellipse").data(b).enter().append("ellipse").attr("cx",u*(1-1/T/2)).attr("cy",function(e){return 1==t.bottomUp?l*(1-e.score/R)+l/R*.5:l*((e.score-1)/R)+l/R*.5}).attr("rx",u/T*.5).attr("ry",l/R*.5).attr("fill","#ffffff").attr("fill-opacity",.75);var v=filter_suggestions(b[0],_,t);v.sort(function_sort_min_abscisse);var G=void 0;G=1==t.bottomUp?[{width:0==v.length?1/T:(1-v[0].x)*(E/T),height:b[0].score==t.scoreMaxValue?1:m-(b[0].score-(t.scoreMinValue-1))}]:[{width:0==v.length?1/T:(1-v[0].x)*(E/T),height:b[0].score==t.scoreMinValue?1:b[0].score-1}],A.selectAll("polyline").data(G).enter().append("polyline").style("stroke","black").style("fill","none").attr("points",function(e){return w=u*e.width+CIRCLE_RADIUS_SELECTED,h=e.height*(l/m),rect_points=u+",0, "+u+","+h+", "+(u-w)+","+h+", "+(u-w)+",0, "+u+",0",rect_points});var M=_;A.selectAll("circle").data(M).enter().append("circle").attr("r",CIRCLE_RADIUS_DEFAULT).attr("stroke","#000080").attr("stroke-width",1).attr("fill",CIRCLE_COLOR_DEFAULT).attr("cx",function(e,t){return e.num_circle=t,(e.x-D)*E/T*u}).attr("cy",function(e){return 1==t.bottomUp?l*(1-e.y/R):l*(e.y/R)}).on("mouseover",function(e){N.transition().duration(200).style("opacity",.85),N.html(e.content).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){N.transition().duration(500).style("opacity",0)}).on("click",function(e){$(o).val(e.code),$(o).css("background-color",OFF_BACKGROUND_COLOR),n&&window.open(e.url,"_blank")}),A.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(I),A.append("text").attr("x",.5*u).attr("y",l+30).attr("dy","1em").style("text-anchor","middle").style("font-size","inherit").text("Similarity with product reference"),A.append("g").attr("class","y axis").call(f),A.append("text").attr("transform","rotate(-90)").attr("x",-.5*l).attr("y",-45).attr("dy","1em").style("text-anchor","middle").style("font-size","inherit").text(t.scoreLabelYAxis),$(e).empty(),$("svg").detach().appendTo(e)}function display_product_ref_details(e,t,r,_,o,n,c,s,a){current_product=e,code=e.code,name=e.name,image=e.images,""==image&&(image=e.image_fake_off),no_nutriments=e.no_nutriments,categories=e.categories_tags.join("<br />"),url_off=e.url_product,country_code=void 0,null!=user_country&&(country_code=user_country[0].en_code),null!=country_code&&(url_off=url_off.replace("//"+URL_OFF_DEFAULT_COUNTRY.toLowerCase()+".","//"+country_code.toLowerCase().trim()+".")),url_json=e.url_json,style_for_border_colour="grade_"+e.score,$(t).empty(),$(t).append(code),$(r).empty(),$(r).append(code),$(_).empty(),$(_).append(name),$(o).attr("src",image),$(o).attr("height",$(window).innerHeight()/7+"px"),$(o).attr("class",style_for_border_colour),$(ID_IMG_OFF).attr("height",$(window).innerHeight()/7/3+"px"),$(ID_IMG_OFF).attr("max-height","28px"),$(ID_IMG_JSON).attr("height",$(window).innerHeight()/7/3+"px"),$(ID_IMG_JSON).attr("max-height","28px"),$(n).empty(),$(n).append(categories),$(c).attr("href",url_off),$(s).attr("href",url_json),$(a).empty(),no_nutriments&&$(a).append(MSG_NO_NUTRIMENTS_PROD_REF)}function draw_page(e,t){display_product_ref_details(e,ID_PRODUCT_CODE,ID_INPUT_PRODUCT_CODE,ID_PRODUCT_NAME,ID_PRODUCT_IMG,ID_PRODUCT_CATEGORIES,ID_PRODUCT_OFF,ID_PRODUCT_JSON,ID_WARNING),draw_graph(ID_GRAPH,current_db_for_graph,e,t,ID_INPUT_PRODUCT_CODE,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT),make_suggestions(e,t,current_db_for_graph)}var nav_language=window.navigator.userLanguage||window.navigator.language,user_country=void 0,current_product=void 0,current_db_for_graph=void 0;function init(){fetch_score_databases(),fetch_countries(),current_db_used=getCachedCurrentDatabase(),null!=current_db_used&&(current_db_for_graph=current_db_used,$(ID_INPUT_SCORE_DB).val(current_db_used[FLD_DB_NICK_NAME])),$(ID_CELL_BANNER).css("background-color",OFF_BACKGROUND_COLOR),$(ID_SERVER_ACTIVITY).css("visibility","hidden"),draw_graph(ID_GRAPH,current_db_for_graph,[],[],ID_INPUT_PRODUCT_CODE,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT),cleanup_suggestions(),$(function(){$("#submitBtn").click(go_fetch)}),url_barcode=getParameterByName(URL_PARAM_BARCODE,window.location.href),null!=url_barcode?($(ID_INPUT_PRODUCT_CODE).val(url_barcode),go_fetch()):$(ID_INPUT_PRODUCT_CODE).val(PRODUCT_CODE_DEFAULT)}function guess_country_from_nav_lang(){if(is_found=!1,data_countries=getCachedCountries(),url_country=getParameterByName(URL_PARAM_COUNTRY,window.location.href),null!=url_country&&""!=url_country?(nav_country=url_country,user_country=data_countries.filter(function(e){return e[COUNTRY_PROPERTY_EN_LABEL].toLowerCase()==nav_country.toLowerCase()})):(nav_country=(nav_language.indexOf("-")>=0?nav_language.split("-")[1]:nav_language).toUpperCase(),user_country=data_countries.filter(function(e){return e[COUNTRY_PROPERTY_EN_CODE]==nav_country})),null!=user_country){for(var e in $(ID_INPUT_COUNTRY)[0])if(current_option=$(ID_INPUT_COUNTRY)[0][e],current_option.value===user_country[0][COUNTRY_PROPERTY_EN_LABEL]){is_found=!0,current_option.selected=!0;break}is_found&&fetch_stores($(ID_INPUT_COUNTRY)[0][e])}}function fillHtmlElementWithCountries(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[COUNTRY_PROPERTY_EN_LABEL]).text(e[COUNTRY_PROPERTY_EN_NAME])});$(ID_INPUT_COUNTRY).empty(),$(ID_INPUT_COUNTRY).append($("<option></option>").val("").text("")),$(ID_INPUT_COUNTRY).append(t),guess_country_from_nav_lang()}}function fillHtmlElementWithStores(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[STORE_ID_PROPERTY]).text(e[STORE_NAME_PROPERTY])});$(ID_INPUT_STORE).empty(),$(ID_INPUT_STORE).append($("<option></option>").val("").text("")),$(ID_INPUT_STORE).append(t)}else $(ID_INPUT_STORE).empty(),$(ID_INPUT_STORE).append($("<option></option>").val("").text(""))}function fillHtmlElementWithDatabases(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[FLD_DB_NICK_NAME]).text(e[FLD_DB_DISPLAY_NAME])});$(ID_INPUT_SCORE_DB).empty(),$(ID_INPUT_SCORE_DB).append(t)}else $(ID_INPUT_SCORE_DB).empty(),$(ID_INPUT_SCORE_DB).append($("<option></option>").val("").text(""))}function go_fetch(){$(ID_INPUT_PRODUCT_CODE).css("background-color","white"),$(ID_WARNING).empty(),block_screen(MSG_WAITING_SCR_MATCH_REQUEST),$.ajax({type:"GET",url:URL_ROOT_API+"/fetchPGraph/",contentType:"application/json; charset=utf-8",data:{barcode:$(ID_INPUT_PRODUCT_CODE).val(),country:$(ID_INPUT_COUNTRY+" option:selected")[0].value,store:$(ID_INPUT_STORE+" option:selected")[0].value,score:$(ID_INPUT_SCORE_DB+" option:selected")[0].value},success:function(e){unblock_screen();try{draw_page(e.graph[0],e.graph[1])}catch(e){$(ID_WARNING).empty(),$(ID_WARNING).append(MSG_NO_DATA_RETRIEVED)}}})}
