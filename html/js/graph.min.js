var URL_ROOT_API="https://tuttifrutti.alwaysdata.net/",ENDPOINT_STORES="/fetchStores/",ENDPOINT_SCORE_DBS="/fetchScoreDbs",ID_TABLE_STATS="#stats_table",ID_FILE_TIMESTAMP="#file_timestamp",FLD_IS_ERROR="isInError",FLD_DB_DISPLAY_NAME="dbDisplayName",FLD_DB_NAME="dbName",FLD_DB_NICK_NAME="dbNickname",FLD_IS_ACTIVE="isActive",FLD_SIMILARITY_MIN_PERCENTAGE="similarityMinPercentage",FLD_DB_SUMMARY="dbSummary",FLD_DB_DESCRIPTION_EN="dbDescriptionEn",FLD_DB_DESCRIPTION="dbDescription",FLD_DB_MAX_SIZE="dbMaxSize",FLD_OWNER="owner",FLD_EMAIL_OWNER="emailOwner",FLD_LINK_CI="linkComputingInstance",FLD_LINK_STATS_PROSIM="statsProsim",FLD_DB_SIZE_GB="dbSize",FLD_NB_PRODUCTS_EXTRACTED="nbProductsExtracted",FLD_NB_PRODUCTS="nbProducts",FLD_NB_INTERSECTIONS="nbIntersections",FLD_PROGRESSION="progression",MAX_STORES_TO_SHOW_PER_COUNTRY=100,MIN_SCORE_FOR_SUGGESTIONS=70,MAX_SUGGESTIONS=50,MSG_WAITING_SCR_FETCH_STORES=".. fetching stores ..",MSG_WAITING_SCR_MATCH_REQUEST=".. please wait ..",URL_PARAM_BARCODE="barcode",URL_PARAM_COUNTRY="country",URL_PARAM_SCORE="score",GRAPH_WIDTH=75*$(window).innerWidth()/100,GRAPH_HEIGHT=40*$(window).innerHeight()/100,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT=!1,PRODUCT_CODE_DEFAULT="3960145823988",ID_CELL_BANNER="#banner",ID_SERVER_LOG="#echoResultLog",ID_SERVER_ACTIVITY="#server_activity",ID_PRODUCT_CODE="#prod_ref_code",ID_PRODUCT_NAME="#prod_ref_name",ID_INPUT_PRODUCT_CODE="#input_product_code",ID_INPUT_COUNTRY="#input_country",ID_INPUT_STORE="#input_store",ID_INPUT_SCORE_DB="#input_score_db",ID_PRODUCT_IMG="#prod_ref_image",ID_PRODUCT_CATEGORIES="#prod_ref_categories",ID_PRODUCT_OFF="#url_off_prod",ID_PRODUCT_JSON="#url_off_json_prod",ID_GRAPH="#graph",ID_WARNING="#msg_warning_prod_ref",ID_IMG_OFF="#img_off_prod",ID_IMG_JSON="#img_off_json",ID_PRODUCTS_SUGGESTION="#products_suggestion",ID_MENU_SELECTION="#menu_selection",ID_BTN_SUBMIT="#submitBtn",ID_PRODUCT_IMAGE_PARTIAL="prod_img_",ID_NB_SUGGESTIONS="#nb_suggestions",ID_DETAILS_SELECTED_PRODUCT="#selected_product_details",MSG_NO_NUTRIMENTS_PROD_REF="Beware: no nutriments are known for this product.. check in OFF for details!",MSG_NO_DATA_RETRIEVED="NO MATCH FOUND!",SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS=3,CIRCLE_COLOR_DEFAULT="steelblue",CIRCLE_COLOR_SELECTED="red",CIRCLE_RADIUS_DEFAULT=5,CIRCLE_RADIUS_SELECTED=15,FILE_COUNTRIES="/static/data/countries.json",COUNTRY_PROPERTY_EN_LABEL="en_label",COUNTRY_PROPERTY_EN_NAME="en_name",COUNTRY_PROPERTY_EN_CODE="en_code",STORE_NAME_PROPERTY="name",STORE_ID_PROPERTY="id",STORE_PRODUCTS_COUNT_PROPERTY="products",LOCALSTORAGE_COUNTRIES="countries",LOCALSTORAGE_STORES_PARTIAL="stores_for_country_",LOCAL_STORAGE_SCORE_DATABASES="score_databases",LOCAL_STORAGE_CURRENT_DATABASE="current_score_database_used",URL_OFF_DEFAULT_COUNTRY="world";function block_screen(e){$("#screenBlock").empty(),$("#screenBlock").append("<p>"+e+"</p>"),$("#screenBlock").css({opacity:0,width:$(document).width(),height:$(document).height()}),$("#screenBlock").addClass("blockDiv"),$("#screenBlock").show(),$("#screenBlock").animate({opacity:.85},100)}function unblock_screen(){$("#screenBlock").animate({opacity:0},100,function(){$("#screenBlock").hide()})}function fetch_countries(){var e=getCachedCountries();null!=e&&fillHtmlElementWithCountries(e)}function getCachedCountries(){var e=LOCALSTORAGE_COUNTRIES,t=JSON.parse(window.localStorage.getItem(e));if(null!=t)return t;var r=void 0;return $.ajax({url:URL_ROOT_API+FILE_COUNTRIES,dataType:"json",async:!1,success:function(e){let t=e;(r=$.map(t,function(e,t){return e[COUNTRY_PROPERTY_EN_LABEL]=t,e[COUNTRY_PROPERTY_EN_NAME]=e.name.en,e.hasOwnProperty("country_code_2")?e[COUNTRY_PROPERTY_EN_CODE]=e.country_code_2.en.toUpperCase():e.hasOwnProperty("country_code_3")?e[COUNTRY_PROPERTY_EN_CODE]=e.country_code_3.en.toUpperCase():e[COUNTRY_PROPERTY_EN_CODE]="",[e]})).sort(function_sort_countries),cacheCountries(r)}}),r}function cacheCountries(e){var t=LOCALSTORAGE_COUNTRIES;window.localStorage.setItem(t,JSON.stringify(e))}function set_user_country(e){let t=e.value;""==t?user_country=void 0:(user_country=[]).push(find_country_object(t))}function find_country_object(e){let t=getCachedCountries();index_of_found=-1;for(var r=0;r<t.length&&index_of_found<0;r++)if(t[r].en_label==e){}return index_of_found<0?void 0:t[index_of_found]}function fetch_stores(e){var t=getCachedStoresForCountry(e.value);null!=t&&fillHtmlElementWithStores(t)}function getCachedStoresForCountry(e){var t=LOCALSTORAGE_STORES_PARTIAL+e;let r=JSON.parse(window.localStorage.getItem(t));if(null!=r)return r;block_screen(MSG_WAITING_SCR_FETCH_STORES),$.ajax({type:"GET",url:URL_ROOT_API+ENDPOINT_STORES,contentType:"application/json; charset=utf-8",data:{country:e},success:function(t){if(null!=t){t.tags.sort(function_sort_stores_by_nb_products);let r=t.tags.filter(function(e,t){return t<MAX_STORES_TO_SHOW_PER_COUNTRY});r.sort(function_sort_stores_by_name),cacheStoresForCountry(e,r),fillHtmlElementWithStores(r)}unblock_screen()}})}function cacheStoresForCountry(e,t){var r=LOCALSTORAGE_STORES_PARTIAL+e;window.localStorage.setItem(r,JSON.stringify(t))}function urlReplaceWorldWithSelectedCountry(e){let t=e,r=void 0;return null!=user_country&&(r=user_country[0].en_code),null!=r&&(t=e.replace("//"+URL_OFF_DEFAULT_COUNTRY.toLowerCase()+".","//"+r.toLowerCase().trim()+".")),t}var function_sort_countries=getSortMethod("+"+COUNTRY_PROPERTY_EN_NAME),function_sort_stores_by_nb_products=getSortMethod("-"+STORE_PRODUCTS_COUNT_PROPERTY),function_sort_stores_by_name=getSortMethod("+"+STORE_NAME_PROPERTY),function_sort_products_bottomUp=getSortMethod("-score","-score_proximity"),function_sort_products_upToBottom=getSortMethod("+score","-score_proximity"),function_sort_min_abscisse=getSortMethod("+x");function getSortMethod(){var e=Array.prototype.slice.call(arguments);return function(t,r){for(var _ in e){var o,n,a;let s=t[e[_].substring(1)];if("number"==typeof s?(o=Number(s),n=Number(r[e[_].substring(1)])):(o=Number(s),n=Number(r[e[_].substring(1)]),(isNaN(o)||isNaN(n))&&(o=s,n=r[e[_].substring(1)])),"-"==e[_].substring(0,1)&&(a=o,o=n,n=a),o!=n)return o<n?-1:1}}}function filter_suggestions(e,t,r){return t.filter(function(t){return 1==r.bottomUp?(e.score==r.scoreMaxValue?t.score>=e.score:t.score>e.score)&&t.score_proximity>=MIN_SCORE_FOR_SUGGESTIONS:(e.score==r.scoreMinValue?t.score<=e.score:t.score<e.score)&&t.score_proximity>=MIN_SCORE_FOR_SUGGESTIONS})}function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}function clearCache(){let e="Deleting cached DATA will enforce an update with the freshest data from the server.\n\n";e+="Note: if you need to reload APP files from the server due to a misbehaviour of the App, then please delete the cache of your Browser instead.\n",e+="\n\n",e+="DATA LOCAL STORAGE (persistent)\n",e+="\tNumber of items in the LOCAL-cache: "+window.localStorage.length+"\n\n";for(let t=0;t<window.localStorage.length;t++)e+="\t-> "+window.localStorage.key(t)+"\n";e+="\n",e+="DATA SESSION STORAGE (current browsing)\n",e+="\tNumber of items in the SESSION-cache: "+window.sessionStorage.length+"\n\n";for(var t=0;t<window.sessionStorage.length;t++)e+="\t-> "+window.sessionStorage.key(t)+"\n";e+="\n",e+="\nDo you want to delete all DATA-caches and get the freshest data from the server?\n\n",confirm(e)&&(window.localStorage.clear(),window.sessionStorage.clear(),window.location=URL_ROOT_API)}function fetch_score_databases(){var e=getCachedScoreDatabases();if(null!=e){let t=getParameterByName(URL_PARAM_SCORE,window.location.href);if(null!=t&&""!=t){let r=e.stats.filter(function(e){return e[FLD_DB_NICK_NAME].toLowerCase()==t.toLowerCase()});null!=r&&(current_db_for_graph=r[0])}null==current_db_for_graph&&(current_db_for_graph=getCachedCurrentDatabase()),null==current_db_for_graph&&(current_db_for_graph=e.stats[0]),cacheCurrentScoreDatabase(current_db_for_graph),fillHtmlElementWithDatabases(e.stats)}}function getCachedScoreDatabases(){var e=LOCAL_STORAGE_SCORE_DATABASES,t=JSON.parse(window.localStorage.getItem(e));if(null!=t)return t;var r=void 0;return $.ajax({type:"GET",url:URL_ROOT_API+ENDPOINT_SCORE_DBS,async:!1,contentType:"application/json; charset=utf-8",success:function(e){cacheScoreDatabases(r=filterDatabases(e))}}),r}function getCachedCurrentDatabase(){var e=LOCAL_STORAGE_CURRENT_DATABASE;return JSON.parse(window.localStorage.getItem(e))}function filterDatabases(e){let t=e.stats.filter(function(e){if(window.location.href.search("/test")>=0||1==e.isActive)return e});return e.stats=t,e}function cacheScoreDatabases(e){var t=LOCAL_STORAGE_SCORE_DATABASES;window.localStorage.setItem(t,JSON.stringify(e))}function cacheCurrentScoreDatabase(e){var t=LOCAL_STORAGE_CURRENT_DATABASE;window.localStorage.setItem(t,JSON.stringify(e))}function changeScoreDb(e){cacheCurrentScoreDatabase(current_db_for_graph=getCachedScoreDatabases().stats[e.selectedIndex])}var suggested_products=[],client_current_selection=[-1,void 0];function cleanup_suggestions(){$(ID_PRODUCTS_SUGGESTION).empty(),$(ID_NB_SUGGESTIONS).empty(),$(ID_NB_SUGGESTIONS).append(0),$(ID_PRODUCTS_SUGGESTION).attr("height",6+$(window).innerHeight()/3+"px"),$(ID_PRODUCTS_SUGGESTION).append("<ul></ul>"),$(ID_MENU_SELECTION).attr("height",$(window).innerHeight()/5+"px")}function get_graph_stripe_colour(e,t){let r=void 0;return r=1==e.bottomUp?e.scoreIntervalsStripeColour.length-1-(e.scoreMaxValue-t):t-e.scoreMinValue,e.scoreIntervalsStripeColour[r]}function make_suggestions(e,t,r){client_current_selection=[-1,void 0],cleanup_suggestions(),t.length>0&&(t=filter_suggestions(e,t,r),1==r.bottomUp?t.sort(function_sort_products_bottomUp):t.sort(function_sort_products_upToBottom),suggested_products=t.slice(0,MAX_SUGGESTIONS),$(ID_NB_SUGGESTIONS).empty(),$(ID_NB_SUGGESTIONS).append(suggested_products.length),suggested_products.forEach(function(e,t){let _="border-color: "+get_graph_stripe_colour(r,e.score);$(ID_PRODUCTS_SUGGESTION+" > ul").append("<li><img id='"+ID_PRODUCT_IMAGE_PARTIAL+t+"' src='"+e.img+"' class='grade_border' style='"+_+"' height='250px' onclick='process_selected_suggestion(this, "+t+")' /></li>")}))}function process_selected_suggestion(e,t){deactivate_previous_selection(),client_current_selection[0]=t,client_current_selection[1]=e,activate_selection()}function deactivate_previous_selection(){if(client_current_selection[0]>-1){let e=current_db_for_graph.scoreMaxValue-current_db_for_graph.scoreMinValue+1;style_for_border_colour="border-color: "+get_graph_stripe_colour(current_db_for_graph,suggested_products[client_current_selection[0]].score),client_current_selection[1].setAttribute("style",style_for_border_colour);let t=$("#svg_graph")[0].childNodes[0].childNodes[suggested_products[client_current_selection[0]].num_circle+SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS+e];t.setAttribute("r",""+CIRCLE_RADIUS_DEFAULT),t.setAttribute("fill",CIRCLE_COLOR_DEFAULT)}}function activate_selection(){rangeInterval=current_db_for_graph.scoreMaxValue-current_db_for_graph.scoreMinValue+1,client_current_selection[1].setAttribute("class","product_selected"),client_current_selection[1].setAttribute("style",""),circle_node=$("#svg_graph")[0].childNodes[0].childNodes[suggested_products[client_current_selection[0]].num_circle+SHIFT_ARRAY_POSITION_SVG_CIRCLES_VS_PRODUCTS+rangeInterval],circle_node.setAttribute("r",""+CIRCLE_RADIUS_SELECTED),circle_node.setAttribute("fill",CIRCLE_COLOR_SELECTED),$(ID_INPUT_PRODUCT_CODE).val(suggested_products[client_current_selection[0]].code)}function select_picture(e){if(suggested_products.length>0){let t=client_current_selection[0];t<0?t=0:((t+=e)<0&&(t=0),t>suggested_products.length-1&&(t=suggested_products.length-1)),deactivate_previous_selection(),client_current_selection[0]=t;let r=$("#"+ID_PRODUCT_IMAGE_PARTIAL+t)[0];client_current_selection[1]=r,activate_selection()}}function show_details(){let e=suggested_products[client_current_selection[0]];style_for_border_colour="border-color: "+get_graph_stripe_colour(current_db_for_graph,e.score),$(ID_DETAILS_SELECTED_PRODUCT).empty(),e.url=urlReplaceWorldWithSelectedCountry(e.url),$(ID_DETAILS_SELECTED_PRODUCT).append("<table class='table_sel_prod'><tr><td class='sel_prod_img'><div><a href='"+e.url+"' target='_blank'><img src='"+e.img+"' class='grade_border' style='"+style_for_border_colour+"' /></a></div></td><td class='sel_prod_header'><div class='sel_prod_code'>"+e.code+"</div><br /><div class='sel_prod_brands'>"+e.brands+"</div><br /><div class='sel_prod_name'>"+e.name+"</div><div class='sel_prod_similarity'>[Similarity: "+e.score_proximity+"%]</div></td></tr></table>"),$(ID_DETAILS_SELECTED_PRODUCT).append(e.categories),$(ID_DETAILS_SELECTED_PRODUCT).append("<div class='close_details_sel_prod' onclick='hide_details()'>close</div>"),$(ID_DETAILS_SELECTED_PRODUCT).css({opacity:0,width:$(document).width(),height:$(document).height()}),$(ID_DETAILS_SELECTED_PRODUCT).addClass("detailsProduct"),$(ID_DETAILS_SELECTED_PRODUCT).show(),$(ID_DETAILS_SELECTED_PRODUCT).animate({opacity:.95},100)}function hide_details(){$(ID_DETAILS_SELECTED_PRODUCT).empty(),$(ID_DETAILS_SELECTED_PRODUCT).animate({opacity:0},100,function(){$(ID_DETAILS_SELECTED_PRODUCT).hide()})}function go_search(){if(curr_prod=client_current_selection[0],curr_prod>=0){let e=suggested_products[curr_prod].code;$(ID_INPUT_PRODUCT_CODE).val(e),$(ID_INPUT_PRODUCT_CODE).removeClass("barcode_no_selection"),$(ID_INPUT_PRODUCT_CODE).addClass("barcode_product_selected"),$(ID_BTN_SUBMIT).click()}}function draw_graph(e,t,r,_,o,n){var a=30,s=30,c=60,i=50,l=GRAPH_WIDTH-i-s-4*GRAPH_WIDTH/100,u=GRAPH_HEIGHT-a-c,d=d3.scale.linear().range([0,l]),E=d3.scale.linear().range([u,0]),T=null==r.categories_tags||0==r.categories_tags.length?8:r.categories_tags.length,D=Math.ceil(T/2),R=t.scoreNbIntervals,O=1-D/T,p=O,I=d3.svg.axis().scale(d).orient("bottom").ticks(D).tickFormat(function(e){return e==O?"low":1==e?"high":""}),S=[...Array(D+1).keys()],C=[];S.forEach(function(e){e>0&&C.push(e/D)});var g=d3.svg.axis().scale(d).orient("top").ticks(D).tickValues(C).innerTickSize([u]).outerTickSize([u]),f=d3.svg.axis().scale(E).orient("left").ticks(R).tickFormat(function(e){return e>=t.scoreMinValue&&e<=t.scoreMaxValue?1==t.bottomUp?t.scoreIntervalsLabels[e-1]:t.scoreIntervalsLabels[t.scoreNbIntervals-e]:""}),N=d3.select("body").append("div").attr("class","tooltip").style("opacity",0).style("display","none"),h=d3.select("body").append("svg").attr("id","svg_graph").attr("width",l+i+s).attr("height",u+a+c).append("g").attr("transform","translate("+i+","+a+")");h.append("g").attr("class","x axis").attr("transform","translate(0,"+u+a+c+")").call(g),d.domain([O,1]),E.domain([0,R]);for(var A=[],U=t.scoreMaxValue-t.scoreMinValue+1,P=U/t.scoreNbIntervals,L=0,m=t.scoreMinValue;m<=t.scoreMaxValue;m+=P){t.scoreMinValue;A.push({v:m,color:t.scoreIntervalsStripeColour[L]}),L++}h.selectAll("rect").data(A).enter().append("rect").attr("width",l).attr("height",u/t.scoreNbIntervals).attr("y",function(e){return 1==t.bottomUp?(U-e.v)*u/U:(e.v-P)*u/U}).attr("fill",function(e){return e.color});var b=[{score:1}];0!=r.length&&(b=[{score:r.score}]),h.selectAll("ellipse").data(b).enter().append("ellipse").attr("cx",l*(1-1/D/2)).attr("cy",function(e){return 1==t.bottomUp?u*(1-e.score/R)+u/R*.5:u*((e.score-1)/R)+u/R*.5}).attr("rx",l/D*.5).attr("ry",u/R*.5).attr("fill","#ffffff").attr("fill-opacity",.75);var y=filter_suggestions(b[0],_,t);y.sort(function_sort_min_abscisse);var v=void 0;v=1==t.bottomUp?[{width:0==y.length?1/D:(1-y[0].x)*(T/D),height:b[0].score==t.scoreMaxValue?1:U-(b[0].score-(t.scoreMinValue-1))}]:[{width:0==y.length?1/D:(1-y[0].x)*(T/D),height:b[0].score==t.scoreMinValue?1:b[0].score-1}],h.selectAll("polyline").data(v).enter().append("polyline").style("stroke","black").style("fill","none").attr("points",function(e){let t=l*e.width+CIRCLE_RADIUS_SELECTED,r=e.height*(u/U);return l+",0, "+l+","+r+", "+(l-t)+","+r+", "+(l-t)+",0, "+l+",0"});var w=_;h.selectAll("circle").data(w).enter().append("circle").attr("r",CIRCLE_RADIUS_DEFAULT).attr("stroke","#000080").attr("stroke-width",1).attr("fill",CIRCLE_COLOR_DEFAULT).attr("cx",function(e,t){return e.num_circle=t,(e.x-p)*T/D*l}).attr("cy",function(e){return 1==t.bottomUp?u*(1-e.y/R):u*(e.y/R)}).on("mouseover",function(e){N.transition().duration(200).style("opacity",.85),N.html(e.content).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){N.transition().duration(500).style("opacity",0)}).on("click",function(e){$(o).val(e.code),$(ID_INPUT_PRODUCT_CODE).removeClass("barcode_no_selection"),$(ID_INPUT_PRODUCT_CODE).addClass("barcode_product_selected"),n&&window.open(e.url,"_blank")}),h.append("g").attr("class","x axis").attr("transform","translate(0,"+u+")").call(I),h.append("text").attr("x",.5*l).attr("y",u+30).attr("dy","1em").style("text-anchor","middle").style("font-size","inherit").text("Similarity with product reference"),h.append("g").attr("class","y axis").call(f),h.append("text").attr("transform","rotate(-90)").attr("x",-.5*u).attr("y",-45).attr("dy","1em").style("text-anchor","middle").style("font-size","inherit").text(t.scoreLabelYAxis),$(e).empty(),$("svg").detach().appendTo(e)}function display_product_ref_details(e,t,r,_,o,n,a,s,c){current_product=e;let i=e.code,l=e.name,u=e.images;""==u&&(u=e.image_fake_off);let d=e.no_nutriments,E=e.categories_tags.join("<br />"),T=e.url_product,D=void 0;null!=user_country&&(D=user_country[0].en_code),null!=D&&(T=T.replace("//"+URL_OFF_DEFAULT_COUNTRY.toLowerCase()+".","//"+D.toLowerCase().trim()+"."));let R=e.url_json;style_for_border_colour="grade_"+e.score,$(t).empty(),$(t).append(i),$(r).empty(),$(r).append(i),$(_).empty(),$(_).append(l),$(o).attr("src",u),$(o).attr("height",$(window).innerHeight()/7+"px"),$(o).attr("class",style_for_border_colour),$(ID_IMG_OFF).attr("height",$(window).innerHeight()/7/3+"px"),$(ID_IMG_OFF).attr("max-height","28px"),$(ID_IMG_JSON).attr("height",$(window).innerHeight()/7/3+"px"),$(ID_IMG_JSON).attr("max-height","28px"),$(n).empty(),$(n).append(E),$(a).attr("href",T),$(s).attr("href",R),$(c).empty(),d&&$(c).append(MSG_NO_NUTRIMENTS_PROD_REF)}function draw_page(e,t){display_product_ref_details(e,ID_PRODUCT_CODE,ID_INPUT_PRODUCT_CODE,ID_PRODUCT_NAME,ID_PRODUCT_IMG,ID_PRODUCT_CATEGORIES,ID_PRODUCT_OFF,ID_PRODUCT_JSON,ID_WARNING),draw_graph(ID_GRAPH,current_db_for_graph,e,t,ID_INPUT_PRODUCT_CODE,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT),make_suggestions(e,t,current_db_for_graph)}var nav_language=window.navigator.userLanguage||window.navigator.language,user_country=void 0,current_product=void 0,current_db_for_graph=void 0;function init(){fetch_score_databases(),fetch_countries(),current_db_used=getCachedCurrentDatabase(),null!=current_db_used&&(current_db_for_graph=current_db_used,$(ID_INPUT_SCORE_DB).val(current_db_used[FLD_DB_NICK_NAME])),$(ID_INPUT_PRODUCT_CODE).removeClass("barcode_no_selection"),$(ID_INPUT_PRODUCT_CODE).addClass("barcode_product_selected"),$(ID_SERVER_ACTIVITY).css("visibility","hidden"),draw_graph(ID_GRAPH,current_db_for_graph,[],[],ID_INPUT_PRODUCT_CODE,OPEN_OFF_PAGE_FOR_SELECTED_PRODUCT),cleanup_suggestions(),$(function(){$("#submitBtn").click(go_fetch)}),url_barcode=getParameterByName(URL_PARAM_BARCODE,window.location.href),null!=url_barcode?($(ID_INPUT_PRODUCT_CODE).val(url_barcode),go_fetch()):$(ID_INPUT_PRODUCT_CODE).val(PRODUCT_CODE_DEFAULT)}function guess_country_from_nav_lang(){if(is_found=!1,data_countries=getCachedCountries(),url_country=getParameterByName(URL_PARAM_COUNTRY,window.location.href),null!=url_country&&""!=url_country?(nav_country=url_country,user_country=data_countries.filter(function(e){return e[COUNTRY_PROPERTY_EN_LABEL].toLowerCase()==nav_country.toLowerCase()})):(nav_country=(nav_language.indexOf("-")>=0?nav_language.split("-")[1]:nav_language).toUpperCase(),user_country=data_countries.filter(function(e){return e[COUNTRY_PROPERTY_EN_CODE]==nav_country})),null!=user_country){for(var e in $(ID_INPUT_COUNTRY)[0])if(current_option=$(ID_INPUT_COUNTRY)[0][e],current_option.value===user_country[0][COUNTRY_PROPERTY_EN_LABEL]){is_found=!0,current_option.selected=!0;break}is_found&&fetch_stores($(ID_INPUT_COUNTRY)[0][e])}}function fillHtmlElementWithCountries(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[COUNTRY_PROPERTY_EN_LABEL]).text(e[COUNTRY_PROPERTY_EN_NAME])});$(ID_INPUT_COUNTRY).empty(),$(ID_INPUT_COUNTRY).append($("<option></option>").val("").text("")),$(ID_INPUT_COUNTRY).append(t),guess_country_from_nav_lang()}}function fillHtmlElementWithStores(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[STORE_ID_PROPERTY]).text(e[STORE_NAME_PROPERTY])});$(ID_INPUT_STORE).empty(),$(ID_INPUT_STORE).append($("<option></option>").val("").text("")),$(ID_INPUT_STORE).append(t)}else $(ID_INPUT_STORE).empty(),$(ID_INPUT_STORE).append($("<option></option>").val("").text(""))}function fillHtmlElementWithDatabases(e){if(null!=e){var t=e.map(function(e){return $("<option></option>").val(e[FLD_DB_NICK_NAME]).text(e[FLD_DB_DISPLAY_NAME])});$(ID_INPUT_SCORE_DB).empty(),$(ID_INPUT_SCORE_DB).append(t)}else $(ID_INPUT_SCORE_DB).empty(),$(ID_INPUT_SCORE_DB).append($("<option></option>").val("").text(""))}function go_fetch(){$(ID_INPUT_PRODUCT_CODE).removeClass("barcode_product_selected"),$(ID_INPUT_PRODUCT_CODE).addClass("barcode_no_selection"),$(ID_WARNING).empty(),block_screen(MSG_WAITING_SCR_MATCH_REQUEST),$.ajax({type:"GET",url:URL_ROOT_API+"/fetchPGraph/",contentType:"application/json; charset=utf-8",data:{barcode:$(ID_INPUT_PRODUCT_CODE).val(),country:$(ID_INPUT_COUNTRY+" option:selected")[0].value,store:$(ID_INPUT_STORE+" option:selected")[0].value,score:$(ID_INPUT_SCORE_DB+" option:selected")[0].value},success:function(e){unblock_screen();try{draw_page(e.graph[0],e.graph[1])}catch(e){$(ID_WARNING).empty(),$(ID_WARNING).append(MSG_NO_DATA_RETRIEVED)}}})}
